<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Get data from an etcd backup (encrypted or not!) | Linuxera</title><meta name=keywords content="etcd,kubernetes,etcd,encrypted etcd,backup,restore"><meta name=description content="Get data from an etcd backup (encrypted or not!) The following post aims to provide a step by step procedure to recover data from an etcd snapshot (even if it’s encrypted) from a Kubernetes cluster.
The post targets the following use cases:
We have a non-encrypted etcd snapshot file, and we want to get some data from it. We have an encrypted etcd snapshot file, and we want to get some data from it."><meta name=author content="Mario"><link rel=canonical href=https://linuxera.org/rag-beginners-guide/><link crossorigin=anonymous href=/assets/css/stylesheet.8cc7ef3cdd44c5188f9267864f378d8dd8892d583e0fd07b5e5321e496f1e4d1.css integrity="sha256-jMfvPN1ExRiPkmeGTzeNjdiJLVg+D9B7XlMh5Jbx5NE=" rel="preload stylesheet" as=style><link rel=icon href=https://linuxera.org/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://linuxera.org/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://linuxera.org/favicon-32x32.png><link rel=apple-touch-icon href=https://linuxera.org/apple-touch-icon.png><link rel=mask-icon href=https://linuxera.org/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer data-domain=linuxera.org src=https://stats.linuxera.org/js/script.file-downloads.hash.outbound-links.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script><meta property="og:title" content="Get data from an etcd backup (encrypted or not!)"><meta property="og:description" content="Get data from an etcd backup (encrypted or not!) The following post aims to provide a step by step procedure to recover data from an etcd snapshot (even if it’s encrypted) from a Kubernetes cluster.
The post targets the following use cases:
We have a non-encrypted etcd snapshot file, and we want to get some data from it. We have an encrypted etcd snapshot file, and we want to get some data from it."><meta property="og:type" content="article"><meta property="og:url" content="https://linuxera.org/rag-beginners-guide/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-10-02T00:00:00+00:00"><meta property="article:modified_time" content="2025-10-02T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Get data from an etcd backup (encrypted or not!)"><meta name=twitter:description content="Get data from an etcd backup (encrypted or not!) The following post aims to provide a step by step procedure to recover data from an etcd snapshot (even if it’s encrypted) from a Kubernetes cluster.
The post targets the following use cases:
We have a non-encrypted etcd snapshot file, and we want to get some data from it. We have an encrypted etcd snapshot file, and we want to get some data from it."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://linuxera.org/posts/"},{"@type":"ListItem","position":2,"name":"Get data from an etcd backup (encrypted or not!)","item":"https://linuxera.org/rag-beginners-guide/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Get data from an etcd backup (encrypted or not!)","name":"Get data from an etcd backup (encrypted or not!)","description":"Get data from an etcd backup (encrypted or not!) The following post aims to provide a step by step procedure to recover data from an etcd snapshot (even if it’s encrypted) from a Kubernetes cluster.\nThe post targets the following use cases:\nWe have a non-encrypted etcd snapshot file, and we want to get some data from it. We have an encrypted etcd snapshot file, and we want to get some data from it.","keywords":["etcd","kubernetes","etcd","encrypted etcd","backup","restore"],"articleBody":"Get data from an etcd backup (encrypted or not!) The following post aims to provide a step by step procedure to recover data from an etcd snapshot (even if it’s encrypted) from a Kubernetes cluster.\nThe post targets the following use cases:\nWe have a non-encrypted etcd snapshot file, and we want to get some data from it. We have an encrypted etcd snapshot file, and we want to get some data from it. For non-encrypted etcd snapshots, you can read the data with the etcdctl tool directly. In this post, since I have to cover encrypted as well, I’ll describe how to consume the restored data from a temporary local kube-apiserver.\nPrereqs Download etcd tooling and Kubernetes binaries (you want to use the same versions as the ones used in the cluster where the backup was taken, it may work using different ones thought).\nmkdir -p /var/tmp/etcd-restore-tests/bin cd /var/tmp/etcd-restore-tests curl -LO https://github.com/etcd-io/etcd/releases/download/v3.5.18/etcd-v3.5.18-linux-amd64.tar.gz curl -LO https://dl.k8s.io/v1.31.11/kubernetes-server-linux-amd64.tar.gz tar xvf etcd-v3.5.18-linux-amd64.tar.gz -C ./bin/ etcd-v3.5.18-linux-amd64/etcd etcd-v3.5.18-linux-amd64/etcdutl --transform='s|.*/||' tar xvf kubernetes-server-linux-amd64.tar.gz -C ./bin/ kubernetes/server/bin/kube-apiserver --transform='s|.*/||' Generate the required certificates for the temporary kube-apiserver.\nopenssl req -x509 -newkey rsa:2048 -nodes -keyout ca.key -out ca.crt -subj \"/CN=etcd-ca\" -days 3650 openssl req -newkey rsa:2048 -nodes -keyout apiserver.key -out apiserver.csr -subj \"/CN=127.0.0.1\" openssl x509 -req -in apiserver.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out apiserver.crt -days 3650 -extensions v3_req -extfile \u003c(printf \"[v3_req]\\nsubjectAltName=IP:127.0.0.1,DNS:localhost\") openssl req -newkey rsa:2048 -nodes -keyout admin.key -out admin.csr -subj \"/CN=admin/O=system:masters\" openssl x509 -req -in admin.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out admin.crt -days 3650 Non-Encrypted Scenario Check etcd snapshot consistency.\n./bin/etcdutl snapshot status snapshot_2025-10-02_092618.db -w table +----------+----------+------------+------------+ | HASH | REVISION | TOTAL KEYS | TOTAL SIZE | +----------+----------+------------+------------+ | 7804fc7a | 9078653 | 11199 | 94 MB | +----------+----------+------------+------------+ Restore the snapshot data to a local folder.\n./bin/etcdutl snapshot restore snapshot_2025-10-02_092618.db --data-dir etcd-data 2025-10-02T11:26:59Z info snapshot/v3_snapshot.go:265 restoring snapshot {\"path\": \"snapshot_2025-10-02_092618.db\", \"wal-dir\": \"etcd-data/member/wal\", \"data-dir\": \"etcd-data\", \"snap-dir\": \"etcd-data/member/snap\", \"initial-memory-map-size\": 10737418240} 2025-10-02T11:26:59Z info membership/store.go:141 Trimming membership information from the backend... 2025-10-02T11:26:59Z info membership/cluster.go:421 added member {\"cluster-id\": \"cdf818194e3a8c32\", \"local-member-id\": \"0\", \"added-peer-id\": \"8e9e05c52164694d\", \"added-peer-peer-urls\": [\"http://localhost:2380\"]} 2025-10-02T11:26:59Z info snapshot/v3_snapshot.go:293 restored snapshot {\"path\": \"snapshot_2025-10-02_092618.db\", \"wal-dir\": \"etcd-data/member/wal\", \"data-dir\": \"etcd-data\", \"snap-dir\": \"etcd-data/member/snap\", \"initial-memory-map-size\": 10737418240} Start a single unauthenticated etcd instance with this data.\n./bin/etcd --data-dir etcd-data \\ --listen-client-urls http://127.0.0.1:2379 \\ --advertise-client-urls http://127.0.0.1:2379 Start a local kube-apiserver and connect it to the etcd instance.\nNOTE: The --etcd-prefix parameter may be different for your cluster. Some Kubernetes distributions change this.\n./bin/kube-apiserver \\ --etcd-servers=http://127.0.0.1:2379 \\ --authorization-mode=AlwaysAllow \\ --secure-port=6443 \\ --tls-cert-file=./apiserver.crt \\ --tls-private-key-file=./apiserver.key \\ --client-ca-file=./ca.crt \\ --service-account-issuer=https://kubernetes.default.svc \\ --service-account-key-file=./apiserver.key \\ --service-account-signing-key-file=./apiserver.key \\ --etcd-prefix /kubernetes.io Get the data you want.\nkubectl --kubeconfig /dev/null \\ --server=https://127.0.0.1:6443 \\ --certificate-authority=./ca.crt \\ --client-certificate=./admin.crt \\ --client-key=./admin.key \\ -n kube-system get secret \\ pull-secret -o jsonpath='{.data.\\.dockerconfigjson}' | base64 -d {\"auths\":... Encrypted Scenario Check snapshot consistency.\n./bin/etcdutl snapshot status snapshot_2025-10-02_102135.db -w table +----------+----------+------------+------------+ | HASH | REVISION | TOTAL KEYS | TOTAL SIZE | +----------+----------+------------+------------+ | 32c89b47 | 9119744 | 16292 | 102 MB | +----------+----------+------------+------------+ Restore the snapshot data to a local folder.\n./bin/etcdutl snapshot restore snapshot_2025-10-02_102135.db --data-dir etcd-data-encrypted 2025-10-02T11:36:57Z info snapshot/v3_snapshot.go:265 restoring snapshot {\"path\": \"snapshot_2025-10-02_102135.db\", \"wal-dir\": \"etcd-data-encrypted/member/wal\", \"data-dir\": \"etcd-data-encrypted\", \"snap-dir\": \"etcd-data-encrypted/member/snap\", \"initial-memory-map-size\": 10737418240} 2025-10-02T11:36:57Z info membership/store.go:141 Trimming membership information from the backend... 2025-10-02T11:36:57Z info membership/cluster.go:421 added member {\"cluster-id\": \"cdf818194e3a8c32\", \"local-member-id\": \"0\", \"added-peer-id\": \"8e9e05c52164694d\", \"added-peer-peer-urls\": [\"http://localhost:2380\"]} 2025-10-02T11:36:57Z info snapshot/v3_snapshot.go:293 restored snapshot {\"path\": \"snapshot_2025-10-02_102135.db\", \"wal-dir\": \"etcd-data-encrypted/member/wal\", \"data-dir\": \"etcd-data-encrypted\", \"snap-dir\": \"etcd-data-encrypted/member/snap\", \"initial-memory-map-size\": 10737418240} Start a single unauthenticated etcd instance with this data.\n./bin/etcd --data-dir etcd-data-encrypted \\ --listen-client-urls http://127.0.0.1:2379 \\ --advertise-client-urls http://127.0.0.1:2379 Get the encryption provider config.\nNOTE: This file is the one that contains the encryption config configuration from the cluster where the etcd snapshot was taken.\ncat ./encryption-config {\"kind\":\"EncryptionConfiguration\",\"apiVersion\":\"apiserver.config.k8s.io/v1\",\"resources\":[{\"resources\":[\"configmaps\"],\"providers\":[{\"aesgcm\":{\"keys\":[{\"name\":\"1\",\"secret\":\"sTD5PvlTrSwtq1O5PSHEuQdggYYXmyNhnjTtJbHZsP0=\"}]}},{\"identity\":{}}]},{\"resources\":[\"secrets\"],\"providers\":[{\"aesgcm\":{\"keys\":[{\"name\":\"1\",\"secret\":\"sTD5PvlTrSwtq1O5PSHEuQdggYYXmyNhnjTtJbHZsP0=\"}]}},{\"identity\":{}}]}]} Start a local kube-apiserver wit the encryption config and connect it to the local etcd instance.\n./bin/kube-apiserver \\ --etcd-servers=http://127.0.0.1:2379 \\ --encryption-provider-config=./encryption-config \\ --authorization-mode=AlwaysAllow \\ --secure-port=6443 \\ --tls-cert-file=./apiserver.crt \\ --tls-private-key-file=./apiserver.key \\ --client-ca-file=./ca.crt \\ --service-account-issuer=https://kubernetes.default.svc \\ --service-account-key-file=./apiserver.key \\ --service-account-signing-key-file=./apiserver.key \\ --etcd-prefix /kubernetes.io Get the data you want.\nkubectl --kubeconfig /dev/null \\ --server=https://127.0.0.1:6443 \\ --certificate-authority=./ca.crt \\ --client-certificate=./admin.crt \\ --client-key=./admin.key \\ -n kube-system get secret \\ pull-secret -o jsonpath='{.data.\\.dockerconfigjson}' | base64 -d {\"auths\":... ","wordCount":"662","inLanguage":"en","datePublished":"2025-10-02T00:00:00Z","dateModified":"2025-10-02T00:00:00Z","author":{"@type":"Person","name":"Mario"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://linuxera.org/rag-beginners-guide/"},"publisher":{"@type":"Organization","name":"Linuxera","logo":{"@type":"ImageObject","url":"https://linuxera.org/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://linuxera.org/ accesskey=h title="Linuxera (Alt + H)">Linuxera</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://linuxera.org/ title="🏠 Home"><span>🏠 Home</span></a></li><li><a href=https://linuxera.org/archives/ title="🗄️ Archive"><span>🗄️ Archive</span></a></li><li><a href=https://linuxera.org/search/ title="🔎 Search"><span>🔎 Search</span></a></li><li><a href=https://linuxera.org/tags/ title="🏷️ Tags"><span>🏷️ Tags</span></a></li><li><a href=https://linuxera.org/presentations/ title="🎴 Presentations"><span>🎴 Presentations</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://linuxera.org/>Home</a>&nbsp;»&nbsp;<a href=https://linuxera.org/posts/>Posts</a></div><h1 class=post-title>Get data from an etcd backup (encrypted or not!)</h1><div class=post-meta><span title='2025-10-02 00:00:00 +0000 UTC'>Published on October 2, 2025</span>&nbsp;·&nbsp;<span title='2025-10-02 00:00:00 +0000 UTC'>Last updated on October 2, 2025</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;Mario</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#get-data-from-an-etcd-backup-encrypted-or-not aria-label="Get data from an etcd backup (encrypted or not!)">Get data from an etcd backup (encrypted or not!)</a><ul><li><a href=#prereqs aria-label=Prereqs>Prereqs</a></li><li><a href=#non-encrypted-scenario aria-label="Non-Encrypted Scenario">Non-Encrypted Scenario</a></li><li><a href=#encrypted-scenario aria-label="Encrypted Scenario">Encrypted Scenario</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=get-data-from-an-etcd-backup-encrypted-or-not>Get data from an etcd backup (encrypted or not!)<a hidden class=anchor aria-hidden=true href=#get-data-from-an-etcd-backup-encrypted-or-not>#</a></h1><p>The following post aims to provide a step by step procedure to recover data from an etcd snapshot (even if it’s encrypted) from a Kubernetes cluster.</p><p>The post targets the following use cases:</p><ul><li>We have a non-encrypted etcd snapshot file, and we want to get some data from it.</li><li>We have an encrypted etcd snapshot file, and we want to get some data from it.</li></ul><p>For non-encrypted etcd snapshots, you can read the data with the etcdctl tool directly. In this post, since I have to cover encrypted as well, I&rsquo;ll describe how to consume the restored data from a temporary local kube-apiserver.</p><h2 id=prereqs>Prereqs<a hidden class=anchor aria-hidden=true href=#prereqs>#</a></h2><ol><li><p>Download etcd tooling and Kubernetes binaries (you want to use the same versions as the ones used in the cluster where the backup was taken, it may work using different ones thought).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>mkdir -p /var/tmp/etcd-restore-tests/bin
</span></span><span class=line><span class=cl><span class=nb>cd</span> /var/tmp/etcd-restore-tests
</span></span><span class=line><span class=cl>curl -LO https://github.com/etcd-io/etcd/releases/download/v3.5.18/etcd-v3.5.18-linux-amd64.tar.gz
</span></span><span class=line><span class=cl>curl -LO https://dl.k8s.io/v1.31.11/kubernetes-server-linux-amd64.tar.gz
</span></span><span class=line><span class=cl>tar xvf etcd-v3.5.18-linux-amd64.tar.gz -C ./bin/ etcd-v3.5.18-linux-amd64/etcd etcd-v3.5.18-linux-amd64/etcdutl --transform<span class=o>=</span><span class=s1>&#39;s|.*/||&#39;</span>
</span></span><span class=line><span class=cl>tar xvf kubernetes-server-linux-amd64.tar.gz -C ./bin/ kubernetes/server/bin/kube-apiserver --transform<span class=o>=</span><span class=s1>&#39;s|.*/||&#39;</span>
</span></span></code></pre></div></li><li><p>Generate the required certificates for the temporary kube-apiserver.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>openssl req -x509 -newkey rsa:2048 -nodes -keyout ca.key -out ca.crt -subj <span class=s2>&#34;/CN=etcd-ca&#34;</span> -days <span class=m>3650</span>
</span></span><span class=line><span class=cl>openssl req -newkey rsa:2048 -nodes -keyout apiserver.key -out apiserver.csr -subj <span class=s2>&#34;/CN=127.0.0.1&#34;</span>
</span></span><span class=line><span class=cl>openssl x509 -req -in apiserver.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out apiserver.crt -days <span class=m>3650</span> -extensions v3_req -extfile &lt;<span class=o>(</span><span class=nb>printf</span> <span class=s2>&#34;[v3_req]\nsubjectAltName=IP:127.0.0.1,DNS:localhost&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>openssl req -newkey rsa:2048 -nodes -keyout admin.key -out admin.csr -subj <span class=s2>&#34;/CN=admin/O=system:masters&#34;</span>
</span></span><span class=line><span class=cl>openssl x509 -req -in admin.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out admin.crt -days <span class=m>3650</span>
</span></span></code></pre></div></li></ol><h2 id=non-encrypted-scenario>Non-Encrypted Scenario<a hidden class=anchor aria-hidden=true href=#non-encrypted-scenario>#</a></h2><ol><li><p>Check etcd snapshot consistency.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>./bin/etcdutl snapshot status snapshot_2025-10-02_092618.db -w table
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>+----------+----------+------------+------------+
</span></span><span class=line><span class=cl><span class=p>|</span>   HASH   <span class=p>|</span> REVISION <span class=p>|</span> TOTAL KEYS <span class=p>|</span> TOTAL SIZE <span class=p>|</span>
</span></span><span class=line><span class=cl>+----------+----------+------------+------------+
</span></span><span class=line><span class=cl><span class=p>|</span> 7804fc7a <span class=p>|</span>  <span class=m>9078653</span> <span class=p>|</span>      <span class=m>11199</span> <span class=p>|</span>      <span class=m>94</span> MB <span class=p>|</span>
</span></span><span class=line><span class=cl>+----------+----------+------------+------------+
</span></span></code></pre></div></li><li><p>Restore the snapshot data to a local folder.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>./bin/etcdutl snapshot restore snapshot_2025-10-02_092618.db --data-dir etcd-data
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>2025-10-02T11:26:59Z    info    snapshot/v3_snapshot.go:265     restoring snapshot      <span class=o>{</span><span class=s2>&#34;path&#34;</span>: <span class=s2>&#34;snapshot_2025-10-02_092618.db&#34;</span>, <span class=s2>&#34;wal-dir&#34;</span>: <span class=s2>&#34;etcd-data/member/wal&#34;</span>, <span class=s2>&#34;data-dir&#34;</span>: <span class=s2>&#34;etcd-data&#34;</span>, <span class=s2>&#34;snap-dir&#34;</span>: <span class=s2>&#34;etcd-data/member/snap&#34;</span>, <span class=s2>&#34;initial-memory-map-size&#34;</span>: 10737418240<span class=o>}</span>
</span></span><span class=line><span class=cl>2025-10-02T11:26:59Z    info    membership/store.go:141 Trimming membership information from the backend...
</span></span><span class=line><span class=cl>2025-10-02T11:26:59Z    info    membership/cluster.go:421       added member    <span class=o>{</span><span class=s2>&#34;cluster-id&#34;</span>: <span class=s2>&#34;cdf818194e3a8c32&#34;</span>, <span class=s2>&#34;local-member-id&#34;</span>: <span class=s2>&#34;0&#34;</span>, <span class=s2>&#34;added-peer-id&#34;</span>: <span class=s2>&#34;8e9e05c52164694d&#34;</span>, <span class=s2>&#34;added-peer-peer-urls&#34;</span>: <span class=o>[</span><span class=s2>&#34;http://localhost:2380&#34;</span><span class=o>]}</span>
</span></span><span class=line><span class=cl>2025-10-02T11:26:59Z    info    snapshot/v3_snapshot.go:293     restored snapshot       <span class=o>{</span><span class=s2>&#34;path&#34;</span>: <span class=s2>&#34;snapshot_2025-10-02_092618.db&#34;</span>, <span class=s2>&#34;wal-dir&#34;</span>: <span class=s2>&#34;etcd-data/member/wal&#34;</span>, <span class=s2>&#34;data-dir&#34;</span>: <span class=s2>&#34;etcd-data&#34;</span>, <span class=s2>&#34;snap-dir&#34;</span>: <span class=s2>&#34;etcd-data/member/snap&#34;</span>, <span class=s2>&#34;initial-memory-map-size&#34;</span>: 10737418240<span class=o>}</span>
</span></span></code></pre></div></li><li><p>Start a single unauthenticated etcd instance with this data.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>./bin/etcd --data-dir etcd-data <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --listen-client-urls http://127.0.0.1:2379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --advertise-client-urls http://127.0.0.1:2379
</span></span></code></pre></div></li><li><p>Start a local kube-apiserver and connect it to the etcd instance.</p><blockquote><p><strong>NOTE</strong>: The <code>--etcd-prefix</code> parameter may be different for your cluster. Some Kubernetes distributions change this.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>./bin/kube-apiserver <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --etcd-servers<span class=o>=</span>http://127.0.0.1:2379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --authorization-mode<span class=o>=</span>AlwaysAllow <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --secure-port<span class=o>=</span><span class=m>6443</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --tls-cert-file<span class=o>=</span>./apiserver.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --tls-private-key-file<span class=o>=</span>./apiserver.key <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --client-ca-file<span class=o>=</span>./ca.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --service-account-issuer<span class=o>=</span>https://kubernetes.default.svc <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --service-account-key-file<span class=o>=</span>./apiserver.key <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --service-account-signing-key-file<span class=o>=</span>./apiserver.key <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --etcd-prefix /kubernetes.io
</span></span></code></pre></div></li><li><p>Get the data you want.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl --kubeconfig /dev/null <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --server<span class=o>=</span>https://127.0.0.1:6443 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --certificate-authority<span class=o>=</span>./ca.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --client-certificate<span class=o>=</span>./admin.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --client-key<span class=o>=</span>./admin.key <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -n kube-system get secret <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  pull-secret -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.data.\.dockerconfigjson}&#39;</span> <span class=p>|</span> base64 -d
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;auths&#34;</span>:...&lt;redacted&gt;
</span></span></code></pre></div></li></ol><h2 id=encrypted-scenario>Encrypted Scenario<a hidden class=anchor aria-hidden=true href=#encrypted-scenario>#</a></h2><ol><li><p>Check snapshot consistency.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>./bin/etcdutl snapshot status snapshot_2025-10-02_102135.db -w table
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>+----------+----------+------------+------------+
</span></span><span class=line><span class=cl><span class=p>|</span>   HASH   <span class=p>|</span> REVISION <span class=p>|</span> TOTAL KEYS <span class=p>|</span> TOTAL SIZE <span class=p>|</span>
</span></span><span class=line><span class=cl>+----------+----------+------------+------------+
</span></span><span class=line><span class=cl><span class=p>|</span> 32c89b47 <span class=p>|</span>  <span class=m>9119744</span> <span class=p>|</span>      <span class=m>16292</span> <span class=p>|</span>     <span class=m>102</span> MB <span class=p>|</span>
</span></span><span class=line><span class=cl>+----------+----------+------------+------------+
</span></span></code></pre></div></li><li><p>Restore the snapshot data to a local folder.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>./bin/etcdutl snapshot restore snapshot_2025-10-02_102135.db --data-dir etcd-data-encrypted
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>2025-10-02T11:36:57Z    info    snapshot/v3_snapshot.go:265     restoring snapshot      <span class=o>{</span><span class=s2>&#34;path&#34;</span>: <span class=s2>&#34;snapshot_2025-10-02_102135.db&#34;</span>, <span class=s2>&#34;wal-dir&#34;</span>: <span class=s2>&#34;etcd-data-encrypted/member/wal&#34;</span>, <span class=s2>&#34;data-dir&#34;</span>: <span class=s2>&#34;etcd-data-encrypted&#34;</span>, <span class=s2>&#34;snap-dir&#34;</span>: <span class=s2>&#34;etcd-data-encrypted/member/snap&#34;</span>, <span class=s2>&#34;initial-memory-map-size&#34;</span>: 10737418240<span class=o>}</span>
</span></span><span class=line><span class=cl>2025-10-02T11:36:57Z    info    membership/store.go:141 Trimming membership information from the backend...
</span></span><span class=line><span class=cl>2025-10-02T11:36:57Z    info    membership/cluster.go:421       added member    <span class=o>{</span><span class=s2>&#34;cluster-id&#34;</span>: <span class=s2>&#34;cdf818194e3a8c32&#34;</span>, <span class=s2>&#34;local-member-id&#34;</span>: <span class=s2>&#34;0&#34;</span>, <span class=s2>&#34;added-peer-id&#34;</span>: <span class=s2>&#34;8e9e05c52164694d&#34;</span>, <span class=s2>&#34;added-peer-peer-urls&#34;</span>: <span class=o>[</span><span class=s2>&#34;http://localhost:2380&#34;</span><span class=o>]}</span>
</span></span><span class=line><span class=cl>2025-10-02T11:36:57Z    info    snapshot/v3_snapshot.go:293     restored snapshot       <span class=o>{</span><span class=s2>&#34;path&#34;</span>: <span class=s2>&#34;snapshot_2025-10-02_102135.db&#34;</span>, <span class=s2>&#34;wal-dir&#34;</span>: <span class=s2>&#34;etcd-data-encrypted/member/wal&#34;</span>, <span class=s2>&#34;data-dir&#34;</span>: <span class=s2>&#34;etcd-data-encrypted&#34;</span>, <span class=s2>&#34;snap-dir&#34;</span>: <span class=s2>&#34;etcd-data-encrypted/member/snap&#34;</span>, <span class=s2>&#34;initial-memory-map-size&#34;</span>: 10737418240<span class=o>}</span>
</span></span></code></pre></div></li><li><p>Start a single unauthenticated etcd instance with this data.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>./bin/etcd --data-dir etcd-data-encrypted <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --listen-client-urls http://127.0.0.1:2379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --advertise-client-urls http://127.0.0.1:2379
</span></span></code></pre></div></li><li><p>Get the encryption provider config.</p><blockquote><p>NOTE: This file is the one that contains the encryption config configuration from the cluster where the etcd snapshot was taken.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cat ./encryption-config
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;kind&#34;</span>:<span class=s2>&#34;EncryptionConfiguration&#34;</span>,<span class=s2>&#34;apiVersion&#34;</span>:<span class=s2>&#34;apiserver.config.k8s.io/v1&#34;</span>,<span class=s2>&#34;resources&#34;</span>:<span class=o>[{</span><span class=s2>&#34;resources&#34;</span>:<span class=o>[</span><span class=s2>&#34;configmaps&#34;</span><span class=o>]</span>,<span class=s2>&#34;providers&#34;</span>:<span class=o>[{</span><span class=s2>&#34;aesgcm&#34;</span>:<span class=o>{</span><span class=s2>&#34;keys&#34;</span>:<span class=o>[{</span><span class=s2>&#34;name&#34;</span>:<span class=s2>&#34;1&#34;</span>,<span class=s2>&#34;secret&#34;</span>:<span class=s2>&#34;sTD5PvlTrSwtq1O5PSHEuQdggYYXmyNhnjTtJbHZsP0=&#34;</span><span class=o>}]}}</span>,<span class=o>{</span><span class=s2>&#34;identity&#34;</span>:<span class=o>{}}]}</span>,<span class=o>{</span><span class=s2>&#34;resources&#34;</span>:<span class=o>[</span><span class=s2>&#34;secrets&#34;</span><span class=o>]</span>,<span class=s2>&#34;providers&#34;</span>:<span class=o>[{</span><span class=s2>&#34;aesgcm&#34;</span>:<span class=o>{</span><span class=s2>&#34;keys&#34;</span>:<span class=o>[{</span><span class=s2>&#34;name&#34;</span>:<span class=s2>&#34;1&#34;</span>,<span class=s2>&#34;secret&#34;</span>:<span class=s2>&#34;sTD5PvlTrSwtq1O5PSHEuQdggYYXmyNhnjTtJbHZsP0=&#34;</span><span class=o>}]}}</span>,<span class=o>{</span><span class=s2>&#34;identity&#34;</span>:<span class=o>{}}]}]}</span>
</span></span></code></pre></div></li><li><p>Start a local kube-apiserver wit the encryption config and connect it to the local etcd instance.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>./bin/kube-apiserver <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --etcd-servers<span class=o>=</span>http://127.0.0.1:2379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --encryption-provider-config<span class=o>=</span>./encryption-config <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --authorization-mode<span class=o>=</span>AlwaysAllow <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --secure-port<span class=o>=</span><span class=m>6443</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --tls-cert-file<span class=o>=</span>./apiserver.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --tls-private-key-file<span class=o>=</span>./apiserver.key <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --client-ca-file<span class=o>=</span>./ca.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --service-account-issuer<span class=o>=</span>https://kubernetes.default.svc <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --service-account-key-file<span class=o>=</span>./apiserver.key <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --service-account-signing-key-file<span class=o>=</span>./apiserver.key <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --etcd-prefix /kubernetes.io
</span></span></code></pre></div></li><li><p>Get the data you want.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl --kubeconfig /dev/null <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --server<span class=o>=</span>https://127.0.0.1:6443 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --certificate-authority<span class=o>=</span>./ca.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --client-certificate<span class=o>=</span>./admin.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --client-key<span class=o>=</span>./admin.key <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -n kube-system get secret <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  pull-secret -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.data.\.dockerconfigjson}&#39;</span> <span class=p>|</span> base64 -d
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;auths&#34;</span>:...&lt;redacted&gt;
</span></span></code></pre></div></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://linuxera.org/tags/kubernetes/>kubernetes</a></li><li><a href=https://linuxera.org/tags/etcd/>etcd</a></li><li><a href=https://linuxera.org/tags/encrypted-etcd/>encrypted etcd</a></li><li><a href=https://linuxera.org/tags/backup/>backup</a></li><li><a href=https://linuxera.org/tags/restore/>restore</a></li></ul><nav class=paginav><a class=next href=https://linuxera.org/rag-beginners-guide/><span class=title>Next »</span><br><span>A Beginner’s Guide to RAG: What I Wish Someone Told Me</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Get data from an etcd backup (encrypted or not!) on twitter" href="https://twitter.com/intent/tweet/?text=Get%20data%20from%20an%20etcd%20backup%20%28encrypted%20or%20not%21%29&url=https%3a%2f%2flinuxera.org%2frag-beginners-guide%2f&hashtags=etcd%2ckubernetes%2cetcd%2cencryptedetcd%2cbackup%2crestore"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Get data from an etcd backup (encrypted or not!) on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2flinuxera.org%2frag-beginners-guide%2f&title=Get%20data%20from%20an%20etcd%20backup%20%28encrypted%20or%20not%21%29&summary=Get%20data%20from%20an%20etcd%20backup%20%28encrypted%20or%20not%21%29&source=https%3a%2f%2flinuxera.org%2frag-beginners-guide%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></div></footer><div class=share-buttons><p>If this post has been helpful to you, consider <u><a target=_blank href=https://ko-fi.com/mvazce>supporting the work.</a></u></p></div><script src=https://utteranc.es/client.js repo=mvazquezc/mvazquezc.github.io issue-term=pathname label=blog-comments theme=preferred-color-scheme crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2025 <a href=https://linuxera.org/>Linuxera</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>