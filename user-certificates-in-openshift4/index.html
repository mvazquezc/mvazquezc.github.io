<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>OpenShift 4 User Certificates | Linuxera</title><meta name=keywords content="openshift,opc,security,client-certificates,users"><meta name=description content="User Certificates in OpenShift 4 Attention
The information described in this blog post may not be a supported configuration for OpenShift 4. Please, refer to the official docs for supported documentation.
In this blog we will see how we can create OpenShift Users using client certificates and how to configure the API Server, so we can create client certificates using custom CAs. The information described in this blog was last tested with OpenShift 4."><meta name=author content="Mario"><link rel=canonical href=https://linuxera.org/user-certificates-in-openshift4/><link crossorigin=anonymous href=/assets/css/stylesheet.8cc7ef3cdd44c5188f9267864f378d8dd8892d583e0fd07b5e5321e496f1e4d1.css integrity="sha256-jMfvPN1ExRiPkmeGTzeNjdiJLVg+D9B7XlMh5Jbx5NE=" rel="preload stylesheet" as=style><link rel=icon href=https://linuxera.org/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://linuxera.org/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://linuxera.org/favicon-32x32.png><link rel=apple-touch-icon href=https://linuxera.org/apple-touch-icon.png><link rel=mask-icon href=https://linuxera.org/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-7598JKCK1E"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-7598JKCK1E",{anonymize_ip:!1})}</script><meta property="og:title" content="OpenShift 4 User Certificates"><meta property="og:description" content="User Certificates in OpenShift 4 Attention
The information described in this blog post may not be a supported configuration for OpenShift 4. Please, refer to the official docs for supported documentation.
In this blog we will see how we can create OpenShift Users using client certificates and how to configure the API Server, so we can create client certificates using custom CAs. The information described in this blog was last tested with OpenShift 4."><meta property="og:type" content="article"><meta property="og:url" content="https://linuxera.org/user-certificates-in-openshift4/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-13T00:00:00+00:00"><meta property="article:modified_time" content="2023-01-13T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="OpenShift 4 User Certificates"><meta name=twitter:description content="User Certificates in OpenShift 4 Attention
The information described in this blog post may not be a supported configuration for OpenShift 4. Please, refer to the official docs for supported documentation.
In this blog we will see how we can create OpenShift Users using client certificates and how to configure the API Server, so we can create client certificates using custom CAs. The information described in this blog was last tested with OpenShift 4."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://linuxera.org/posts/"},{"@type":"ListItem","position":2,"name":"OpenShift 4 User Certificates","item":"https://linuxera.org/user-certificates-in-openshift4/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"OpenShift 4 User Certificates","name":"OpenShift 4 User Certificates","description":"User Certificates in OpenShift 4 Attention\nThe information described in this blog post may not be a supported configuration for OpenShift 4. Please, refer to the official docs for supported documentation.\nIn this blog we will see how we can create OpenShift Users using client certificates and how to configure the API Server, so we can create client certificates using custom CAs. The information described in this blog was last tested with OpenShift 4.","keywords":["openshift","opc","security","client-certificates","users"],"articleBody":"User Certificates in OpenShift 4 Attention\nThe information described in this blog post may not be a supported configuration for OpenShift 4. Please, refer to the official docs for supported documentation.\nIn this blog we will see how we can create OpenShift Users using client certificates and how to configure the API Server, so we can create client certificates using custom CAs. The information described in this blog was last tested with OpenShift 4.11.\nOpenShift Authentication As you may know, OpenShift 4 supports different authentication providers. By default, once your cluster is installed you will get a kubeadmin user to access the UI and a kubeconfig file configured with a client cert to access the API Server as cluster-admin.\nOn top of that you get an OAuth Server that can be configured for adding different authentication sources like GitHub, LDAP, etc. This post will focus on creating new client certificates to access the API Server via kubeconfig files.\nThe scenario will be as follows:\nA client certificate for the user luffy will be issued using a self-signed CA named customer-signer-custom. A client certificate for the user zoro will be issued using a self-signed CA named customer-signer-custom-2. A client certificate for the user nami will be issued using the internal OpenShift CA via a CertificateSigningRequest. Creating the client certificate for Nami using the internal OpenShift CA Before we create this first user, we need to understand how usernames and groups are assigned in Kubernetes when using client certificates. Groups for the user will be configured in the Organization field while username will be configured in the Common Name field.\nLet‚Äôs get startes by creating a CSR for the client certificate using the openssl client:\nNote\nWe are using group ‚Äúsystem:admin‚Äù and username ‚Äúnami‚Äù for this client certificate.\nopenssl req -nodes -newkey rsa:4096 -keyout /tmp/nami.key -subj \"/O=system:admin/CN=nami\" -out /tmp/nami.csr Now that we have the csr, let‚Äôs submit the CSR to OpenShift in order to sign it with the internal CA later:\ncat \u003c\u003c EOF | oc create -f - apiVersion: certificates.k8s.io/v1 kind: CertificateSigningRequest metadata: name: nami-access spec: signerName: kubernetes.io/kube-apiserver-client groups: - system:authenticated request: $(cat /tmp/nami.csr | base64 -w0) usages: - client auth EOF Next, time to approve the certificate request:\noc adm certificate approve nami-access The certificate has been approved, we can get it now from the cluster:\noc get csr nami-access -o jsonpath='{.status.certificate}' | base64 -d \u003e /tmp/nami.crt At this point we‚Äôre all set, next step will be creating a kubeconfig file for nami to log into our cluster, we will leave that for later. For now, let‚Äôs continue creating the client certificates for luffy and zoro.\nCreating the client certificate for Luffy using the customer-signer-custom self-signed CA We need a self-signed CA, although this could be an existing CA that already exists in your environment, for this post we will create one using the openssl client:\nopenssl genrsa -out /tmp/customer-ca.key 4096 openssl req -x509 -new -nodes -key /tmp/customer-ca.key -sha256 -days 9999 -out /tmp/customer-ca.crt -subj \"/OU=openshift/CN=customer-signer-custom\" Now that we have the CA, let‚Äôs create the luffy client certificate request:\nNote\nWe are using group ‚Äúsystem:admin‚Äù and username ‚Äúluffy‚Äù for this client certificate.\nopenssl req -nodes -newkey rsa:4096 -keyout /tmp/luffy.key -subj \"/O=system:admin/CN=luffy\" -out /tmp/luffy.csr We can now sign the csr:\nopenssl x509 -extfile \u003c(printf \"extendedKeyUsage = clientAuth\") -req -in /tmp/luffy.csr -CA /tmp/customer-ca.crt -CAkey /tmp/customer-ca.key -CAcreateserial -out /tmp/luffy.crt -days 9999 -sha256 And we‚Äôre done here, next step would be the kubeconfig creation. Let‚Äôs continue with zoro's client certificate before we start creating the kubeconfig files.\nCreating the client certificate for Zoro using the customer-signer-custom-2 self-signed CA Note\nWe are using group ‚Äúsystem:admin‚Äù and username ‚Äúzoro‚Äù for this client certificate.\n# Create self-signed CA openssl genrsa -out /tmp/customer-ca-2.key 4096 openssl req -x509 -new -nodes -key /tmp/customer-ca-2.key -sha256 -days 9999 -out /tmp/customer-ca-2.crt -subj \"/OU=openshift/CN=customer-signer-custom-2\" # Create CSR for zoro's client cert openssl req -nodes -newkey rsa:4096 -keyout /tmp/zoro.key -subj \"/O=system:admin/CN=zoro\" -out /tmp/zoro.csr # Sign CSR openssl x509 -extfile \u003c(printf \"extendedKeyUsage = clientAuth\") -req -in /tmp/zoro.csr -CA /tmp/customer-ca-2.crt -CAkey /tmp/customer-ca-2.key -CAcreateserial -out /tmp/zoro.crt -days 9999 -sha256 Creating the kubeconfig files for Nami, Luffy and Zoro Before we start creating the kubeconfig files we need to get the public cert of our API server, this will be used by the kubectl/oc clients in order to trust the API Server certificate.\nexport OPENSHIFT_API_SERVER_ENDPOINT=api.cluster.example.com:6443 openssl s_client -showcerts -connect ${OPENSHIFT_API_SERVER_ENDPOINT} /dev/null|openssl x509 -outform PEM \u003e /tmp/ocp-apiserver-cert.crt Let‚Äôs start with Nami's kubeconfig:\noc --kubeconfig /tmp/nami config set-credentials nami --client-certificate=/tmp/nami.crt --client-key=/tmp/nami.key --embed-certs=true oc --kubeconfig /tmp/nami config set-cluster openshift-cluster-dev --certificate-authority=/tmp/ocp-apiserver-cert.crt --embed-certs=true --server=https://${OPENSHIFT_API_SERVER_ENDPOINT} oc --kubeconfig /tmp/nami config set-context openshift-dev --cluster=openshift-cluster-dev --namespace=default --user=nami oc --kubeconfig /tmp/nami config use-context openshift-dev Now let‚Äôs do Zoro's:\noc --kubeconfig /tmp/zoro config set-credentials zoro --client-certificate=/tmp/zoro.crt --client-key=/tmp/zoro.key --embed-certs=true oc --kubeconfig /tmp/zoro config set-cluster openshift-cluster-dev --certificate-authority=/tmp/ocp-apiserver-cert.crt --embed-certs=true --server=https://${OPENSHIFT_API_SERVER_ENDPOINT} oc --kubeconfig /tmp/zoro config set-context openshift-dev --cluster=openshift-cluster-dev --namespace=default --user=zoro oc --kubeconfig /tmp/zoro config use-context openshift-dev And finally Luffy's:\noc --kubeconfig /tmp/luffy config set-credentials luffy --client-certificate=/tmp/luffy.crt --client-key=/tmp/luffy.key --embed-certs=true oc --kubeconfig /tmp/luffy config set-cluster openshift-cluster-dev --certificate-authority=/tmp/ocp-apiserver-cert.crt --embed-certs=true --server=https://${OPENSHIFT_API_SERVER_ENDPOINT} oc --kubeconfig /tmp/luffy config set-context openshift-dev --cluster=openshift-cluster-dev --namespace=default --user=luffy oc --kubeconfig /tmp/luffy config use-context openshift-dev Accessing our cluster with the new kubeconfig files: oc --kubeconfig /tmp/luffy whoami error: You must be logged in to the server (Unauthorized) oc --kubeconfig /tmp/zoro whoami error: You must be logged in to the server (Unauthorized) oc --kubeconfig /tmp/nami whoami nami As you can see from the above output only Nami can access the cluster, but why? - Well, the API Server doesn‚Äôt trust the self-signed CAs we created. We need to configure it to trust them, let‚Äôs do it:\nNote\nSince we have two self-signed CAs and the APIServer only accepts 1 ConfigMap, we need to create a bundle with all the CAs we want to trust when using client certificates authentication. This doesn‚Äôt include the internal OpenShift CA, which is always trusted.\ncat /tmp/customer-ca.crt /tmp/customer-ca-2.crt \u003e /tmp/customer-custom-cas.crt oc create configmap customer-cas-custom -n openshift-config --from-file=ca-bundle.crt=/tmp/customer-custom-cas.crt Now that the ConfigMap is ready, let‚Äôs tell the APIServer to use it:\noc patch apiserver cluster --type=merge -p '{\"spec\": {\"clientCA\": {\"name\": \"customer-cas-custom\"}}}' If we try the kubeconfig files again, this is the result:\noc --kubeconfig /tmp/luffy whoami luffy oc --kubeconfig /tmp/zoro whoami zoro oc --kubeconfig /tmp/nami whoami nami Now all three work, but if we try to do other stuff like listing pods, nodes, etc. we will see that we don‚Äôt have access to that. That‚Äôs expected since in a default OCP installation we don‚Äôt have RBAC rules for the system:admin group:\noc --kubeconfig /tmp/luffy get nodes Error from server (Forbidden): nodes is forbidden: User \"luffy\" cannot list resource \"nodes\" in API group \"\" at the cluster scope oc --kubeconfig /tmp/zoro -n default get pods Error from server (Forbidden): pods is forbidden: User \"zoro\" cannot list resource \"pods\" in API group \"\" in the namespace \"default\" oc --kubeconfig /tmp/nami -n default get deployments Error from server (Forbidden): deployments.apps is forbidden: User \"nami\" cannot list resource \"deployments\" in API group \"apps\" in the namespace \"default\" Let‚Äôs configure users in the system:admin group as cluster admins:\noc adm policy add-cluster-role-to-group cluster-admin system:admin If we try again:\noc --kubeconfig /tmp/luffy get nodes NAME STATUS ROLES AGE VERSION openshift-master-0 Ready master,worker 99d v1.24.0+b62823b openshift-master-1 Ready master,worker 99d v1.24.0+b62823b openshift-master-2 Ready master,worker 99d v1.24.0+b62823b oc --kubeconfig /tmp/zoro -n default get pods NAME READY STATUS RESTARTS AGE test-64ccd87d6c-98j45 1/1 Running 1 4d4h oc --kubeconfig /tmp/nami -n default get deployments NAME READY UP-TO-DATE AVAILABLE AGE test 1/1 1 1 60d That‚Äôs it! I hope this clears how you can work with client certificates in OpenShift 4.\n","wordCount":"1244","inLanguage":"en","datePublished":"2023-01-13T00:00:00Z","dateModified":"2023-01-13T00:00:00Z","author":{"@type":"Person","name":"Mario"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://linuxera.org/user-certificates-in-openshift4/"},"publisher":{"@type":"Organization","name":"Linuxera","logo":{"@type":"ImageObject","url":"https://linuxera.org/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://linuxera.org/ accesskey=h title="Linuxera (Alt + H)">Linuxera</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://linuxera.org/ title="üè† Home"><span>üè† Home</span></a></li><li><a href=https://linuxera.org/archives/ title="üóÑÔ∏è Archive"><span>üóÑÔ∏è Archive</span></a></li><li><a href=https://linuxera.org/search/ title="üîé Search"><span>üîé Search</span></a></li><li><a href=https://linuxera.org/tags/ title="üè∑Ô∏è Tags"><span>üè∑Ô∏è Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://linuxera.org/>Home</a>&nbsp;¬ª&nbsp;<a href=https://linuxera.org/posts/>Posts</a></div><h1 class=post-title>OpenShift 4 User Certificates</h1><div class=post-meta><span title='2023-01-13 00:00:00 +0000 UTC'>Published on January 13, 2023</span>&nbsp;¬∑&nbsp;<span title='2023-01-13 00:00:00 +0000 UTC'>Last updated on January 13, 2023</span>&nbsp;¬∑&nbsp;6 min&nbsp;¬∑&nbsp;Mario</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#user-certificates-in-openshift-4 aria-label="User Certificates in OpenShift 4">User Certificates in OpenShift 4</a><ul><li><a href=#openshift-authentication aria-label="OpenShift Authentication">OpenShift Authentication</a><ul><li><a href=#creating-the-client-certificate-for-nami-using-the-internal-openshift-ca aria-label="Creating the client certificate for Nami using the internal OpenShift CA">Creating the client certificate for Nami using the internal OpenShift CA</a></li><li><a href=#creating-the-client-certificate-for-luffy-using-the-customer-signer-custom-self-signed-ca aria-label="Creating the client certificate for Luffy using the customer-signer-custom self-signed CA">Creating the client certificate for Luffy using the customer-signer-custom self-signed CA</a></li><li><a href=#creating-the-client-certificate-for-zoro-using-the-customer-signer-custom-2-self-signed-ca aria-label="Creating the client certificate for Zoro using the customer-signer-custom-2 self-signed CA">Creating the client certificate for Zoro using the customer-signer-custom-2 self-signed CA</a></li><li><a href=#creating-the-kubeconfig-files-for-nami-luffy-and-zoro aria-label="Creating the kubeconfig files for Nami, Luffy and Zoro">Creating the kubeconfig files for Nami, Luffy and Zoro</a></li><li><a href=#accessing-our-cluster-with-the-new-kubeconfig-files aria-label="Accessing our cluster with the new kubeconfig files:">Accessing our cluster with the new kubeconfig files:</a></li></ul></li></ul></li></ul></div></details></div><div class=post-content><h1 id=user-certificates-in-openshift-4>User Certificates in OpenShift 4<a hidden class=anchor aria-hidden=true href=#user-certificates-in-openshift-4>#</a></h1><div class="admonition attention"><p class=admonition-title>Attention</p><p class=admonition>The information described in this blog post may not be a supported configuration for OpenShift 4. Please, refer to the <a href=https://docs.openshift.com>official docs</a> for supported documentation.</p></div><p>In this blog we will see how we can create <strong>OpenShift Users</strong> using client certificates and how to configure the API Server, so we can create client certificates using <strong>custom CAs</strong>. The information described in this blog was last tested with OpenShift 4.11.</p><h2 id=openshift-authentication>OpenShift Authentication<a hidden class=anchor aria-hidden=true href=#openshift-authentication>#</a></h2><p>As you may know, OpenShift 4 supports different authentication providers. By default, once your cluster is installed you will get a <code>kubeadmin</code> user to access the UI and a <code>kubeconfig</code> file configured with a client cert to access the API Server as cluster-admin.</p><p>On top of that you get an OAuth Server that can be configured for adding different authentication sources like GitHub, LDAP, etc. This post will focus on creating new client certificates to access the API Server via <code>kubeconfig</code> files.</p><p>The scenario will be as follows:</p><ul><li>A client certificate for the user <code>luffy</code> will be issued using a self-signed CA named <code>customer-signer-custom</code>.</li><li>A client certificate for the user <code>zoro</code> will be issued using a self-signed CA named <code>customer-signer-custom-2</code>.</li><li>A client certificate for the user <code>nami</code> will be issued using the internal OpenShift CA via a <code>CertificateSigningRequest</code>.</li></ul><h3 id=creating-the-client-certificate-for-nami-using-the-internal-openshift-ca>Creating the client certificate for Nami using the internal OpenShift CA<a hidden class=anchor aria-hidden=true href=#creating-the-client-certificate-for-nami-using-the-internal-openshift-ca>#</a></h3><p>Before we create this first user, we need to understand how usernames and groups are assigned in Kubernetes when using client certificates. Groups for the user will be configured in the <code>Organization</code> field while username will be configured in the <code>Common Name</code> field.</p><p>Let&rsquo;s get startes by creating a CSR for the client certificate using the <code>openssl</code> client:</p><div class="admonition tip"><p class=admonition-title>Note</p><p class=admonition>We are using group &ldquo;system:admin&rdquo; and username &ldquo;nami&rdquo; for this client certificate.</p></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>openssl req -nodes -newkey rsa:4096 -keyout /tmp/nami.key -subj <span class=s2>&#34;/O=system:admin/CN=nami&#34;</span> -out /tmp/nami.csr
</span></span></code></pre></div><p>Now that we have the csr, let&rsquo;s submit the CSR to OpenShift in order to sign it with the internal CA later:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cat <span class=s>&lt;&lt; EOF | oc create -f -
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: certificates.k8s.io/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: CertificateSigningRequest
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: nami-access
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  signerName: kubernetes.io/kube-apiserver-client
</span></span></span><span class=line><span class=cl><span class=s>  groups:
</span></span></span><span class=line><span class=cl><span class=s>  - system:authenticated
</span></span></span><span class=line><span class=cl><span class=s>  request: $(cat /tmp/nami.csr | base64 -w0)
</span></span></span><span class=line><span class=cl><span class=s>  usages:
</span></span></span><span class=line><span class=cl><span class=s>  - client auth
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>Next, time to approve the certificate request:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>oc adm certificate approve nami-access
</span></span></code></pre></div><p>The certificate has been approved, we can get it now from the cluster:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>oc get csr nami-access -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.status.certificate}&#39;</span> <span class=p>|</span> base64 -d &gt; /tmp/nami.crt
</span></span></code></pre></div><p>At this point we&rsquo;re all set, next step will be creating a <code>kubeconfig</code> file for <code>nami</code> to log into our cluster, we will leave that for later. For now, let&rsquo;s continue creating the client certificates for <code>luffy</code> and <code>zoro</code>.</p><h3 id=creating-the-client-certificate-for-luffy-using-the-customer-signer-custom-self-signed-ca>Creating the client certificate for Luffy using the customer-signer-custom self-signed CA<a hidden class=anchor aria-hidden=true href=#creating-the-client-certificate-for-luffy-using-the-customer-signer-custom-self-signed-ca>#</a></h3><p>We need a self-signed CA, although this could be an existing CA that already exists in your environment, for this post we will create one using the <code>openssl</code> client:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>openssl genrsa -out /tmp/customer-ca.key <span class=m>4096</span>
</span></span><span class=line><span class=cl>openssl req -x509 -new -nodes -key /tmp/customer-ca.key -sha256 -days <span class=m>9999</span> -out /tmp/customer-ca.crt -subj <span class=s2>&#34;/OU=openshift/CN=customer-signer-custom&#34;</span>
</span></span></code></pre></div><p>Now that we have the CA, let&rsquo;s create the <code>luffy</code> client certificate request:</p><div class="admonition tip"><p class=admonition-title>Note</p><p class=admonition>We are using group &ldquo;system:admin&rdquo; and username &ldquo;luffy&rdquo; for this client certificate.</p></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>openssl req -nodes -newkey rsa:4096 -keyout /tmp/luffy.key -subj <span class=s2>&#34;/O=system:admin/CN=luffy&#34;</span> -out /tmp/luffy.csr
</span></span></code></pre></div><p>We can now sign the csr:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>openssl x509 -extfile &lt;<span class=o>(</span><span class=nb>printf</span> <span class=s2>&#34;extendedKeyUsage = clientAuth&#34;</span><span class=o>)</span> -req -in /tmp/luffy.csr -CA /tmp/customer-ca.crt -CAkey /tmp/customer-ca.key -CAcreateserial -out /tmp/luffy.crt -days <span class=m>9999</span> -sha256
</span></span></code></pre></div><p>And we&rsquo;re done here, next step would be the <code>kubeconfig</code> creation. Let&rsquo;s continue with <code>zoro's</code> client certificate before we start creating the <code>kubeconfig</code> files.</p><h3 id=creating-the-client-certificate-for-zoro-using-the-customer-signer-custom-2-self-signed-ca>Creating the client certificate for Zoro using the customer-signer-custom-2 self-signed CA<a hidden class=anchor aria-hidden=true href=#creating-the-client-certificate-for-zoro-using-the-customer-signer-custom-2-self-signed-ca>#</a></h3><div class="admonition tip"><p class=admonition-title>Note</p><p class=admonition>We are using group &ldquo;system:admin&rdquo; and username &ldquo;zoro&rdquo; for this client certificate.</p></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># Create self-signed CA</span>
</span></span><span class=line><span class=cl>openssl genrsa -out /tmp/customer-ca-2.key <span class=m>4096</span>
</span></span><span class=line><span class=cl>openssl req -x509 -new -nodes -key /tmp/customer-ca-2.key -sha256 -days <span class=m>9999</span> -out /tmp/customer-ca-2.crt -subj <span class=s2>&#34;/OU=openshift/CN=customer-signer-custom-2&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># Create CSR for zoro&#39;s client cert</span>
</span></span><span class=line><span class=cl>openssl req -nodes -newkey rsa:4096 -keyout /tmp/zoro.key -subj <span class=s2>&#34;/O=system:admin/CN=zoro&#34;</span> -out /tmp/zoro.csr
</span></span><span class=line><span class=cl><span class=c1># Sign CSR</span>
</span></span><span class=line><span class=cl>openssl x509 -extfile &lt;<span class=o>(</span><span class=nb>printf</span> <span class=s2>&#34;extendedKeyUsage = clientAuth&#34;</span><span class=o>)</span> -req -in /tmp/zoro.csr -CA /tmp/customer-ca-2.crt -CAkey /tmp/customer-ca-2.key -CAcreateserial -out /tmp/zoro.crt -days <span class=m>9999</span> -sha256
</span></span></code></pre></div><h3 id=creating-the-kubeconfig-files-for-nami-luffy-and-zoro>Creating the kubeconfig files for Nami, Luffy and Zoro<a hidden class=anchor aria-hidden=true href=#creating-the-kubeconfig-files-for-nami-luffy-and-zoro>#</a></h3><p>Before we start creating the kubeconfig files we need to get the public cert of our API server, this will be used by the kubectl/oc clients in order to trust the API Server certificate.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>export</span> <span class=nv>OPENSHIFT_API_SERVER_ENDPOINT</span><span class=o>=</span>api.cluster.example.com:6443
</span></span><span class=line><span class=cl>openssl s_client -showcerts -connect <span class=si>${</span><span class=nv>OPENSHIFT_API_SERVER_ENDPOINT</span><span class=si>}</span> &lt;/dev/null 2&gt;/dev/null<span class=p>|</span>openssl x509 -outform PEM &gt; /tmp/ocp-apiserver-cert.crt
</span></span></code></pre></div><p>Let&rsquo;s start with <code>Nami's</code> kubeconfig:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>oc --kubeconfig /tmp/nami config set-credentials nami --client-certificate<span class=o>=</span>/tmp/nami.crt --client-key<span class=o>=</span>/tmp/nami.key --embed-certs<span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl>oc --kubeconfig /tmp/nami config set-cluster openshift-cluster-dev --certificate-authority<span class=o>=</span>/tmp/ocp-apiserver-cert.crt --embed-certs<span class=o>=</span><span class=nb>true</span> --server<span class=o>=</span>https://<span class=si>${</span><span class=nv>OPENSHIFT_API_SERVER_ENDPOINT</span><span class=si>}</span>
</span></span><span class=line><span class=cl>oc --kubeconfig /tmp/nami config set-context openshift-dev --cluster<span class=o>=</span>openshift-cluster-dev --namespace<span class=o>=</span>default --user<span class=o>=</span>nami
</span></span><span class=line><span class=cl>oc --kubeconfig /tmp/nami config use-context openshift-dev
</span></span></code></pre></div><p>Now let&rsquo;s do <code>Zoro's</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>oc --kubeconfig /tmp/zoro config set-credentials zoro --client-certificate<span class=o>=</span>/tmp/zoro.crt --client-key<span class=o>=</span>/tmp/zoro.key --embed-certs<span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl>oc --kubeconfig /tmp/zoro config set-cluster openshift-cluster-dev --certificate-authority<span class=o>=</span>/tmp/ocp-apiserver-cert.crt --embed-certs<span class=o>=</span><span class=nb>true</span> --server<span class=o>=</span>https://<span class=si>${</span><span class=nv>OPENSHIFT_API_SERVER_ENDPOINT</span><span class=si>}</span>
</span></span><span class=line><span class=cl>oc --kubeconfig /tmp/zoro config set-context openshift-dev --cluster<span class=o>=</span>openshift-cluster-dev --namespace<span class=o>=</span>default --user<span class=o>=</span>zoro
</span></span><span class=line><span class=cl>oc --kubeconfig /tmp/zoro config use-context openshift-dev
</span></span></code></pre></div><p>And finally <code>Luffy's</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>oc --kubeconfig /tmp/luffy config set-credentials luffy --client-certificate<span class=o>=</span>/tmp/luffy.crt --client-key<span class=o>=</span>/tmp/luffy.key --embed-certs<span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl>oc --kubeconfig /tmp/luffy config set-cluster openshift-cluster-dev --certificate-authority<span class=o>=</span>/tmp/ocp-apiserver-cert.crt --embed-certs<span class=o>=</span><span class=nb>true</span> --server<span class=o>=</span>https://<span class=si>${</span><span class=nv>OPENSHIFT_API_SERVER_ENDPOINT</span><span class=si>}</span>
</span></span><span class=line><span class=cl>oc --kubeconfig /tmp/luffy config set-context openshift-dev --cluster<span class=o>=</span>openshift-cluster-dev --namespace<span class=o>=</span>default --user<span class=o>=</span>luffy
</span></span><span class=line><span class=cl>oc --kubeconfig /tmp/luffy config use-context openshift-dev
</span></span></code></pre></div><h3 id=accessing-our-cluster-with-the-new-kubeconfig-files>Accessing our cluster with the new kubeconfig files:<a hidden class=anchor aria-hidden=true href=#accessing-our-cluster-with-the-new-kubeconfig-files>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>oc --kubeconfig /tmp/luffy whoami
</span></span><span class=line><span class=cl>error: You must be logged in to the server <span class=o>(</span>Unauthorized<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>oc --kubeconfig /tmp/zoro whoami
</span></span><span class=line><span class=cl>error: You must be logged in to the server <span class=o>(</span>Unauthorized<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>oc --kubeconfig /tmp/nami whoami
</span></span><span class=line><span class=cl>nami
</span></span></code></pre></div><p>As you can see from the above output only <code>Nami</code> can access the cluster, but why? - Well, the API Server doesn&rsquo;t trust the self-signed CAs we created. We need to configure it to trust them, let&rsquo;s do it:</p><div class="admonition tip"><p class=admonition-title>Note</p><p class=admonition>Since we have two self-signed CAs and the APIServer only accepts 1 ConfigMap, we need to create a bundle with all the CAs we want to trust when using client certificates authentication. This doesn&rsquo;t include the internal OpenShift CA, which is always trusted.</p></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cat /tmp/customer-ca.crt /tmp/customer-ca-2.crt &gt; /tmp/customer-custom-cas.crt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>oc create configmap customer-cas-custom -n openshift-config --from-file<span class=o>=</span>ca-bundle.crt<span class=o>=</span>/tmp/customer-custom-cas.crt
</span></span></code></pre></div><p>Now that the <code>ConfigMap</code> is ready, let&rsquo;s tell the APIServer to use it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>oc patch apiserver cluster --type<span class=o>=</span>merge -p <span class=s1>&#39;{&#34;spec&#34;: {&#34;clientCA&#34;: {&#34;name&#34;: &#34;customer-cas-custom&#34;}}}&#39;</span>
</span></span></code></pre></div><p>If we try the kubeconfig files again, this is the result:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>oc --kubeconfig /tmp/luffy whoami
</span></span><span class=line><span class=cl>luffy
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>oc --kubeconfig /tmp/zoro whoami
</span></span><span class=line><span class=cl>zoro
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>oc --kubeconfig /tmp/nami whoami
</span></span><span class=line><span class=cl>nami
</span></span></code></pre></div><p>Now all three work, but if we try to do other stuff like listing pods, nodes, etc. we will see that we don&rsquo;t have access to that. That&rsquo;s expected since in a default OCP installation we don&rsquo;t have RBAC rules for the <code>system:admin</code> group:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>oc --kubeconfig /tmp/luffy get nodes
</span></span><span class=line><span class=cl>Error from server <span class=o>(</span>Forbidden<span class=o>)</span>: nodes is forbidden: User <span class=s2>&#34;luffy&#34;</span> cannot list resource <span class=s2>&#34;nodes&#34;</span> in API group <span class=s2>&#34;&#34;</span> at the cluster scope
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>oc --kubeconfig /tmp/zoro -n default get pods
</span></span><span class=line><span class=cl>Error from server <span class=o>(</span>Forbidden<span class=o>)</span>: pods is forbidden: User <span class=s2>&#34;zoro&#34;</span> cannot list resource <span class=s2>&#34;pods&#34;</span> in API group <span class=s2>&#34;&#34;</span> in the namespace <span class=s2>&#34;default&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>oc --kubeconfig /tmp/nami -n default get deployments
</span></span><span class=line><span class=cl>Error from server <span class=o>(</span>Forbidden<span class=o>)</span>: deployments.apps is forbidden: User <span class=s2>&#34;nami&#34;</span> cannot list resource <span class=s2>&#34;deployments&#34;</span> in API group <span class=s2>&#34;apps&#34;</span> in the namespace <span class=s2>&#34;default&#34;</span>
</span></span></code></pre></div><p>Let&rsquo;s configure users in the <code>system:admin</code> group as cluster admins:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>oc adm policy add-cluster-role-to-group cluster-admin system:admin
</span></span></code></pre></div><p>If we try again:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>oc --kubeconfig /tmp/luffy get nodes
</span></span><span class=line><span class=cl>NAME                 STATUS   ROLES           AGE   VERSION
</span></span><span class=line><span class=cl>openshift-master-0   Ready    master,worker   99d   v1.24.0+b62823b
</span></span><span class=line><span class=cl>openshift-master-1   Ready    master,worker   99d   v1.24.0+b62823b
</span></span><span class=line><span class=cl>openshift-master-2   Ready    master,worker   99d   v1.24.0+b62823b
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>oc --kubeconfig /tmp/zoro -n default get pods
</span></span><span class=line><span class=cl>NAME                    READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>test-64ccd87d6c-98j45   1/1     Running   <span class=m>1</span>          4d4h
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>oc --kubeconfig /tmp/nami -n default get deployments
</span></span><span class=line><span class=cl>NAME   READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class=line><span class=cl><span class=nb>test</span>   1/1     <span class=m>1</span>            <span class=m>1</span>           60d
</span></span></code></pre></div><p>That&rsquo;s it! I hope this clears how you can work with client certificates in OpenShift 4.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://linuxera.org/tags/openshift/>openshift</a></li><li><a href=https://linuxera.org/tags/opc/>opc</a></li><li><a href=https://linuxera.org/tags/security/>security</a></li><li><a href=https://linuxera.org/tags/client-certificates/>client-certificates</a></li><li><a href=https://linuxera.org/tags/users/>users</a></li></ul><nav class=paginav><a class=prev href=https://linuxera.org/writing-clis-go-cobra/><span class=title>¬´ Prev</span><br><span>Writing CLIs in Go with Cobra</span></a>
<a class=next href=https://linuxera.org/working-with-pod-security-standards/><span class=title>Next ¬ª</span><br><span>Working with Pod Security Standards</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share OpenShift 4 User Certificates on twitter" href="https://twitter.com/intent/tweet/?text=OpenShift%204%20User%20Certificates&url=https%3a%2f%2flinuxera.org%2fuser-certificates-in-openshift4%2f&hashtags=openshift%2copc%2csecurity%2cclient-certificates%2cusers"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share OpenShift 4 User Certificates on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2flinuxera.org%2fuser-certificates-in-openshift4%2f&title=OpenShift%204%20User%20Certificates&summary=OpenShift%204%20User%20Certificates&source=https%3a%2f%2flinuxera.org%2fuser-certificates-in-openshift4%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></div></footer><div class=share-buttons><p>If this post has been helpful to you, consider <u><a target=_blank href=https://ko-fi.com/mvazce>supporting the work.</a></u></p></div><script src=https://utteranc.es/client.js repo=mvazquezc/mvazquezc.github.io issue-term=pathname label=blog-comments theme=preferred-color-scheme crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://linuxera.org/>Linuxera</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>