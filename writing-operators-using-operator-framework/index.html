<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Writing Operators using the Operator Framework SDK | Linuxera</title><meta name=keywords content="okd,origin,containers,kubernetes,operators,controllers,operator framework,operator sdk,openshift,ocp"><meta name=description content="Operators, operators everywhere As you may have noticed, Kubernetes operators are becoming more an more popular those days. In this post we are going to explain the basics around Operators and we will develop a simple Operator using the Operator Framework SDK.
What is an Operator An operator aims to automate actions usually performed manually while lessening the likelihood of error and simplifying complexity.
We can think of an operator as a method of packaging, deploying and managing a Kubernetes enabled application."><meta name=author content="Mario"><link rel=canonical href=https://linuxera.org/writing-operators-using-operator-framework/><link crossorigin=anonymous href=/assets/css/stylesheet.8cc7ef3cdd44c5188f9267864f378d8dd8892d583e0fd07b5e5321e496f1e4d1.css integrity="sha256-jMfvPN1ExRiPkmeGTzeNjdiJLVg+D9B7XlMh5Jbx5NE=" rel="preload stylesheet" as=style><link rel=icon href=https://linuxera.org/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://linuxera.org/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://linuxera.org/favicon-32x32.png><link rel=apple-touch-icon href=https://linuxera.org/apple-touch-icon.png><link rel=mask-icon href=https://linuxera.org/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-7598JKCK1E"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-7598JKCK1E",{anonymize_ip:!1})}</script><meta property="og:title" content="Writing Operators using the Operator Framework SDK"><meta property="og:description" content="Operators, operators everywhere As you may have noticed, Kubernetes operators are becoming more an more popular those days. In this post we are going to explain the basics around Operators and we will develop a simple Operator using the Operator Framework SDK.
What is an Operator An operator aims to automate actions usually performed manually while lessening the likelihood of error and simplifying complexity.
We can think of an operator as a method of packaging, deploying and managing a Kubernetes enabled application."><meta property="og:type" content="article"><meta property="og:url" content="https://linuxera.org/writing-operators-using-operator-framework/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-05-18T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-13T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Writing Operators using the Operator Framework SDK"><meta name=twitter:description content="Operators, operators everywhere As you may have noticed, Kubernetes operators are becoming more an more popular those days. In this post we are going to explain the basics around Operators and we will develop a simple Operator using the Operator Framework SDK.
What is an Operator An operator aims to automate actions usually performed manually while lessening the likelihood of error and simplifying complexity.
We can think of an operator as a method of packaging, deploying and managing a Kubernetes enabled application."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://linuxera.org/posts/"},{"@type":"ListItem","position":2,"name":"Writing Operators using the Operator Framework SDK","item":"https://linuxera.org/writing-operators-using-operator-framework/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Writing Operators using the Operator Framework SDK","name":"Writing Operators using the Operator Framework SDK","description":"Operators, operators everywhere As you may have noticed, Kubernetes operators are becoming more an more popular those days. In this post we are going to explain the basics around Operators and we will develop a simple Operator using the Operator Framework SDK.\nWhat is an Operator An operator aims to automate actions usually performed manually while lessening the likelihood of error and simplifying complexity.\nWe can think of an operator as a method of packaging, deploying and managing a Kubernetes enabled application.","keywords":["okd","origin","containers","kubernetes","operators","controllers","operator framework","operator sdk","openshift","ocp"],"articleBody":"Operators, operators everywhere As you may have noticed, Kubernetes operators are becoming more an more popular those days. In this post we are going to explain the basics around Operators and we will develop a simple Operator using the Operator Framework SDK.\nWhat is an Operator An operator aims to automate actions usually performed manually while lessening the likelihood of error and simplifying complexity.\nWe can think of an operator as a method of packaging, deploying and managing a Kubernetes enabled application. Kubernetes enabled applications are deployed on Kubernetes and managed using the Kubernetes APIs and tooling.\nKubernetes APIs can be extended in order to enable new types of Kubernetes enabled applications. We could say that Operators are the runtime that manages such applications.\nA simple Operator would define how to deploy an application, whereas an advanced one will also take care of day-2 operations like backup, upgrades, etc.\nOperators use the Controller pattern, but not all Controllers are Operators. We could say it‚Äôs an Operator if it‚Äôs got:\nController Pattern API Extension Single-App Focus Feel free to read more about operators on the Operator FAQ by CoreOS\nKubernetes Controllers In the Kubernetes world, the Controllers take care of routine tasks to ensure cluster‚Äôs observed state, matches cluster‚Äôs desired state.\nEach Controller is responsible for a particular resource in Kubernetes. The Controller runs a control loop that watches the shared state of the cluster through the Kubernetes API server and makes changes attempting to move the current state towards the desired state.\nSome examples:\nReplication Controller Cronjob Controller Controller Components There are two main components in a controller: Informer/SharedInformer and WorkQueue.\nInformer In order to retrieve information about an object, the Controller sends a request to the Kubernetes API server. However, querying the API repeatedly can become expensive when dealing with thousands of objects.\nOn top of that, the Controller doesn‚Äôt really need to send requests continuously. It only cares about CRUD events happening on the objects it‚Äôs managing.\nInformers are not much used in the current Kubernetes, instead SharedInformers are used.\nSharedInformer A Informer creates a local cache for a set of resources used by itself. In Kubernetes there are multiple controllers running and caring about multiple kinds of resources though.\nHaving a shared cache among Controllers instead of one cache for each Controller sounds like a plan, that‚Äôs a SharedInformer.\nWorkQueue The SharedInformer can‚Äôt track what each Controller is up to, so the Controller must provide its own queuing and retrying mechanism.\nWhenever a resource changes, the SharedInformer‚Äôs Event Handler puts a key into the WorkQueue so the Controller will take care of that change.\nHow a Controller Works Control Loop Every controller has a Control Loop which basically does:\nProcesses every single item from the WorkQueue Pops an item and do whatever it needs to do with that item Pushes the item back to the WorkQueue if required Updates the item status to reflect the new changes Starts over Code Examples\nhttps://github.com/kubernetes/sample-controller/blob/release-1.18/controller.go#L180 https://github.com/kubernetes/sample-controller/blob/release-1.18/controller.go#L187 WorkQueue Stuff is put into the WorkQueue Stuff is take out from the WorkQueue in the Control Loop WorkQueue doesn‚Äôt store objects, it stores MetaNamespaceKeys A MetaNamespaceKey is a key-value reference for an object. It has the namespace for the resource and the name for the resource.\nCode Examples\nhttps://github.com/kubernetes/sample-controller/blob/release-1.18/controller.go#L111 https://github.com/kubernetes/sample-controller/blob/release-1.18/controller.go#L187 SharedInformer As we said before, is a shared data cache which distributes the data to all the Listers interested in knowing about changes happening to specific objects.\nThe most important part of the SharedInformer are the EventHandlers. Using an EventHandler is how you register your interest in specific object updates like addition, creation, updation or deletion.\nWhen an update occurs, the object will be put into the WorkQueue so it gets processed by the Controller in the Control Loop.\nListers are an important part of the SharedInformers as well. Listers are designed specifically to be used within Controllers as they have access to the cache.\nListers vs Client-go\nListers have access to the cache whereas Client-go will hit the Kubernetes API server (which is expensive when dealing with thousands of objects).\nCode Examples\nhttps://github.com/kubernetes/sample-controller/blob/release-1.18/controller.go#L252 https://github.com/kubernetes/sample-controller/blob/release-1.18/controller.go#L274 SyncHandler A.K.A Reconciliation Loop The first invocation of the SyncHandler will always be getting the MetaNamespaceKey for the resource it needs to work with.\nWith the MetaNamespaceKey the object is gathered from the cache, but well.. it‚Äôs not really an object, but a pointer to the cached object.\nWith the object reference we can read the object, in case the object needs to be updated, then the object have to be DeepCopied. DeepCopy is an expensive operation, making sure the object will be modified before calling DeepCopy is a good practice.\nWith the object reference / DeepCopy we are ready to apply our business logic.\nCode Examples\nhttps://github.com/kubernetes/sample-controller/blob/release-1.18/controller.go#L243 Kubernetes Controllers Some information about controllers:\nCronjob controller is probably the smallest one out there Sample Controller will help you getting started with Kubernetes Controllers Writing your very first Operator using the Operator Framework SDK We will create a very simple Operator using the Operator Framework SDK.\nThe Operator will be in charge of deploying a simple GoLang application.\nRequirements At the moment of this writing the following versions were used:\ngolang-1.19.5 Operator Framework SDK v1.26.1 Kubernetes 1.24 Installing the Operator Framework SDK RELEASE_VERSION=v1.26.1 # Linux sudo curl -L https://github.com/operator-framework/operator-sdk/releases/download/${RELEASE_VERSION}/operator-sdk_linux_amd64 -o /usr/local/bin/operator-sdk sudo chmod +x /usr/local/bin/operator-sdk Initializing the Operator Project First, a new new project for our Operator will be initialized.\nmkdir -p ~/operators-projects/reverse-words-operator \u0026\u0026 cd $_ export GO111MODULE=on export GOPROXY=https://proxy.golang.org export GH_USER= operator-sdk init --domain=linuxera.org --repo=github.com/$GH_USER/reverse-words-operator Create the Operator API Types As previously discussed, Operators extend the Kubernetes API, the API itself is organized in groups and versions. Our Operator will define a new Group, object Kind and its versioning.\nIn the example below we will define a new API Group called apps under domain linuxera.org, a new object Kind ReverseWordsApp and its versioning v1alpha1.\noperator-sdk create api --group=apps --version=v1alpha1 --kind=ReverseWordsApp --resource=true --controller=true Now it‚Äôs time to define the structure of our new Object. The Spec properties that we will be using are:\nreplicas: Will be used to define the number of replicas for our application appVersion: Will be used to define which version of the application is deployed In the Status we will use:\nappPods: Will track the pods associated to our current ReverseWordsApp instance Different conditions Below the code for our Types:\n/* Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License. You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0 Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License. */ package v1alpha1 import ( metav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\" ) // ReverseWordsAppSpec defines the desired state of ReverseWordsApp type ReverseWordsAppSpec struct { Replicas int32 `json:\"replicas\"` AppVersion string `json:\"appVersion,omitempty\"` } // ReverseWordsAppStatus defines the observed state of ReverseWordsApp type ReverseWordsAppStatus struct { AppPods []string `json:\"appPods\"` Conditions []metav1.Condition `json:\"conditions\"` } // +kubebuilder:object:root=true // +kubebuilder:subresource:status // ReverseWordsApp is the Schema for the reversewordsapps API type ReverseWordsApp struct { metav1.TypeMeta `json:\",inline\"` metav1.ObjectMeta `json:\"metadata,omitempty\"` Spec ReverseWordsAppSpec `json:\"spec,omitempty\"` Status ReverseWordsAppStatus `json:\"status,omitempty\"` } // +kubebuilder:object:root=true // ReverseWordsAppList contains a list of ReverseWordsApp type ReverseWordsAppList struct { metav1.TypeMeta `json:\",inline\"` metav1.ListMeta `json:\"metadata,omitempty\"` Items []ReverseWordsApp `json:\"items\"` } func init() { SchemeBuilder.Register(\u0026ReverseWordsApp{}, \u0026ReverseWordsAppList{}) } // Conditions const ( // ConditionTypeReverseWordsDeploymentNotReady indicates if the Reverse Words Deployment is not ready ConditionTypeReverseWordsDeploymentNotReady string = \"ReverseWordsDeploymentNotReady\" // ConditionTypeReady indicates if the Reverse Words Deployment is ready ConditionTypeReady string = \"Ready\" ) You can download the Types file:\ncurl -Ls https://linuxera.org/writing-operators-using-operator-framework/reversewordsapp_types.go -o ~/operators-projects/reverse-words-operator/api/v1alpha1/reversewordsapp_types.go Replicas will be defined as an int32 and will reference the Spec property replicas. For the status AppPods will be defined as a stringList and will reference the Status property appPods.\nWith above changes in-place we need to add new dependencies and re-generate some boilerplate code to take into account the latest changes in our types.\ngo mod tidy make manifests make generate Code your Operator business logic An empty controller (well, not that empty) has been created into our project, now it‚Äôs time to modify it so it actually deploys our application the way we want.\nOur application consists of a Deployment and a Service, so our Operator will deploy the Reverse Words App as follows:\nA Kubernetes Deployment object will be created A Kubernetes Service object will be created Below code (commented) for our Controller:\n/* Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License. You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0 Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License. */ package controllers import ( \"context\" \"reflect\" \"github.com/go-logr/logr\" appsv1alpha1 \"github.com/mvazquezc/reverse-words-operator/api/v1alpha1\" appsv1 \"k8s.io/api/apps/v1\" corev1 \"k8s.io/api/core/v1\" \"k8s.io/apimachinery/pkg/api/errors\" \"k8s.io/apimachinery/pkg/api/meta\" metav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\" \"k8s.io/apimachinery/pkg/runtime\" \"k8s.io/apimachinery/pkg/types\" \"k8s.io/apimachinery/pkg/util/intstr\" ctrl \"sigs.k8s.io/controller-runtime\" \"sigs.k8s.io/controller-runtime/pkg/client\" \"sigs.k8s.io/controller-runtime/pkg/controller\" \"sigs.k8s.io/controller-runtime/pkg/controller/controllerutil\" \"sigs.k8s.io/controller-runtime/pkg/event\" ctrllog \"sigs.k8s.io/controller-runtime/pkg/log\" \"sigs.k8s.io/controller-runtime/pkg/predicate\" ) // ReverseWordsAppReconciler reconciles a ReverseWordsApp object type ReverseWordsAppReconciler struct { client.Client Scheme *runtime.Scheme } const ( // Finalizer for our objects reverseWordsAppFinalizer = \"finalizer.reversewordsapp.apps.linuxera.org\" concurrentReconciles = 10 ) // +kubebuilder:rbac:groups=apps.linuxera.org,resources=reversewordsapps,verbs=get;list;watch;create;update;patch;delete // +kubebuilder:rbac:groups=apps.linuxera.org,resources=reversewordsapps/status,verbs=get;update;patch // +kubebuilder:rbac:groups=apps.linuxera.org,resources=reversewordsapps/finalizers,verbs=get;update;patch // +kubebuilder:rbac:groups=apps,resources=deployments,verbs=get;list;watch;create;update;patch;delete // +kubebuilder:rbac:groups=core,resources=services,verbs=get;list;watch;create;update;patch;delete // +kubebuilder:rbac:groups=core,resources=pods,verbs=get;list;watch // +kubebuilder:rbac:groups=core,resources=events,verbs=create;patch func (r *ReverseWordsAppReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) { log := ctrllog.FromContext(ctx) // Fetch the ReverseWordsApp instance instance := \u0026appsv1alpha1.ReverseWordsApp{} err := r.Get(ctx, req.NamespacedName, instance) if err != nil { if errors.IsNotFound(err) { // Request object not found, could have been deleted after reconcile request. // Owned objects are automatically garbage collected. For additional cleanup logic use finalizers. // Return and don't requeue log.Info(\"ReverseWordsApp resource not found. Ignoring since object must be deleted\") return ctrl.Result{}, nil } // Error reading the object - requeue the request. log.Error(err, \"Failed to get ReverseWordsApp\") return ctrl.Result{}, err } // Check if the CR is marked to be deleted isInstanceMarkedToBeDeleted := instance.GetDeletionTimestamp() != nil if isInstanceMarkedToBeDeleted { log.Info(\"Instance marked for deletion, running finalizers\") if contains(instance.GetFinalizers(), reverseWordsAppFinalizer) { // Run the finalizer logic err := r.finalizeReverseWordsApp(log, instance) if err != nil { // Don't remove the finalizer if we failed to finalize the object return ctrl.Result{}, err } log.Info(\"Instance finalizers completed\") // Remove finalizer once the finalizer logic has run controllerutil.RemoveFinalizer(instance, reverseWordsAppFinalizer) err = r.Update(ctx, instance) if err != nil { // If the object update fails, requeue return ctrl.Result{}, err } } log.Info(\"Instance can be deleted now\") return ctrl.Result{}, nil } // Add Finalizers to the CR if !contains(instance.GetFinalizers(), reverseWordsAppFinalizer) { if err := r.addFinalizer(log, instance); err != nil { return ctrl.Result{}, err } } // Reconcile Deployment object result, err := r.reconcileDeployment(instance, log) if err != nil { return result, err } // Reconcile Service object result, err = r.reconcileService(instance, log) if err != nil { return result, err } // The CR status is updated in the Deployment reconcile method return ctrl.Result{}, nil } func (r *ReverseWordsAppReconciler) SetupWithManager(mgr ctrl.Manager) error { return ctrl.NewControllerManagedBy(mgr). For(\u0026appsv1alpha1.ReverseWordsApp{}). Owns(\u0026appsv1.Deployment{}). Owns(\u0026corev1.Service{}). WithEventFilter(ignoreDeletionPredicate()). // Filter events that do not increase generation id, like status updates WithOptions(controller.Options{MaxConcurrentReconciles: concurrentReconciles}). // run multiple reconcile loops in parallel Complete(r) } func (r *ReverseWordsAppReconciler) reconcileDeployment(cr *appsv1alpha1.ReverseWordsApp, log logr.Logger) (ctrl.Result, error) { // Define a new Deployment object deployment := newDeploymentForCR(cr) // Set ReverseWordsApp instance as the owner and controller of the Deployment if err := ctrl.SetControllerReference(cr, deployment, r.Scheme); err != nil { return ctrl.Result{}, err } // Check if this Deployment already exists deploymentFound := \u0026appsv1.Deployment{} err := r.Get(context.Background(), types.NamespacedName{Name: deployment.Name, Namespace: deployment.Namespace}, deploymentFound) if err != nil \u0026\u0026 errors.IsNotFound(err) { log.Info(\"Creating a new Deployment\", \"Deployment.Namespace\", deployment.Namespace, \"Deployment.Name\", deployment.Name) err = r.Create(context.Background(), deployment) if err != nil { return ctrl.Result{}, err } // Requeue the object to update its status return ctrl.Result{Requeue: true}, nil } else if err != nil { return ctrl.Result{}, err } else { // Deployment already exists log.Info(\"Deployment already exists\", \"Deployment.Namespace\", deploymentFound.Namespace, \"Deployment.Name\", deploymentFound.Name) } // Ensure deployment replicas match the desired state if !reflect.DeepEqual(deploymentFound.Spec.Replicas, deployment.Spec.Replicas) { log.Info(\"Current deployment replicas do not match ReverseWordsApp configured Replicas\") // Update the replicas err = r.Update(context.Background(), deployment) if err != nil { log.Error(err, \"Failed to update Deployment.\", \"Deployment.Namespace\", deploymentFound.Namespace, \"Deployment.Name\", deploymentFound.Name) return ctrl.Result{}, err } } // Ensure deployment container image match the desired state, returns true if deployment needs to be updated if checkDeploymentImage(deploymentFound, deployment) { log.Info(\"Current deployment image version do not match ReverseWordsApp configured version\") // Update the image err = r.Update(context.Background(), deployment) if err != nil { log.Error(err, \"Failed to update Deployment.\", \"Deployment.Namespace\", deploymentFound.Namespace, \"Deployment.Name\", deploymentFound.Name) return ctrl.Result{}, err } } // Check if the deployment is ready deploymentReady := isDeploymentReady(deploymentFound) // Create list options for listing deployment pods podList := \u0026corev1.PodList{} listOpts := []client.ListOption{ client.InNamespace(deploymentFound.Namespace), client.MatchingLabels(deploymentFound.Labels), } // List the pods for this ReverseWordsApp deployment err = r.List(context.Background(), podList, listOpts...) if err != nil { log.Error(err, \"Failed to list Pods.\", \"Deployment.Namespace\", deploymentFound.Namespace, \"Deployment.Name\", deploymentFound.Name) return ctrl.Result{}, err } // Get running Pods from listing above (if any) podNames := getRunningPodNames(podList.Items) if deploymentReady { // Update the status to ready cr.Status.AppPods = podNames meta.SetStatusCondition(\u0026cr.Status.Conditions, metav1.Condition{Type: appsv1alpha1.ConditionTypeReverseWordsDeploymentNotReady, Status: metav1.ConditionFalse, Reason: appsv1alpha1.ConditionTypeReverseWordsDeploymentNotReady}) meta.SetStatusCondition(\u0026cr.Status.Conditions, metav1.Condition{Type: appsv1alpha1.ConditionTypeReady, Status: metav1.ConditionTrue, Reason: appsv1alpha1.ConditionTypeReady}) } else { // Update the status to not ready cr.Status.AppPods = podNames meta.SetStatusCondition(\u0026cr.Status.Conditions, metav1.Condition{Type: appsv1alpha1.ConditionTypeReverseWordsDeploymentNotReady, Status: metav1.ConditionTrue, Reason: appsv1alpha1.ConditionTypeReverseWordsDeploymentNotReady}) meta.SetStatusCondition(\u0026cr.Status.Conditions, metav1.Condition{Type: appsv1alpha1.ConditionTypeReady, Status: metav1.ConditionFalse, Reason: appsv1alpha1.ConditionTypeReady}) } // Reconcile the new status for the instance cr, err = r.updateReverseWordsAppStatus(cr, log) if err != nil { log.Error(err, \"Failed to update ReverseWordsApp Status.\") return ctrl.Result{}, err } // Deployment reconcile finished return ctrl.Result{}, nil } // updateReverseWordsAppStatus updates the Status of a given CR func (r *ReverseWordsAppReconciler) updateReverseWordsAppStatus(cr *appsv1alpha1.ReverseWordsApp, log logr.Logger) (*appsv1alpha1.ReverseWordsApp, error) { reverseWordsApp := \u0026appsv1alpha1.ReverseWordsApp{} err := r.Get(context.Background(), types.NamespacedName{Name: cr.Name, Namespace: cr.Namespace}, reverseWordsApp) if err != nil { return reverseWordsApp, err } if !reflect.DeepEqual(cr.Status, reverseWordsApp.Status) { log.Info(\"Updating ReverseWordsApp Status.\") // We need to update the status err = r.Status().Update(context.Background(), cr) if err != nil { return cr, err } updatedReverseWordsApp := \u0026appsv1alpha1.ReverseWordsApp{} err = r.Get(context.Background(), types.NamespacedName{Name: cr.Name, Namespace: cr.Namespace}, updatedReverseWordsApp) if err != nil { return cr, err } cr = updatedReverseWordsApp.DeepCopy() } return cr, nil } // addFinalizer adds a given finalizer to a given CR func (r *ReverseWordsAppReconciler) addFinalizer(log logr.Logger, cr *appsv1alpha1.ReverseWordsApp) error { log.Info(\"Adding Finalizer for the ReverseWordsApp\") controllerutil.AddFinalizer(cr, reverseWordsAppFinalizer) // Update CR err := r.Update(context.Background(), cr) if err != nil { log.Error(err, \"Failed to update ReverseWordsApp with finalizer\") return err } return nil } // finalizeReverseWordsApp runs required tasks before deleting the objects owned by the CR func (r *ReverseWordsAppReconciler) finalizeReverseWordsApp(log logr.Logger, cr *appsv1alpha1.ReverseWordsApp) error { // TODO(user): Add the cleanup steps that the operator // needs to do before the CR can be deleted. Examples // of finalizers include performing backups and deleting // resources that are not owned by this CR, like a PVC. log.Info(\"Successfully finalized ReverseWordsApp\") return nil } func (r *ReverseWordsAppReconciler) reconcileService(cr *appsv1alpha1.ReverseWordsApp, log logr.Logger) (ctrl.Result, error) { // Define a new Service object service := newServiceForCR(cr) // Set ReverseWordsApp instance as the owner and controller of the Service if err := controllerutil.SetControllerReference(cr, service, r.Scheme); err != nil { return ctrl.Result{}, err } // Check if this Service already exists serviceFound := \u0026corev1.Service{} err := r.Get(context.Background(), types.NamespacedName{Name: service.Name, Namespace: service.Namespace}, serviceFound) if err != nil \u0026\u0026 errors.IsNotFound(err) { log.Info(\"Creating a new Service\", \"Service.Namespace\", service.Namespace, \"Service.Name\", service.Name) err = r.Create(context.Background(), service) if err != nil { return ctrl.Result{}, err } // Service created successfully - don't requeue return ctrl.Result{}, nil } else if err != nil { return ctrl.Result{}, err } else { // Service already exists log.Info(\"Service already exists\", \"Service.Namespace\", serviceFound.Namespace, \"Service.Name\", serviceFound.Name) } // Service reconcile finished return ctrl.Result{}, nil } // Returns a new deployment without replicas configured // replicas will be configured in the sync loop func newDeploymentForCR(cr *appsv1alpha1.ReverseWordsApp) *appsv1.Deployment { labels := map[string]string{ \"app\": cr.Name, } replicas := cr.Spec.Replicas // Minimum replicas will be 1 if replicas == 0 { replicas = 1 } appVersion := \"latest\" if cr.Spec.AppVersion != \"\" { appVersion = cr.Spec.AppVersion } // TODO:Check if application version exists containerImage := \"quay.io/mavazque/reversewords:\" + appVersion probe := \u0026corev1.Probe{ ProbeHandler: corev1.ProbeHandler{ HTTPGet: \u0026corev1.HTTPGetAction{ Path: \"/health\", Port: intstr.FromInt(8080), }, }, InitialDelaySeconds: 5, TimeoutSeconds: 2, PeriodSeconds: 15, } return \u0026appsv1.Deployment{ TypeMeta: metav1.TypeMeta{ APIVersion: \"apps/v1\", Kind: \"Deployment\", }, ObjectMeta: metav1.ObjectMeta{ Name: \"dp-\" + cr.Name, Namespace: cr.Namespace, Labels: labels, }, Spec: appsv1.DeploymentSpec{ Replicas: \u0026replicas, Selector: \u0026metav1.LabelSelector{ MatchLabels: labels, }, Template: corev1.PodTemplateSpec{ ObjectMeta: metav1.ObjectMeta{ Labels: labels, }, Spec: corev1.PodSpec{ Containers: []corev1.Container{ { Image: containerImage, Name: \"reversewords\", Ports: []corev1.ContainerPort{ { ContainerPort: 8080, Name: \"reversewords\", }, }, LivenessProbe: probe, ReadinessProbe: probe, }, }, }, }, }, } } // Returns a new service func newServiceForCR(cr *appsv1alpha1.ReverseWordsApp) *corev1.Service { labels := map[string]string{ \"app\": cr.Name, } return \u0026corev1.Service{ TypeMeta: metav1.TypeMeta{ APIVersion: \"v1\", Kind: \"Service\", }, ObjectMeta: metav1.ObjectMeta{ Name: \"service-\" + cr.Name, Namespace: cr.Namespace, Labels: labels, }, Spec: corev1.ServiceSpec{ Type: corev1.ServiceTypeLoadBalancer, Selector: labels, Ports: []corev1.ServicePort{ { Name: \"http\", Port: 8080, }, }, }, } } // isDeploymentReady returns a true bool if the deployment has all its pods ready func isDeploymentReady(deployment *appsv1.Deployment) bool { configuredReplicas := deployment.Status.Replicas readyReplicas := deployment.Status.ReadyReplicas deploymentReady := false if configuredReplicas == readyReplicas { deploymentReady = true } return deploymentReady } // getRunningPodNames returns the pod names for the pods running in the array of pods passed in func getRunningPodNames(pods []corev1.Pod) []string { // Create an empty []string, so if no podNames are returned, instead of nil we get an empty slice var podNames []string = make([]string, 0) for _, pod := range pods { if pod.GetObjectMeta().GetDeletionTimestamp() != nil { continue } if pod.Status.Phase == corev1.PodPending || pod.Status.Phase == corev1.PodRunning { podNames = append(podNames, pod.Name) } } return podNames } // checkDeploymentImage returns wether the deployment image is different or not func checkDeploymentImage(current *appsv1.Deployment, desired *appsv1.Deployment) bool { for _, curr := range current.Spec.Template.Spec.Containers { for _, des := range desired.Spec.Template.Spec.Containers { // Only compare the images of containers with the same name if curr.Name == des.Name { if curr.Image != des.Image { return true } } } } return false } // contains returns true if a string is found on a slice func contains(list []string, s string) bool { for _, v := range list { if v == s { return true } } return false } // Ignore changes that do not increase the resource generation func ignoreDeletionPredicate() predicate.Predicate { return predicate.Funcs{ UpdateFunc: func(e event.UpdateEvent) bool { // Ignore updates to CR status in which case metadata.Generation does not change return e.ObjectOld.GetGeneration() != e.ObjectNew.GetGeneration() }, DeleteFunc: func(e event.DeleteEvent) bool { // Evaluates to false if the object has been confirmed deleted. return !e.DeleteStateUnknown }, } } You can download the controller code, remember to change the GitHub ID before bulding the operator:\n# Remember to change import: appsv1alpha1 \"github.com/mvazquezc/reverse-words-operator/api/v1alpha1\" curl -Ls https://linuxera.org/writing-operators-using-operator-framework/reversewordsapp_controller.go -o ~/operators-projects/reverse-words-operator/controllers/reversewordsapp_controller.go Setup Watch namespaces By default, the controller will watch all namespaces, in this case we want it to watch only the namespace where it runs, in order to do so we need to update the controller options in the main.go file.\n/* Copyright 2021. Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License. You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0 Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License. */ package main import ( \"flag\" \"fmt\" \"os\" // Import all Kubernetes client auth plugins (e.g. Azure, GCP, OIDC, etc.) // to ensure that exec-entrypoint and run can make use of them. _ \"k8s.io/client-go/plugin/pkg/client/auth\" \"k8s.io/apimachinery/pkg/runtime\" utilruntime \"k8s.io/apimachinery/pkg/util/runtime\" clientgoscheme \"k8s.io/client-go/kubernetes/scheme\" ctrl \"sigs.k8s.io/controller-runtime\" \"sigs.k8s.io/controller-runtime/pkg/healthz\" \"sigs.k8s.io/controller-runtime/pkg/log/zap\" appsv1alpha1 \"github.com/mvazquezc/reverse-words-operator/api/v1alpha1\" \"github.com/mvazquezc/reverse-words-operator/controllers\" //+kubebuilder:scaffold:imports ) var ( scheme = runtime.NewScheme() setupLog = ctrl.Log.WithName(\"setup\") ) func init() { utilruntime.Must(clientgoscheme.AddToScheme(scheme)) utilruntime.Must(appsv1alpha1.AddToScheme(scheme)) //+kubebuilder:scaffold:scheme } func main() { var metricsAddr string var enableLeaderElection bool var probeAddr string flag.StringVar(\u0026metricsAddr, \"metrics-bind-address\", \":8080\", \"The address the metric endpoint binds to.\") flag.StringVar(\u0026probeAddr, \"health-probe-bind-address\", \":8081\", \"The address the probe endpoint binds to.\") flag.BoolVar(\u0026enableLeaderElection, \"leader-elect\", false, \"Enable leader election for controller manager. \"+ \"Enabling this will ensure there is only one active controller manager.\") opts := zap.Options{ Development: true, } opts.BindFlags(flag.CommandLine) flag.Parse() ctrl.SetLogger(zap.New(zap.UseFlagOptions(\u0026opts))) watchNamespace, err := getWatchNamespace() mgr, err := ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options{ Scheme: scheme, MetricsBindAddress: metricsAddr, Port: 9443, HealthProbeBindAddress: probeAddr, LeaderElection: enableLeaderElection, LeaderElectionID: \"1ef59d40.linuxera.org\", Namespace: watchNamespace, // namespaced-scope when the value is not an empty string }) if err != nil { setupLog.Error(err, \"unable to start manager\") os.Exit(1) } if err = (\u0026controllers.ReverseWordsAppReconciler{ Client: mgr.GetClient(), Scheme: mgr.GetScheme(), }).SetupWithManager(mgr); err != nil { setupLog.Error(err, \"unable to create controller\", \"controller\", \"ReverseWordsApp\") os.Exit(1) } //+kubebuilder:scaffold:builder if err := mgr.AddHealthzCheck(\"healthz\", healthz.Ping); err != nil { setupLog.Error(err, \"unable to set up health check\") os.Exit(1) } if err := mgr.AddReadyzCheck(\"readyz\", healthz.Ping); err != nil { setupLog.Error(err, \"unable to set up ready check\") os.Exit(1) } setupLog.Info(\"starting manager\") if err := mgr.Start(ctrl.SetupSignalHandler()); err != nil { setupLog.Error(err, \"problem running manager\") os.Exit(1) } } // getWatchNamespace returns the Namespace the operator should be watching for changes func getWatchNamespace() (string, error) { // WatchNamespaceEnvVar is the constant for env variable WATCH_NAMESPACE // which specifies the Namespace to watch. // An empty value means the operator is running with cluster scope. var watchNamespaceEnvVar = \"WATCH_NAMESPACE\" ns, found := os.LookupEnv(watchNamespaceEnvVar) if !found { return \"\", fmt.Errorf(\"%s must be set\", watchNamespaceEnvVar) } return ns, nil } You can download the main.go, remember to change the GitHub ID before bulding the operator:\n# Remember to change import: appsv1alpha1 \"github.com/mvazquezc/reverse-words-operator/api/v1alpha1\" curl -Ls https://linuxera.org/writing-operators-using-operator-framework/main.go -o ~/operators-projects/reverse-words-operator/main.go Specify permissions and generate RBAC manifests Our controller needs some RBAC permissions to interact with the resources it manages. These has been specified via RBAC Markers in our controller code:\n// +kubebuilder:rbac:groups=apps.linuxera.org,resources=reversewordsapps,verbs=get;list;watch;create;update;patch;delete // +kubebuilder:rbac:groups=apps.linuxera.org,resources=reversewordsapps/status,verbs=get;update;patch // +kubebuilder:rbac:groups=apps.linuxera.org,resources=reversewordsapps/finalizers,verbs=get;update;patch // +kubebuilder:rbac:groups=apps,resources=deployments,verbs=get;list;watch;create;update;patch;delete // +kubebuilder:rbac:groups=core,resources=services,verbs=get;list;watch;create;update;patch;delete // +kubebuilder:rbac:groups=core,resources=pods,verbs=get;list;watch // +kubebuilder:rbac:groups=core,resources=events,verbs=create;patch func (r *ReverseWordsAppReconciler) Reconcile(req ctrl.Request) (ctrl.Result, error) { The ClusterRole manifest at config/rbac/role.yaml is generated from the above markers via controller-gen with the following command:\ngo mod tidy make manifests Build the Operator First, we will build the operator and once the image is built, we will push it to the Quay Registry.\nBefore we start building the operator, we need access to a Kubernetes cluster. If you don‚Äôt have one you can use Kind, Minikube or my prefered one, KCli\nIn order to get a local cluster with KCli, just run this command:\nkcli create kube generic -P ctlplanes=1 -P workers=1 -P ctlplane_memory=4096 -P numcpus=2 -P worker_memory=4096 -P sdn=calico -P version=1.24 -P ingress=true -P ingress_method=nginx -P metallb=true -P domain=linuxera.org operatorscluster Now that we have the cluster up and running we will build and push the operator.\nNOTE: If you use podman instead of docker you can edit the Makefile and change docker commands by podman commands\nexport USERNAME= make docker-build docker-push IMG=quay.io/$USERNAME/reversewords-operator:v0.0.1 Deploy the Operator Create the required CRDs in the cluster\nmake install Deploy the operator\nNOTE: While developing you can run the operator locally (you need a valid kubeconfig) by running make run\nIn order to deploy the different operator pieces, Kustomize is used. There is a Kustomization file (~/operators-projects/reverse-words-operator/config/default/kustomization.yaml) where you can define some defaults for your operator, like the namePrefix for the different objects or the namespace where it will be deployed.\nEdit the default kustomization file ~/operators-projects/reverse-words-operator/config/default/kustomization.yaml and specify the namespace where your operator should run by modifying the namespace property\nexport NAMESPACE=operators-test sed -i \"s/namespace: .*/namespace: $NAMESPACE/g\" ~/operators-projects/reverse-words-operator/config/default/kustomization.yaml Create the namespace and Deploy the operator\nkubectl create ns $NAMESPACE export USERNAME= make deploy IMG=quay.io/$USERNAME/reversewords-operator:v0.0.1 Patch the controller deployment so it only watches the namespace where it‚Äôs running\nkubectl -n $NAMESPACE patch deployment reverse-words-operator-controller-manager -p '{\"spec\":{\"template\":{\"spec\":{\"$setElementOrder/containers\":[{\"name\":\"kube-rbac-proxy\"},{\"name\":\"manager\"}],\"containers\":[{\"env\":[{\"name\":\"WATCH_NAMESPACE\",\"valueFrom\":{\"fieldRef\":{\"fieldPath\":\"metadata.namespace\"}}}],\"name\":\"manager\"}]}}}}' We should see our operator pod up and running\n1.676311934753094e+09\tINFO\tcontroller-runtime.metrics\tMetrics server is starting to listen\t{\"addr\": \"127.0.0.\t1:8080\"} 1.6763119347534144e+09\tINFO\tsetup\tstarting manager I0213 18:12:14.753860 1 leaderelection.go:248] attempting to acquire leader lease operators-test/1ef59d40.\tlinuxera.org... 1.6763119347538702e+09\tINFO\tStarting server\t{\"kind\": \"health probe\", \"addr\": \"[::]:8081\"} 1.6763119347539454e+09\tINFO\tStarting server\t{\"path\": \"/metrics\", \"kind\": \"metrics\", \"addr\": \"127.0.0.1:8080\"} I0213 18:12:37.253145 1 leaderelection.go:258] successfully acquired lease operators-test/1ef59d40.linuxera.org 1.6763119572531986e+09\tDEBUG\tevents\treverse-words-operator-controller-manager-755f55cffc-9wprb_028ea174-80b7-4294-abfb-1d1aae892cd7 became leader\t{\"type\": \"Normal\", \"object\": {\"kind\":\"Lease\",\"namespace\":\"operators-test\",\"name\":\"1ef59d40.linuxera.org\",\t\"uid\":\"ae3f7dff-1624-47b2-9010-c666d559473d\",\"apiVersion\":\"coordination.k8s.io/v1\",\"resourceVersion\":\"11102046\"}, \"reason\": \"LeaderElection\"} 1.6763119572534668e+09\tINFO\tStarting EventSource\t{\"controller\": \"reversewordsapp\", \"controllerGroup\": \"apps.\tlinuxera.org\", \"controllerKind\": \"ReverseWordsApp\", \"source\": \"kind source: *v1alpha1.ReverseWordsApp\"} 1.6763119572535148e+09\tINFO\tStarting EventSource\t{\"controller\": \"reversewordsapp\", \"controllerGroup\": \"apps.\tlinuxera.org\", \"controllerKind\": \"ReverseWordsApp\", \"source\": \"kind source: *v1.Deployment\"} 1.6763119572535224e+09\tINFO\tStarting EventSource\t{\"controller\": \"reversewordsapp\", \"controllerGroup\": \"apps.\tlinuxera.org\", \"controllerKind\": \"ReverseWordsApp\", \"source\": \"kind source: *v1.Service\"} 1.6763119572535274e+09\tINFO\tStarting Controller\t{\"controller\": \"reversewordsapp\", \"controllerGroup\": \"apps.\tlinuxera.org\", \"controllerKind\": \"ReverseWordsApp\"} 1.6763119573569405e+09\tINFO\tStarting workers\t{\"controller\": \"reversewordsapp\", \"controllerGroup\": \"apps.\tlinuxera.org\", \"controllerKind\": \"ReverseWordsApp\", \"worker count\": 10} Now it‚Äôs time to create ReverseWordsApp instances\ncat \u003c","wordCount":"4302","inLanguage":"en","datePublished":"2019-05-18T00:00:00Z","dateModified":"2023-02-13T00:00:00Z","author":{"@type":"Person","name":"Mario"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://linuxera.org/writing-operators-using-operator-framework/"},"publisher":{"@type":"Organization","name":"Linuxera","logo":{"@type":"ImageObject","url":"https://linuxera.org/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://linuxera.org/ accesskey=h title="Linuxera (Alt + H)">Linuxera</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://linuxera.org/ title="üè† Home"><span>üè† Home</span></a></li><li><a href=https://linuxera.org/archives/ title="üóÑÔ∏è Archive"><span>üóÑÔ∏è Archive</span></a></li><li><a href=https://linuxera.org/search/ title="üîé Search"><span>üîé Search</span></a></li><li><a href=https://linuxera.org/tags/ title="üè∑Ô∏è Tags"><span>üè∑Ô∏è Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://linuxera.org/>Home</a>&nbsp;¬ª&nbsp;<a href=https://linuxera.org/posts/>Posts</a></div><h1 class=post-title>Writing Operators using the Operator Framework SDK</h1><div class=post-meta><span title='2019-05-18 00:00:00 +0000 UTC'>Published on May 18, 2019</span>&nbsp;¬∑&nbsp;<span title='2023-02-13 00:00:00 +0000 UTC'>Last updated on February 13, 2023</span>&nbsp;¬∑&nbsp;21 min&nbsp;¬∑&nbsp;Mario</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#operators-operators-everywhere aria-label="Operators, operators everywhere">Operators, operators everywhere</a><ul><li><a href=#what-is-an-operator aria-label="What is an Operator">What is an Operator</a></li></ul></li><li><a href=#kubernetes-controllers aria-label="Kubernetes Controllers">Kubernetes Controllers</a><ul><li><a href=#controller-components aria-label="Controller Components">Controller Components</a><ul><li><a href=#informer aria-label=Informer>Informer</a></li><li><a href=#sharedinformer aria-label=SharedInformer>SharedInformer</a></li><li><a href=#workqueue aria-label=WorkQueue>WorkQueue</a></li></ul></li><li><a href=#how-a-controller-works aria-label="How a Controller Works">How a Controller Works</a><ul><li><a href=#control-loop aria-label="Control Loop">Control Loop</a></li><li><a href=#workqueue-1 aria-label=WorkQueue>WorkQueue</a></li><li><a href=#sharedinformer-1 aria-label=SharedInformer>SharedInformer</a></li></ul></li><li><a href=#synchandler-aka-reconciliation-loop aria-label="SyncHandler A.K.A Reconciliation Loop">SyncHandler A.K.A Reconciliation Loop</a></li><li><a href=#kubernetes-controllers-1 aria-label="Kubernetes Controllers">Kubernetes Controllers</a></li></ul></li><li><a href=#writing-your-very-first-operator-using-the-operator-framework-sdk aria-label="Writing your very first Operator using the Operator Framework SDK">Writing your very first Operator using the Operator Framework SDK</a><ul><li><a href=#requirements aria-label=Requirements>Requirements</a></li><li><a href=#installing-the-operator-framework-sdk aria-label="Installing the Operator Framework SDK">Installing the Operator Framework SDK</a></li><li><a href=#initializing-the-operator-project aria-label="Initializing the Operator Project">Initializing the Operator Project</a></li><li><a href=#create-the-operator-api-types aria-label="Create the Operator API Types">Create the Operator API Types</a></li><li><a href=#code-your-operator-business-logic aria-label="Code your Operator business logic">Code your Operator business logic</a></li><li><a href=#setup-watch-namespaces aria-label="Setup Watch namespaces">Setup Watch namespaces</a></li><li><a href=#specify-permissions-and-generate-rbac-manifests aria-label="Specify permissions and generate RBAC manifests">Specify permissions and generate RBAC manifests</a></li><li><a href=#build-the-operator aria-label="Build the Operator">Build the Operator</a></li><li><a href=#deploy-the-operator aria-label="Deploy the Operator">Deploy the Operator</a></li></ul></li><li><a href=#in-the-next-episode aria-label="In the next episode:">In the next episode:</a></li><li><a href=#sources aria-label=Sources>Sources</a></li></ul></div></details></div><div class=post-content><h1 id=operators-operators-everywhere>Operators, operators everywhere<a hidden class=anchor aria-hidden=true href=#operators-operators-everywhere>#</a></h1><p>As you may have noticed, <strong>Kubernetes operators</strong> are becoming more an more popular those days. In this post we are going to explain the basics around Operators and we will develop a simple Operator using the <strong>Operator Framework SDK</strong>.</p><h2 id=what-is-an-operator>What is an Operator<a hidden class=anchor aria-hidden=true href=#what-is-an-operator>#</a></h2><p>An operator aims to automate actions usually performed manually while lessening the likelihood of error and simplifying complexity.</p><p>We can think of an operator as a method of packaging, deploying and managing a Kubernetes enabled application. Kubernetes enabled applications are deployed on Kubernetes and managed using the Kubernetes APIs and tooling.</p><p>Kubernetes APIs can be extended in order to enable new types of Kubernetes enabled applications. We could say that Operators are the runtime that manages such applications.</p><p>A simple Operator would define how to deploy an application, whereas an advanced one will also take care of day-2 operations like backup, upgrades, etc.</p><p>Operators use the <strong>Controller pattern</strong>, but not all Controllers are Operators. We could say it&rsquo;s an Operator if it&rsquo;s got:</p><ul><li>Controller Pattern</li><li>API Extension</li><li>Single-App Focus</li></ul><p>Feel free to read more about operators on the <a href=https://coreos.com/operators/>Operator FAQ by CoreOS</a></p><h1 id=kubernetes-controllers>Kubernetes Controllers<a hidden class=anchor aria-hidden=true href=#kubernetes-controllers>#</a></h1><p>In the Kubernetes world, the <strong>Controllers</strong> take care of routine tasks to ensure cluster&rsquo;s observed state, matches cluster&rsquo;s desired state.</p><p>Each Controller is responsible for a particular resource in Kubernetes. The Controller runs a control loop that watches the shared state of the cluster through the Kubernetes API server and makes changes attempting to move the current state towards the desired state.</p><p>Some examples:</p><ul><li>Replication Controller</li><li>Cronjob Controller</li></ul><h2 id=controller-components>Controller Components<a hidden class=anchor aria-hidden=true href=#controller-components>#</a></h2><p>There are two main components in a controller: <code>Informer/SharedInformer</code> and <code>WorkQueue</code>.</p><h3 id=informer>Informer<a hidden class=anchor aria-hidden=true href=#informer>#</a></h3><p>In order to retrieve information about an object, the Controller sends a request to the Kubernetes API server. However, querying the API repeatedly can become expensive when dealing with thousands of objects.</p><p>On top of that, the Controller doesn&rsquo;t really need to send requests continuously. It only cares about CRUD events happening on the objects it&rsquo;s managing.</p><p>Informers are not much used in the current Kubernetes, instead SharedInformers are used.</p><h3 id=sharedinformer>SharedInformer<a hidden class=anchor aria-hidden=true href=#sharedinformer>#</a></h3><p>A Informer creates a local cache for a set of resources used by itself. In Kubernetes there are multiple controllers running and caring about multiple kinds of resources though.</p><p>Having a shared cache among Controllers instead of one cache for each Controller sounds like a plan, that&rsquo;s a SharedInformer.</p><h3 id=workqueue>WorkQueue<a hidden class=anchor aria-hidden=true href=#workqueue>#</a></h3><p>The <code>SharedInformer</code> can&rsquo;t track what each Controller is up to, so the Controller must provide its own queuing and retrying mechanism.</p><p>Whenever a resource changes, the SharedInformer&rsquo;s Event Handler puts a key into the <code>WorkQueue</code> so the Controller will take care of that change.</p><h2 id=how-a-controller-works>How a Controller Works<a hidden class=anchor aria-hidden=true href=#how-a-controller-works>#</a></h2><h3 id=control-loop>Control Loop<a hidden class=anchor aria-hidden=true href=#control-loop>#</a></h3><p>Every controller has a <strong>Control Loop</strong> which basically does:</p><ol><li>Processes every single item from the WorkQueue</li><li>Pops an item and do whatever it needs to do with that item</li><li>Pushes the item back to the WorkQueue if required</li><li>Updates the item status to reflect the new changes</li><li>Starts over</li></ol><p><strong>Code Examples</strong></p><ul><li><a href=https://github.com/kubernetes/sample-controller/blob/release-1.18/controller.go#L180>https://github.com/kubernetes/sample-controller/blob/release-1.18/controller.go#L180</a></li><li><a href=https://github.com/kubernetes/sample-controller/blob/release-1.18/controller.go#L187>https://github.com/kubernetes/sample-controller/blob/release-1.18/controller.go#L187</a></li></ul><h3 id=workqueue-1>WorkQueue<a hidden class=anchor aria-hidden=true href=#workqueue-1>#</a></h3><ol><li>Stuff is put into the WorkQueue</li><li>Stuff is take out from the WorkQueue in the Control Loop</li><li>WorkQueue doesn&rsquo;t store objects, it stores <code>MetaNamespaceKeys</code></li></ol><p>A MetaNamespaceKey is a key-value reference for an object. It has the namespace for the resource and the name for the resource.</p><p><strong>Code Examples</strong></p><ul><li><a href=https://github.com/kubernetes/sample-controller/blob/release-1.18/controller.go#L111>https://github.com/kubernetes/sample-controller/blob/release-1.18/controller.go#L111</a></li><li><a href=https://github.com/kubernetes/sample-controller/blob/release-1.18/controller.go#L187>https://github.com/kubernetes/sample-controller/blob/release-1.18/controller.go#L187</a></li></ul><h3 id=sharedinformer-1>SharedInformer<a hidden class=anchor aria-hidden=true href=#sharedinformer-1>#</a></h3><p>As we said before, is a shared data cache which distributes the data to all the <code>Listers</code> interested in knowing about changes happening to specific objects.</p><p>The most important part of the <code>SharedInformer</code> are the <code>EventHandlers</code>. Using an <code>EventHandler</code> is how you register your interest in specific object updates like addition, creation, updation or deletion.</p><p>When an update occurs, the object will be put into the WorkQueue so it gets processed by the Controller in the Control Loop.</p><p><code>Listers</code> are an important part of the <code>SharedInformers</code> as well. <code>Listers</code> are designed specifically to be used within Controllers as they have access to the cache.</p><p><strong>Listers vs Client-go</strong></p><p>Listers have access to the cache whereas Client-go will hit the Kubernetes API server (which is expensive when dealing with thousands of objects).</p><p><strong>Code Examples</strong></p><ul><li><a href=https://github.com/kubernetes/sample-controller/blob/release-1.18/controller.go#L252>https://github.com/kubernetes/sample-controller/blob/release-1.18/controller.go#L252</a></li><li><a href=https://github.com/kubernetes/sample-controller/blob/release-1.18/controller.go#L274>https://github.com/kubernetes/sample-controller/blob/release-1.18/controller.go#L274</a></li></ul><h2 id=synchandler-aka-reconciliation-loop>SyncHandler A.K.A Reconciliation Loop<a hidden class=anchor aria-hidden=true href=#synchandler-aka-reconciliation-loop>#</a></h2><p>The first invocation of the <code>SyncHandler</code> will always be getting the <code>MetaNamespaceKey</code> for the resource it needs to work with.</p><p>With the <code>MetaNamespaceKey</code> the object is gathered from the cache, but well.. it&rsquo;s not really an object, but a pointer to the cached object.</p><p>With the object reference we can read the object, in case the object needs to be updated, then the object have to be DeepCopied. <code>DeepCopy</code> is an expensive operation, making sure the object will be modified before calling <code>DeepCopy</code> is a good practice.</p><p>With the object reference / DeepCopy we are ready to apply our business logic.</p><p><strong>Code Examples</strong></p><ul><li><a href=https://github.com/kubernetes/sample-controller/blob/release-1.18/controller.go#L243>https://github.com/kubernetes/sample-controller/blob/release-1.18/controller.go#L243</a></li></ul><h2 id=kubernetes-controllers-1>Kubernetes Controllers<a hidden class=anchor aria-hidden=true href=#kubernetes-controllers-1>#</a></h2><p>Some information about controllers:</p><ul><li>Cronjob controller is probably the smallest one out there</li><li><a href=https://github.com/kubernetes/sample-controller>Sample Controller</a> will help you getting started with Kubernetes Controllers</li></ul><h1 id=writing-your-very-first-operator-using-the-operator-framework-sdk>Writing your very first Operator using the Operator Framework SDK<a hidden class=anchor aria-hidden=true href=#writing-your-very-first-operator-using-the-operator-framework-sdk>#</a></h1><p>We will create a very simple Operator using the <a href=https://github.com/operator-framework/operator-sdk>Operator Framework SDK</a>.</p><p>The Operator will be in charge of deploying a simple <a href=https://github.com/mvazquezc/reverse-words>GoLang application</a>.</p><h2 id=requirements>Requirements<a hidden class=anchor aria-hidden=true href=#requirements>#</a></h2><p>At the moment of this writing the following versions were used:</p><ul><li>golang-1.19.5</li><li>Operator Framework SDK v1.26.1</li><li>Kubernetes 1.24</li></ul><h2 id=installing-the-operator-framework-sdk>Installing the Operator Framework SDK<a hidden class=anchor aria-hidden=true href=#installing-the-operator-framework-sdk>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nv>RELEASE_VERSION</span><span class=o>=</span>v1.26.1
</span></span><span class=line><span class=cl><span class=c1># Linux</span>
</span></span><span class=line><span class=cl>sudo curl -L https://github.com/operator-framework/operator-sdk/releases/download/<span class=si>${</span><span class=nv>RELEASE_VERSION</span><span class=si>}</span>/operator-sdk_linux_amd64 -o /usr/local/bin/operator-sdk
</span></span><span class=line><span class=cl>sudo chmod +x /usr/local/bin/operator-sdk
</span></span></code></pre></div><h2 id=initializing-the-operator-project>Initializing the Operator Project<a hidden class=anchor aria-hidden=true href=#initializing-the-operator-project>#</a></h2><p>First, a new new project for our Operator will be initialized.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>mkdir -p ~/operators-projects/reverse-words-operator <span class=o>&amp;&amp;</span> <span class=nb>cd</span> <span class=nv>$_</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GO111MODULE</span><span class=o>=</span>on
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GOPROXY</span><span class=o>=</span>https://proxy.golang.org
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GH_USER</span><span class=o>=</span>&lt;github_user&gt;
</span></span><span class=line><span class=cl>operator-sdk init --domain<span class=o>=</span>linuxera.org --repo<span class=o>=</span>github.com/<span class=nv>$GH_USER</span>/reverse-words-operator
</span></span></code></pre></div><h2 id=create-the-operator-api-types>Create the Operator API Types<a hidden class=anchor aria-hidden=true href=#create-the-operator-api-types>#</a></h2><p>As previously discussed, Operators extend the Kubernetes API, the API itself is organized in groups and versions. Our Operator will define a new Group, object Kind and its versioning.</p><p>In the example below we will define a new API Group called <code>apps</code> under domain <code>linuxera.org</code>, a new object Kind <code>ReverseWordsApp</code> and its versioning <code>v1alpha1</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>operator-sdk create api --group<span class=o>=</span>apps --version<span class=o>=</span>v1alpha1 --kind<span class=o>=</span>ReverseWordsApp --resource<span class=o>=</span><span class=nb>true</span> --controller<span class=o>=</span><span class=nb>true</span>
</span></span></code></pre></div><p>Now it&rsquo;s time to define the structure of our new Object. The Spec properties that we will be using are:</p><ul><li><code>replicas</code>: Will be used to define the number of replicas for our application</li><li><code>appVersion</code>: Will be used to define which version of the application is deployed</li></ul><p>In the Status we will use:</p><ul><li><code>appPods</code>: Will track the pods associated to our current ReverseWordsApp instance</li><li>Different conditions</li></ul><p>Below the code for our Types:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
</span></span></span><span class=line><span class=cl><span class=cm>you may not use this file except in compliance with the License.
</span></span></span><span class=line><span class=cl><span class=cm>You may obtain a copy of the License at
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>    http://www.apache.org/licenses/LICENSE-2.0
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>Unless required by applicable law or agreed to in writing, software
</span></span></span><span class=line><span class=cl><span class=cm>distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span></span></span><span class=line><span class=cl><span class=cm>WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span></span></span><span class=line><span class=cl><span class=cm>See the License for the specific language governing permissions and
</span></span></span><span class=line><span class=cl><span class=cm>limitations under the License.
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>package</span> <span class=nx>v1alpha1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>metav1</span> <span class=s>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ReverseWordsAppSpec defines the desired state of ReverseWordsApp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>ReverseWordsAppSpec</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Replicas</span>   <span class=kt>int32</span>  <span class=s>`json:&#34;replicas&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>AppVersion</span> <span class=kt>string</span> <span class=s>`json:&#34;appVersion,omitempty&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ReverseWordsAppStatus defines the observed state of ReverseWordsApp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>ReverseWordsAppStatus</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>AppPods</span>    <span class=p>[]</span><span class=kt>string</span>           <span class=s>`json:&#34;appPods&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Conditions</span> <span class=p>[]</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>Condition</span> <span class=s>`json:&#34;conditions&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// +kubebuilder:object:root=true
</span></span></span><span class=line><span class=cl><span class=c1>// +kubebuilder:subresource:status
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// ReverseWordsApp is the Schema for the reversewordsapps API
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>ReverseWordsApp</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>metav1</span><span class=p>.</span><span class=nx>TypeMeta</span>   <span class=s>`json:&#34;,inline&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span> <span class=s>`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>Spec</span>   <span class=nx>ReverseWordsAppSpec</span>   <span class=s>`json:&#34;spec,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Status</span> <span class=nx>ReverseWordsAppStatus</span> <span class=s>`json:&#34;status,omitempty&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// +kubebuilder:object:root=true
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// ReverseWordsAppList contains a list of ReverseWordsApp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>ReverseWordsAppList</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>metav1</span><span class=p>.</span><span class=nx>TypeMeta</span> <span class=s>`json:&#34;,inline&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>metav1</span><span class=p>.</span><span class=nx>ListMeta</span> <span class=s>`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Items</span>           <span class=p>[]</span><span class=nx>ReverseWordsApp</span> <span class=s>`json:&#34;items&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>SchemeBuilder</span><span class=p>.</span><span class=nf>Register</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>ReverseWordsApp</span><span class=p>{},</span> <span class=o>&amp;</span><span class=nx>ReverseWordsAppList</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Conditions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ConditionTypeReverseWordsDeploymentNotReady indicates if the Reverse Words Deployment is not ready
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>ConditionTypeReverseWordsDeploymentNotReady</span> <span class=kt>string</span> <span class=p>=</span> <span class=s>&#34;ReverseWordsDeploymentNotReady&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// ConditionTypeReady indicates if the Reverse Words Deployment is ready
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ConditionTypeReady</span> <span class=kt>string</span> <span class=p>=</span> <span class=s>&#34;Ready&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>You can download the Types file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>curl -Ls https://linuxera.org/writing-operators-using-operator-framework/reversewordsapp_types.go -o ~/operators-projects/reverse-words-operator/api/v1alpha1/reversewordsapp_types.go
</span></span></code></pre></div><p>Replicas will be defined as an <code>int32</code> and will reference the Spec property <code>replicas</code>. For the status AppPods will be defined as a <code>stringList</code> and will reference the Status property <code>appPods</code>.</p><p>With above changes in-place we need to add new dependencies and re-generate some boilerplate code to take into account the latest changes in our types.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>go mod tidy
</span></span><span class=line><span class=cl>make manifests
</span></span><span class=line><span class=cl>make generate
</span></span></code></pre></div><h2 id=code-your-operator-business-logic>Code your Operator business logic<a hidden class=anchor aria-hidden=true href=#code-your-operator-business-logic>#</a></h2><p>An empty controller (well, not that empty) has been created into our project, now it&rsquo;s time to modify it so it actually deploys our application the way we want.</p><p>Our application consists of a Deployment and a Service, so our Operator will deploy the Reverse Words App as follows:</p><ol><li>A Kubernetes Deployment object will be created</li><li>A Kubernetes Service object will be created</li></ol><p>Below code (commented) for our Controller:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
</span></span></span><span class=line><span class=cl><span class=cm>you may not use this file except in compliance with the License.
</span></span></span><span class=line><span class=cl><span class=cm>You may obtain a copy of the License at
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>    http://www.apache.org/licenses/LICENSE-2.0
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>Unless required by applicable law or agreed to in writing, software
</span></span></span><span class=line><span class=cl><span class=cm>distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span></span></span><span class=line><span class=cl><span class=cm>WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span></span></span><span class=line><span class=cl><span class=cm>See the License for the specific language governing permissions and
</span></span></span><span class=line><span class=cl><span class=cm>limitations under the License.
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>package</span> <span class=nx>controllers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;reflect&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/go-logr/logr&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>appsv1alpha1</span> <span class=s>&#34;github.com/mvazquezc/reverse-words-operator/api/v1alpha1&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>appsv1</span> <span class=s>&#34;k8s.io/api/apps/v1&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>corev1</span> <span class=s>&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/apimachinery/pkg/api/errors&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/apimachinery/pkg/api/meta&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>metav1</span> <span class=s>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/apimachinery/pkg/types&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/apimachinery/pkg/util/intstr&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctrl</span> <span class=s>&#34;sigs.k8s.io/controller-runtime&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;sigs.k8s.io/controller-runtime/pkg/client&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;sigs.k8s.io/controller-runtime/pkg/controller&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;sigs.k8s.io/controller-runtime/pkg/controller/controllerutil&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;sigs.k8s.io/controller-runtime/pkg/event&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctrllog</span> <span class=s>&#34;sigs.k8s.io/controller-runtime/pkg/log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;sigs.k8s.io/controller-runtime/pkg/predicate&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ReverseWordsAppReconciler reconciles a ReverseWordsApp object
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>ReverseWordsAppReconciler</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>client</span><span class=p>.</span><span class=nx>Client</span>
</span></span><span class=line><span class=cl>	<span class=nx>Scheme</span> <span class=o>*</span><span class=nx>runtime</span><span class=p>.</span><span class=nx>Scheme</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Finalizer for our objects
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>reverseWordsAppFinalizer</span> <span class=p>=</span> <span class=s>&#34;finalizer.reversewordsapp.apps.linuxera.org&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>concurrentReconciles</span>     <span class=p>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// +kubebuilder:rbac:groups=apps.linuxera.org,resources=reversewordsapps,verbs=get;list;watch;create;update;patch;delete
</span></span></span><span class=line><span class=cl><span class=c1>// +kubebuilder:rbac:groups=apps.linuxera.org,resources=reversewordsapps/status,verbs=get;update;patch
</span></span></span><span class=line><span class=cl><span class=c1>// +kubebuilder:rbac:groups=apps.linuxera.org,resources=reversewordsapps/finalizers,verbs=get;update;patch
</span></span></span><span class=line><span class=cl><span class=c1>// +kubebuilder:rbac:groups=apps,resources=deployments,verbs=get;list;watch;create;update;patch;delete
</span></span></span><span class=line><span class=cl><span class=c1>// +kubebuilder:rbac:groups=core,resources=services,verbs=get;list;watch;create;update;patch;delete
</span></span></span><span class=line><span class=cl><span class=c1>// +kubebuilder:rbac:groups=core,resources=pods,verbs=get;list;watch
</span></span></span><span class=line><span class=cl><span class=c1>// +kubebuilder:rbac:groups=core,resources=events,verbs=create;patch
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>ReverseWordsAppReconciler</span><span class=p>)</span> <span class=nf>Reconcile</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>(</span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span> <span class=o>:=</span> <span class=nx>ctrllog</span><span class=p>.</span><span class=nf>FromContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Fetch the ReverseWordsApp instance
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>instance</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>appsv1alpha1</span><span class=p>.</span><span class=nx>ReverseWordsApp</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>,</span> <span class=nx>instance</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>IsNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Request object not found, could have been deleted after reconcile request.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// Owned objects are automatically garbage collected. For additional cleanup logic use finalizers.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// Return and don&#39;t requeue
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>log</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;ReverseWordsApp resource not found. Ignoring since object must be deleted&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Error reading the object - requeue the request.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>log</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Failed to get ReverseWordsApp&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Check if the CR is marked to be deleted
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>isInstanceMarkedToBeDeleted</span> <span class=o>:=</span> <span class=nx>instance</span><span class=p>.</span><span class=nf>GetDeletionTimestamp</span><span class=p>()</span> <span class=o>!=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>isInstanceMarkedToBeDeleted</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Instance marked for deletion, running finalizers&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nf>contains</span><span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nf>GetFinalizers</span><span class=p>(),</span> <span class=nx>reverseWordsAppFinalizer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Run the finalizer logic
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>finalizeReverseWordsApp</span><span class=p>(</span><span class=nx>log</span><span class=p>,</span> <span class=nx>instance</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Don&#39;t remove the finalizer if we failed to finalize the object
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Instance finalizers completed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Remove finalizer once the finalizer logic has run
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>controllerutil</span><span class=p>.</span><span class=nf>RemoveFinalizer</span><span class=p>(</span><span class=nx>instance</span><span class=p>,</span> <span class=nx>reverseWordsAppFinalizer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>err</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>instance</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// If the object update fails, requeue
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Instance can be deleted now&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Add Finalizers to the CR
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>!</span><span class=nf>contains</span><span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nf>GetFinalizers</span><span class=p>(),</span> <span class=nx>reverseWordsAppFinalizer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>addFinalizer</span><span class=p>(</span><span class=nx>log</span><span class=p>,</span> <span class=nx>instance</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Reconcile Deployment object
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>result</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>reconcileDeployment</span><span class=p>(</span><span class=nx>instance</span><span class=p>,</span> <span class=nx>log</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Reconcile Service object
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>result</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>reconcileService</span><span class=p>(</span><span class=nx>instance</span><span class=p>,</span> <span class=nx>log</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// The CR status is updated in the Deployment reconcile method
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>ReverseWordsAppReconciler</span><span class=p>)</span> <span class=nf>SetupWithManager</span><span class=p>(</span><span class=nx>mgr</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Manager</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nf>NewControllerManagedBy</span><span class=p>(</span><span class=nx>mgr</span><span class=p>).</span>
</span></span><span class=line><span class=cl>		<span class=nf>For</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>appsv1alpha1</span><span class=p>.</span><span class=nx>ReverseWordsApp</span><span class=p>{}).</span>
</span></span><span class=line><span class=cl>		<span class=nf>Owns</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>{}).</span>
</span></span><span class=line><span class=cl>		<span class=nf>Owns</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Service</span><span class=p>{}).</span>
</span></span><span class=line><span class=cl>		<span class=nf>WithEventFilter</span><span class=p>(</span><span class=nf>ignoreDeletionPredicate</span><span class=p>()).</span>                                     <span class=c1>// Filter events that do not increase generation id, like status updates
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nf>WithOptions</span><span class=p>(</span><span class=nx>controller</span><span class=p>.</span><span class=nx>Options</span><span class=p>{</span><span class=nx>MaxConcurrentReconciles</span><span class=p>:</span> <span class=nx>concurrentReconciles</span><span class=p>}).</span> <span class=c1>// run multiple reconcile loops in parallel
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nf>Complete</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>ReverseWordsAppReconciler</span><span class=p>)</span> <span class=nf>reconcileDeployment</span><span class=p>(</span><span class=nx>cr</span> <span class=o>*</span><span class=nx>appsv1alpha1</span><span class=p>.</span><span class=nx>ReverseWordsApp</span><span class=p>,</span> <span class=nx>log</span> <span class=nx>logr</span><span class=p>.</span><span class=nx>Logger</span><span class=p>)</span> <span class=p>(</span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Define a new Deployment object
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>deployment</span> <span class=o>:=</span> <span class=nf>newDeploymentForCR</span><span class=p>(</span><span class=nx>cr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Set ReverseWordsApp instance as the owner and controller of the Deployment
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nf>SetControllerReference</span><span class=p>(</span><span class=nx>cr</span><span class=p>,</span> <span class=nx>deployment</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Scheme</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Check if this Deployment already exists
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>deploymentFound</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>types</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>deployment</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>Namespace</span><span class=p>:</span> <span class=nx>deployment</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>},</span> <span class=nx>deploymentFound</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>IsNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Creating a new Deployment&#34;</span><span class=p>,</span> <span class=s>&#34;Deployment.Namespace&#34;</span><span class=p>,</span> <span class=nx>deployment</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=s>&#34;Deployment.Name&#34;</span><span class=p>,</span> <span class=nx>deployment</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>deployment</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Requeue the object to update its status
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{</span><span class=nx>Requeue</span><span class=p>:</span> <span class=kc>true</span><span class=p>},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Deployment already exists
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>log</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Deployment already exists&#34;</span><span class=p>,</span> <span class=s>&#34;Deployment.Namespace&#34;</span><span class=p>,</span> <span class=nx>deploymentFound</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=s>&#34;Deployment.Name&#34;</span><span class=p>,</span> <span class=nx>deploymentFound</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Ensure deployment replicas match the desired state
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>!</span><span class=nx>reflect</span><span class=p>.</span><span class=nf>DeepEqual</span><span class=p>(</span><span class=nx>deploymentFound</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=p>,</span> <span class=nx>deployment</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Current deployment replicas do not match ReverseWordsApp configured Replicas&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Update the replicas
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>err</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>deployment</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Failed to update Deployment.&#34;</span><span class=p>,</span> <span class=s>&#34;Deployment.Namespace&#34;</span><span class=p>,</span> <span class=nx>deploymentFound</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=s>&#34;Deployment.Name&#34;</span><span class=p>,</span> <span class=nx>deploymentFound</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Ensure deployment container image match the desired state, returns true if deployment needs to be updated
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nf>checkDeploymentImage</span><span class=p>(</span><span class=nx>deploymentFound</span><span class=p>,</span> <span class=nx>deployment</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Current deployment image version do not match ReverseWordsApp configured version&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Update the image
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>err</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>deployment</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Failed to update Deployment.&#34;</span><span class=p>,</span> <span class=s>&#34;Deployment.Namespace&#34;</span><span class=p>,</span> <span class=nx>deploymentFound</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=s>&#34;Deployment.Name&#34;</span><span class=p>,</span> <span class=nx>deploymentFound</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Check if the deployment is ready
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>deploymentReady</span> <span class=o>:=</span> <span class=nf>isDeploymentReady</span><span class=p>(</span><span class=nx>deploymentFound</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Create list options for listing deployment pods
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>podList</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>PodList</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>listOpts</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>client</span><span class=p>.</span><span class=nx>ListOption</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>client</span><span class=p>.</span><span class=nf>InNamespace</span><span class=p>(</span><span class=nx>deploymentFound</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>client</span><span class=p>.</span><span class=nf>MatchingLabels</span><span class=p>(</span><span class=nx>deploymentFound</span><span class=p>.</span><span class=nx>Labels</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// List the pods for this ReverseWordsApp deployment
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>List</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>podList</span><span class=p>,</span> <span class=nx>listOpts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Failed to list Pods.&#34;</span><span class=p>,</span> <span class=s>&#34;Deployment.Namespace&#34;</span><span class=p>,</span> <span class=nx>deploymentFound</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=s>&#34;Deployment.Name&#34;</span><span class=p>,</span> <span class=nx>deploymentFound</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Get running Pods from listing above (if any)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>podNames</span> <span class=o>:=</span> <span class=nf>getRunningPodNames</span><span class=p>(</span><span class=nx>podList</span><span class=p>.</span><span class=nx>Items</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>deploymentReady</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Update the status to ready
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>cr</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>AppPods</span> <span class=p>=</span> <span class=nx>podNames</span>
</span></span><span class=line><span class=cl>		<span class=nx>meta</span><span class=p>.</span><span class=nf>SetStatusCondition</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>cr</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Conditions</span><span class=p>,</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>Condition</span><span class=p>{</span><span class=nx>Type</span><span class=p>:</span> <span class=nx>appsv1alpha1</span><span class=p>.</span><span class=nx>ConditionTypeReverseWordsDeploymentNotReady</span><span class=p>,</span> <span class=nx>Status</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ConditionFalse</span><span class=p>,</span> <span class=nx>Reason</span><span class=p>:</span> <span class=nx>appsv1alpha1</span><span class=p>.</span><span class=nx>ConditionTypeReverseWordsDeploymentNotReady</span><span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=nx>meta</span><span class=p>.</span><span class=nf>SetStatusCondition</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>cr</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Conditions</span><span class=p>,</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>Condition</span><span class=p>{</span><span class=nx>Type</span><span class=p>:</span> <span class=nx>appsv1alpha1</span><span class=p>.</span><span class=nx>ConditionTypeReady</span><span class=p>,</span> <span class=nx>Status</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ConditionTrue</span><span class=p>,</span> <span class=nx>Reason</span><span class=p>:</span> <span class=nx>appsv1alpha1</span><span class=p>.</span><span class=nx>ConditionTypeReady</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Update the status to not ready
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>cr</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>AppPods</span> <span class=p>=</span> <span class=nx>podNames</span>
</span></span><span class=line><span class=cl>		<span class=nx>meta</span><span class=p>.</span><span class=nf>SetStatusCondition</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>cr</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Conditions</span><span class=p>,</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>Condition</span><span class=p>{</span><span class=nx>Type</span><span class=p>:</span> <span class=nx>appsv1alpha1</span><span class=p>.</span><span class=nx>ConditionTypeReverseWordsDeploymentNotReady</span><span class=p>,</span> <span class=nx>Status</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ConditionTrue</span><span class=p>,</span> <span class=nx>Reason</span><span class=p>:</span> <span class=nx>appsv1alpha1</span><span class=p>.</span><span class=nx>ConditionTypeReverseWordsDeploymentNotReady</span><span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=nx>meta</span><span class=p>.</span><span class=nf>SetStatusCondition</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>cr</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Conditions</span><span class=p>,</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>Condition</span><span class=p>{</span><span class=nx>Type</span><span class=p>:</span> <span class=nx>appsv1alpha1</span><span class=p>.</span><span class=nx>ConditionTypeReady</span><span class=p>,</span> <span class=nx>Status</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ConditionFalse</span><span class=p>,</span> <span class=nx>Reason</span><span class=p>:</span> <span class=nx>appsv1alpha1</span><span class=p>.</span><span class=nx>ConditionTypeReady</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Reconcile the new status for the instance
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cr</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>updateReverseWordsAppStatus</span><span class=p>(</span><span class=nx>cr</span><span class=p>,</span> <span class=nx>log</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Failed to update ReverseWordsApp Status.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Deployment reconcile finished
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// updateReverseWordsAppStatus updates the Status of a given CR
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>ReverseWordsAppReconciler</span><span class=p>)</span> <span class=nf>updateReverseWordsAppStatus</span><span class=p>(</span><span class=nx>cr</span> <span class=o>*</span><span class=nx>appsv1alpha1</span><span class=p>.</span><span class=nx>ReverseWordsApp</span><span class=p>,</span> <span class=nx>log</span> <span class=nx>logr</span><span class=p>.</span><span class=nx>Logger</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>appsv1alpha1</span><span class=p>.</span><span class=nx>ReverseWordsApp</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>reverseWordsApp</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>appsv1alpha1</span><span class=p>.</span><span class=nx>ReverseWordsApp</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>types</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>cr</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>Namespace</span><span class=p>:</span> <span class=nx>cr</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>},</span> <span class=nx>reverseWordsApp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>reverseWordsApp</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>reflect</span><span class=p>.</span><span class=nf>DeepEqual</span><span class=p>(</span><span class=nx>cr</span><span class=p>.</span><span class=nx>Status</span><span class=p>,</span> <span class=nx>reverseWordsApp</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Updating ReverseWordsApp Status.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=c1>// We need to update the status
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>err</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Status</span><span class=p>().</span><span class=nf>Update</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>cr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>cr</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>updatedReverseWordsApp</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>appsv1alpha1</span><span class=p>.</span><span class=nx>ReverseWordsApp</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>types</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>cr</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>Namespace</span><span class=p>:</span> <span class=nx>cr</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>},</span> <span class=nx>updatedReverseWordsApp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>cr</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>cr</span> <span class=p>=</span> <span class=nx>updatedReverseWordsApp</span><span class=p>.</span><span class=nf>DeepCopy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>cr</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// addFinalizer adds a given finalizer to a given CR
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>ReverseWordsAppReconciler</span><span class=p>)</span> <span class=nf>addFinalizer</span><span class=p>(</span><span class=nx>log</span> <span class=nx>logr</span><span class=p>.</span><span class=nx>Logger</span><span class=p>,</span> <span class=nx>cr</span> <span class=o>*</span><span class=nx>appsv1alpha1</span><span class=p>.</span><span class=nx>ReverseWordsApp</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Adding Finalizer for the ReverseWordsApp&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>controllerutil</span><span class=p>.</span><span class=nf>AddFinalizer</span><span class=p>(</span><span class=nx>cr</span><span class=p>,</span> <span class=nx>reverseWordsAppFinalizer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Update CR
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>cr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Failed to update ReverseWordsApp with finalizer&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// finalizeReverseWordsApp runs required tasks before deleting the objects owned by the CR
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>ReverseWordsAppReconciler</span><span class=p>)</span> <span class=nf>finalizeReverseWordsApp</span><span class=p>(</span><span class=nx>log</span> <span class=nx>logr</span><span class=p>.</span><span class=nx>Logger</span><span class=p>,</span> <span class=nx>cr</span> <span class=o>*</span><span class=nx>appsv1alpha1</span><span class=p>.</span><span class=nx>ReverseWordsApp</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// TODO(user): Add the cleanup steps that the operator
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// needs to do before the CR can be deleted. Examples
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// of finalizers include performing backups and deleting
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// resources that are not owned by this CR, like a PVC.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>log</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Successfully finalized ReverseWordsApp&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>ReverseWordsAppReconciler</span><span class=p>)</span> <span class=nf>reconcileService</span><span class=p>(</span><span class=nx>cr</span> <span class=o>*</span><span class=nx>appsv1alpha1</span><span class=p>.</span><span class=nx>ReverseWordsApp</span><span class=p>,</span> <span class=nx>log</span> <span class=nx>logr</span><span class=p>.</span><span class=nx>Logger</span><span class=p>)</span> <span class=p>(</span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Define a new Service object
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>service</span> <span class=o>:=</span> <span class=nf>newServiceForCR</span><span class=p>(</span><span class=nx>cr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Set ReverseWordsApp instance as the owner and controller of the Service
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>controllerutil</span><span class=p>.</span><span class=nf>SetControllerReference</span><span class=p>(</span><span class=nx>cr</span><span class=p>,</span> <span class=nx>service</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Scheme</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Check if this Service already exists
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>serviceFound</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Service</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>types</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>service</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>Namespace</span><span class=p>:</span> <span class=nx>service</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>},</span> <span class=nx>serviceFound</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>IsNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Creating a new Service&#34;</span><span class=p>,</span> <span class=s>&#34;Service.Namespace&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=s>&#34;Service.Name&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>service</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Service created successfully - don&#39;t requeue
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Service already exists
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>log</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Service already exists&#34;</span><span class=p>,</span> <span class=s>&#34;Service.Namespace&#34;</span><span class=p>,</span> <span class=nx>serviceFound</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=s>&#34;Service.Name&#34;</span><span class=p>,</span> <span class=nx>serviceFound</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Service reconcile finished
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Returns a new deployment without replicas configured
</span></span></span><span class=line><span class=cl><span class=c1>// replicas will be configured in the sync loop
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>newDeploymentForCR</span><span class=p>(</span><span class=nx>cr</span> <span class=o>*</span><span class=nx>appsv1alpha1</span><span class=p>.</span><span class=nx>ReverseWordsApp</span><span class=p>)</span> <span class=o>*</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>Deployment</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>labels</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;app&#34;</span><span class=p>:</span> <span class=nx>cr</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>replicas</span> <span class=o>:=</span> <span class=nx>cr</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Minimum replicas will be 1
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>replicas</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>replicas</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>appVersion</span> <span class=o>:=</span> <span class=s>&#34;latest&#34;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>cr</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>AppVersion</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>appVersion</span> <span class=p>=</span> <span class=nx>cr</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>AppVersion</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// TODO:Check if application version exists
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>containerImage</span> <span class=o>:=</span> <span class=s>&#34;quay.io/mavazque/reversewords:&#34;</span> <span class=o>+</span> <span class=nx>appVersion</span>
</span></span><span class=line><span class=cl>	<span class=nx>probe</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Probe</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ProbeHandler</span><span class=p>:</span> <span class=nx>corev1</span><span class=p>.</span><span class=nx>ProbeHandler</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>HTTPGet</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>HTTPGetAction</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Path</span><span class=p>:</span> <span class=s>&#34;/health&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Port</span><span class=p>:</span> <span class=nx>intstr</span><span class=p>.</span><span class=nf>FromInt</span><span class=p>(</span><span class=mi>8080</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>InitialDelaySeconds</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>TimeoutSeconds</span><span class=p>:</span>      <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>PeriodSeconds</span><span class=p>:</span>       <span class=mi>15</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>TypeMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>TypeMeta</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>APIVersion</span><span class=p>:</span> <span class=s>&#34;apps/v1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Kind</span><span class=p>:</span>       <span class=s>&#34;Deployment&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Name</span><span class=p>:</span>      <span class=s>&#34;dp-&#34;</span> <span class=o>+</span> <span class=nx>cr</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Namespace</span><span class=p>:</span> <span class=nx>cr</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Labels</span><span class=p>:</span>    <span class=nx>labels</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>Spec</span><span class=p>:</span> <span class=nx>appsv1</span><span class=p>.</span><span class=nx>DeploymentSpec</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Replicas</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>replicas</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Selector</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>LabelSelector</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>MatchLabels</span><span class=p>:</span> <span class=nx>labels</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=nx>Template</span><span class=p>:</span> <span class=nx>corev1</span><span class=p>.</span><span class=nx>PodTemplateSpec</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>Labels</span><span class=p>:</span> <span class=nx>labels</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=nx>Spec</span><span class=p>:</span> <span class=nx>corev1</span><span class=p>.</span><span class=nx>PodSpec</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>Containers</span><span class=p>:</span> <span class=p>[]</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Container</span><span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>Image</span><span class=p>:</span> <span class=nx>containerImage</span><span class=p>,</span>
</span></span><span class=line><span class=cl>							<span class=nx>Name</span><span class=p>:</span>  <span class=s>&#34;reversewords&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>							<span class=nx>Ports</span><span class=p>:</span> <span class=p>[]</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>ContainerPort</span><span class=p>{</span>
</span></span><span class=line><span class=cl>								<span class=p>{</span>
</span></span><span class=line><span class=cl>									<span class=nx>ContainerPort</span><span class=p>:</span> <span class=mi>8080</span><span class=p>,</span>
</span></span><span class=line><span class=cl>									<span class=nx>Name</span><span class=p>:</span>          <span class=s>&#34;reversewords&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>								<span class=p>},</span>
</span></span><span class=line><span class=cl>							<span class=p>},</span>
</span></span><span class=line><span class=cl>							<span class=nx>LivenessProbe</span><span class=p>:</span>  <span class=nx>probe</span><span class=p>,</span>
</span></span><span class=line><span class=cl>							<span class=nx>ReadinessProbe</span><span class=p>:</span> <span class=nx>probe</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=p>},</span>
</span></span><span class=line><span class=cl>					<span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Returns a new service
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>newServiceForCR</span><span class=p>(</span><span class=nx>cr</span> <span class=o>*</span><span class=nx>appsv1alpha1</span><span class=p>.</span><span class=nx>ReverseWordsApp</span><span class=p>)</span> <span class=o>*</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Service</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>labels</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;app&#34;</span><span class=p>:</span> <span class=nx>cr</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Service</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>TypeMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>TypeMeta</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>APIVersion</span><span class=p>:</span> <span class=s>&#34;v1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Kind</span><span class=p>:</span>       <span class=s>&#34;Service&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Name</span><span class=p>:</span>      <span class=s>&#34;service-&#34;</span> <span class=o>+</span> <span class=nx>cr</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Namespace</span><span class=p>:</span> <span class=nx>cr</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Labels</span><span class=p>:</span>    <span class=nx>labels</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>Spec</span><span class=p>:</span> <span class=nx>corev1</span><span class=p>.</span><span class=nx>ServiceSpec</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Type</span><span class=p>:</span>     <span class=nx>corev1</span><span class=p>.</span><span class=nx>ServiceTypeLoadBalancer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Selector</span><span class=p>:</span> <span class=nx>labels</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Ports</span><span class=p>:</span> <span class=p>[]</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>ServicePort</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;http&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>Port</span><span class=p>:</span> <span class=mi>8080</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// isDeploymentReady returns a true bool if the deployment has all its pods ready
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>isDeploymentReady</span><span class=p>(</span><span class=nx>deployment</span> <span class=o>*</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>configuredReplicas</span> <span class=o>:=</span> <span class=nx>deployment</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Replicas</span>
</span></span><span class=line><span class=cl>	<span class=nx>readyReplicas</span> <span class=o>:=</span> <span class=nx>deployment</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>ReadyReplicas</span>
</span></span><span class=line><span class=cl>	<span class=nx>deploymentReady</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>configuredReplicas</span> <span class=o>==</span> <span class=nx>readyReplicas</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>deploymentReady</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>deploymentReady</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// getRunningPodNames returns the pod names for the pods running in the array of pods passed in
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>getRunningPodNames</span><span class=p>(</span><span class=nx>pods</span> <span class=p>[]</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>[]</span><span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Create an empty []string, so if no podNames are returned, instead of nil we get an empty slice
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>var</span> <span class=nx>podNames</span> <span class=p>[]</span><span class=kt>string</span> <span class=p>=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>string</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>pods</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>pod</span><span class=p>.</span><span class=nf>GetObjectMeta</span><span class=p>().</span><span class=nf>GetDeletionTimestamp</span><span class=p>()</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Phase</span> <span class=o>==</span> <span class=nx>corev1</span><span class=p>.</span><span class=nx>PodPending</span> <span class=o>||</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Phase</span> <span class=o>==</span> <span class=nx>corev1</span><span class=p>.</span><span class=nx>PodRunning</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>podNames</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>podNames</span><span class=p>,</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>podNames</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// checkDeploymentImage returns wether the deployment image is different or not
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>checkDeploymentImage</span><span class=p>(</span><span class=nx>current</span> <span class=o>*</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>,</span> <span class=nx>desired</span> <span class=o>*</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>curr</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>current</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Template</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Containers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>des</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>desired</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Template</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Containers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Only compare the images of containers with the same name
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>curr</span><span class=p>.</span><span class=nx>Name</span> <span class=o>==</span> <span class=nx>des</span><span class=p>.</span><span class=nx>Name</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>curr</span><span class=p>.</span><span class=nx>Image</span> <span class=o>!=</span> <span class=nx>des</span><span class=p>.</span><span class=nx>Image</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// contains returns true if a string is found on a slice
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>contains</span><span class=p>(</span><span class=nx>list</span> <span class=p>[]</span><span class=kt>string</span><span class=p>,</span> <span class=nx>s</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>list</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>v</span> <span class=o>==</span> <span class=nx>s</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Ignore changes that do not increase the resource generation
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>ignoreDeletionPredicate</span><span class=p>()</span> <span class=nx>predicate</span><span class=p>.</span><span class=nx>Predicate</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>predicate</span><span class=p>.</span><span class=nx>Funcs</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>UpdateFunc</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>e</span> <span class=nx>event</span><span class=p>.</span><span class=nx>UpdateEvent</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Ignore updates to CR status in which case metadata.Generation does not change
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>return</span> <span class=nx>e</span><span class=p>.</span><span class=nx>ObjectOld</span><span class=p>.</span><span class=nf>GetGeneration</span><span class=p>()</span> <span class=o>!=</span> <span class=nx>e</span><span class=p>.</span><span class=nx>ObjectNew</span><span class=p>.</span><span class=nf>GetGeneration</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>DeleteFunc</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>e</span> <span class=nx>event</span><span class=p>.</span><span class=nx>DeleteEvent</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Evaluates to false if the object has been confirmed deleted.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>return</span> <span class=p>!</span><span class=nx>e</span><span class=p>.</span><span class=nx>DeleteStateUnknown</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>You can download the controller code, remember to change the GitHub ID before bulding the operator:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># Remember to change import: appsv1alpha1 &#34;github.com/mvazquezc/reverse-words-operator/api/v1alpha1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>curl -Ls https://linuxera.org/writing-operators-using-operator-framework/reversewordsapp_controller.go -o ~/operators-projects/reverse-words-operator/controllers/reversewordsapp_controller.go
</span></span></code></pre></div><h2 id=setup-watch-namespaces>Setup Watch namespaces<a hidden class=anchor aria-hidden=true href=#setup-watch-namespaces>#</a></h2><p>By default, the controller will watch all namespaces, in this case we want it to watch only the namespace where it runs, in order to do so we need to update the controller options in the <code>main.go</code> file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>Copyright 2021.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
</span></span></span><span class=line><span class=cl><span class=cm>you may not use this file except in compliance with the License.
</span></span></span><span class=line><span class=cl><span class=cm>You may obtain a copy of the License at
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>    http://www.apache.org/licenses/LICENSE-2.0
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>Unless required by applicable law or agreed to in writing, software
</span></span></span><span class=line><span class=cl><span class=cm>distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span></span></span><span class=line><span class=cl><span class=cm>WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span></span></span><span class=line><span class=cl><span class=cm>See the License for the specific language governing permissions and
</span></span></span><span class=line><span class=cl><span class=cm>limitations under the License.
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;flag&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Import all Kubernetes client auth plugins (e.g. Azure, GCP, OIDC, etc.)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// to ensure that exec-entrypoint and run can make use of them.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>_</span> <span class=s>&#34;k8s.io/client-go/plugin/pkg/client/auth&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>utilruntime</span> <span class=s>&#34;k8s.io/apimachinery/pkg/util/runtime&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>clientgoscheme</span> <span class=s>&#34;k8s.io/client-go/kubernetes/scheme&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctrl</span> <span class=s>&#34;sigs.k8s.io/controller-runtime&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;sigs.k8s.io/controller-runtime/pkg/healthz&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;sigs.k8s.io/controller-runtime/pkg/log/zap&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>appsv1alpha1</span> <span class=s>&#34;github.com/mvazquezc/reverse-words-operator/api/v1alpha1&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/mvazquezc/reverse-words-operator/controllers&#34;</span>
</span></span><span class=line><span class=cl>	<span class=c1>//+kubebuilder:scaffold:imports
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>scheme</span>   <span class=p>=</span> <span class=nx>runtime</span><span class=p>.</span><span class=nf>NewScheme</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>setupLog</span> <span class=p>=</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Log</span><span class=p>.</span><span class=nf>WithName</span><span class=p>(</span><span class=s>&#34;setup&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>utilruntime</span><span class=p>.</span><span class=nf>Must</span><span class=p>(</span><span class=nx>clientgoscheme</span><span class=p>.</span><span class=nf>AddToScheme</span><span class=p>(</span><span class=nx>scheme</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>utilruntime</span><span class=p>.</span><span class=nf>Must</span><span class=p>(</span><span class=nx>appsv1alpha1</span><span class=p>.</span><span class=nf>AddToScheme</span><span class=p>(</span><span class=nx>scheme</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=c1>//+kubebuilder:scaffold:scheme
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>metricsAddr</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>enableLeaderElection</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>probeAddr</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>flag</span><span class=p>.</span><span class=nf>StringVar</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>metricsAddr</span><span class=p>,</span> <span class=s>&#34;metrics-bind-address&#34;</span><span class=p>,</span> <span class=s>&#34;:8080&#34;</span><span class=p>,</span> <span class=s>&#34;The address the metric endpoint binds to.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>flag</span><span class=p>.</span><span class=nf>StringVar</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>probeAddr</span><span class=p>,</span> <span class=s>&#34;health-probe-bind-address&#34;</span><span class=p>,</span> <span class=s>&#34;:8081&#34;</span><span class=p>,</span> <span class=s>&#34;The address the probe endpoint binds to.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>flag</span><span class=p>.</span><span class=nf>BoolVar</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>enableLeaderElection</span><span class=p>,</span> <span class=s>&#34;leader-elect&#34;</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;Enable leader election for controller manager. &#34;</span><span class=o>+</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;Enabling this will ensure there is only one active controller manager.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>opts</span> <span class=o>:=</span> <span class=nx>zap</span><span class=p>.</span><span class=nx>Options</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Development</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>opts</span><span class=p>.</span><span class=nf>BindFlags</span><span class=p>(</span><span class=nx>flag</span><span class=p>.</span><span class=nx>CommandLine</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ctrl</span><span class=p>.</span><span class=nf>SetLogger</span><span class=p>(</span><span class=nx>zap</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>zap</span><span class=p>.</span><span class=nf>UseFlagOptions</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>opts</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>	<span class=nx>watchNamespace</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>getWatchNamespace</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>mgr</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nf>NewManager</span><span class=p>(</span><span class=nx>ctrl</span><span class=p>.</span><span class=nf>GetConfigOrDie</span><span class=p>(),</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Options</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Scheme</span><span class=p>:</span>                 <span class=nx>scheme</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>MetricsBindAddress</span><span class=p>:</span>     <span class=nx>metricsAddr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Port</span><span class=p>:</span>                   <span class=mi>9443</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>HealthProbeBindAddress</span><span class=p>:</span> <span class=nx>probeAddr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>LeaderElection</span><span class=p>:</span>         <span class=nx>enableLeaderElection</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>LeaderElectionID</span><span class=p>:</span>       <span class=s>&#34;1ef59d40.linuxera.org&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Namespace</span><span class=p>:</span>              <span class=nx>watchNamespace</span><span class=p>,</span> <span class=c1>// namespaced-scope when the value is not an empty string
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>setupLog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;unable to start manager&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>controllers</span><span class=p>.</span><span class=nx>ReverseWordsAppReconciler</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Client</span><span class=p>:</span> <span class=nx>mgr</span><span class=p>.</span><span class=nf>GetClient</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>Scheme</span><span class=p>:</span> <span class=nx>mgr</span><span class=p>.</span><span class=nf>GetScheme</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>	<span class=p>}).</span><span class=nf>SetupWithManager</span><span class=p>(</span><span class=nx>mgr</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>setupLog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;unable to create controller&#34;</span><span class=p>,</span> <span class=s>&#34;controller&#34;</span><span class=p>,</span> <span class=s>&#34;ReverseWordsApp&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>//+kubebuilder:scaffold:builder
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>mgr</span><span class=p>.</span><span class=nf>AddHealthzCheck</span><span class=p>(</span><span class=s>&#34;healthz&#34;</span><span class=p>,</span> <span class=nx>healthz</span><span class=p>.</span><span class=nx>Ping</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>setupLog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;unable to set up health check&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>mgr</span><span class=p>.</span><span class=nf>AddReadyzCheck</span><span class=p>(</span><span class=s>&#34;readyz&#34;</span><span class=p>,</span> <span class=nx>healthz</span><span class=p>.</span><span class=nx>Ping</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>setupLog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;unable to set up ready check&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>setupLog</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;starting manager&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>mgr</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>ctrl</span><span class=p>.</span><span class=nf>SetupSignalHandler</span><span class=p>());</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>setupLog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;problem running manager&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// getWatchNamespace returns the Namespace the operator should be watching for changes
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>getWatchNamespace</span><span class=p>()</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// WatchNamespaceEnvVar is the constant for env variable WATCH_NAMESPACE
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// which specifies the Namespace to watch.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// An empty value means the operator is running with cluster scope.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>var</span> <span class=nx>watchNamespaceEnvVar</span> <span class=p>=</span> <span class=s>&#34;WATCH_NAMESPACE&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ns</span><span class=p>,</span> <span class=nx>found</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>LookupEnv</span><span class=p>(</span><span class=nx>watchNamespaceEnvVar</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>found</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%s must be set&#34;</span><span class=p>,</span> <span class=nx>watchNamespaceEnvVar</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>ns</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>You can download the <code>main.go</code>, remember to change the GitHub ID before bulding the operator:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># Remember to change import: appsv1alpha1 &#34;github.com/mvazquezc/reverse-words-operator/api/v1alpha1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>curl -Ls https://linuxera.org/writing-operators-using-operator-framework/main.go -o ~/operators-projects/reverse-words-operator/main.go
</span></span></code></pre></div><h2 id=specify-permissions-and-generate-rbac-manifests>Specify permissions and generate RBAC manifests<a hidden class=anchor aria-hidden=true href=#specify-permissions-and-generate-rbac-manifests>#</a></h2><p>Our controller needs some RBAC permissions to interact with the resources it manages. These has been specified via RBAC Markers in our controller code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// +kubebuilder:rbac:groups=apps.linuxera.org,resources=reversewordsapps,verbs=get;list;watch;create;update;patch;delete
</span></span></span><span class=line><span class=cl><span class=c1>// +kubebuilder:rbac:groups=apps.linuxera.org,resources=reversewordsapps/status,verbs=get;update;patch
</span></span></span><span class=line><span class=cl><span class=c1>// +kubebuilder:rbac:groups=apps.linuxera.org,resources=reversewordsapps/finalizers,verbs=get;update;patch
</span></span></span><span class=line><span class=cl><span class=c1>// +kubebuilder:rbac:groups=apps,resources=deployments,verbs=get;list;watch;create;update;patch;delete
</span></span></span><span class=line><span class=cl><span class=c1>// +kubebuilder:rbac:groups=core,resources=services,verbs=get;list;watch;create;update;patch;delete
</span></span></span><span class=line><span class=cl><span class=c1>// +kubebuilder:rbac:groups=core,resources=pods,verbs=get;list;watch
</span></span></span><span class=line><span class=cl><span class=c1>// +kubebuilder:rbac:groups=core,resources=events,verbs=create;patch
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>ReverseWordsAppReconciler</span><span class=p>)</span> <span class=nf>Reconcile</span><span class=p>(</span><span class=nx>req</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>(</span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span></code></pre></div><p>The ClusterRole manifest at config/rbac/role.yaml is generated from the above markers via controller-gen with the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>go mod tidy
</span></span><span class=line><span class=cl>make manifests
</span></span></code></pre></div><h2 id=build-the-operator>Build the Operator<a hidden class=anchor aria-hidden=true href=#build-the-operator>#</a></h2><p>First, we will build the operator and once the image is built, we will push it to the <a href=https://quay.io/>Quay Registry</a>.</p><p>Before we start building the operator, we need access to a Kubernetes cluster. If you don&rsquo;t have one you can use <a href=https://github.com/kubernetes-sigs/kind/>Kind</a>, <a href=https://github.com/kubernetes/minikube>Minikube</a> or my prefered one, <a href=https://github.com/karmab/kcli>KCli</a></p><p>In order to get a local cluster with KCli, just run this command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kcli create kube generic -P <span class=nv>ctlplanes</span><span class=o>=</span><span class=m>1</span> -P <span class=nv>workers</span><span class=o>=</span><span class=m>1</span> -P <span class=nv>ctlplane_memory</span><span class=o>=</span><span class=m>4096</span> -P <span class=nv>numcpus</span><span class=o>=</span><span class=m>2</span> -P <span class=nv>worker_memory</span><span class=o>=</span><span class=m>4096</span> -P <span class=nv>sdn</span><span class=o>=</span>calico -P <span class=nv>version</span><span class=o>=</span>1.24 -P <span class=nv>ingress</span><span class=o>=</span><span class=nb>true</span> -P <span class=nv>ingress_method</span><span class=o>=</span>nginx -P <span class=nv>metallb</span><span class=o>=</span><span class=nb>true</span> -P <span class=nv>domain</span><span class=o>=</span>linuxera.org operatorscluster
</span></span></code></pre></div><p>Now that we have the cluster up and running we will build and push the operator.</p><blockquote><p><strong>NOTE</strong>: If you use podman instead of docker you can edit the Makefile and change docker commands by podman commands</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>export</span> <span class=nv>USERNAME</span><span class=o>=</span>&lt;quay-username&gt;
</span></span><span class=line><span class=cl>make docker-build docker-push <span class=nv>IMG</span><span class=o>=</span>quay.io/<span class=nv>$USERNAME</span>/reversewords-operator:v0.0.1
</span></span></code></pre></div><h2 id=deploy-the-operator>Deploy the Operator<a hidden class=anchor aria-hidden=true href=#deploy-the-operator>#</a></h2><ol><li><p>Create the required CRDs in the cluster</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>make install
</span></span></code></pre></div></li><li><p>Deploy the operator</p><blockquote><p><strong>NOTE</strong>: While developing you can run the operator locally (you need a valid kubeconfig) by running <code>make run</code></p></blockquote><p>In order to deploy the different operator pieces, Kustomize is used. There is a Kustomization file (<code>~/operators-projects/reverse-words-operator/config/default/kustomization.yaml</code>) where you can define some defaults for your operator, like the namePrefix for the different objects or the namespace where it will be deployed.</p><ol><li><p>Edit the default kustomization file <code>~/operators-projects/reverse-words-operator/config/default/kustomization.yaml</code> and specify the namespace where your operator should run by modifying the <code>namespace</code> property</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>export</span> <span class=nv>NAMESPACE</span><span class=o>=</span>operators-test
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s/namespace: .*/namespace: </span><span class=nv>$NAMESPACE</span><span class=s2>/g&#34;</span> ~/operators-projects/reverse-words-operator/config/default/kustomization.yaml
</span></span></code></pre></div></li><li><p>Create the namespace and Deploy the operator</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl create ns <span class=nv>$NAMESPACE</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>USERNAME</span><span class=o>=</span>&lt;quay_username&gt;
</span></span><span class=line><span class=cl>make deploy <span class=nv>IMG</span><span class=o>=</span>quay.io/<span class=nv>$USERNAME</span>/reversewords-operator:v0.0.1
</span></span></code></pre></div></li><li><p>Patch the controller deployment so it only watches the namespace where it&rsquo;s running</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl -n <span class=nv>$NAMESPACE</span> patch deployment reverse-words-operator-controller-manager -p <span class=s1>&#39;{&#34;spec&#34;:{&#34;template&#34;:{&#34;spec&#34;:{&#34;$setElementOrder/containers&#34;:[{&#34;name&#34;:&#34;kube-rbac-proxy&#34;},{&#34;name&#34;:&#34;manager&#34;}],&#34;containers&#34;:[{&#34;env&#34;:[{&#34;name&#34;:&#34;WATCH_NAMESPACE&#34;,&#34;valueFrom&#34;:{&#34;fieldRef&#34;:{&#34;fieldPath&#34;:&#34;metadata.namespace&#34;}}}],&#34;name&#34;:&#34;manager&#34;}]}}}}&#39;</span>
</span></span></code></pre></div></li></ol></li><li><p>We should see our operator pod up and running</p><pre tabindex=0><code>1.676311934753094e+09	INFO	controller-runtime.metrics	Metrics server is starting to listen	{&#34;addr&#34;: &#34;127.0.0.	1:8080&#34;}
1.6763119347534144e+09	INFO	setup	starting manager
I0213 18:12:14.753860       1 leaderelection.go:248] attempting to acquire leader lease operators-test/1ef59d40.	linuxera.org...
1.6763119347538702e+09	INFO	Starting server	{&#34;kind&#34;: &#34;health probe&#34;, &#34;addr&#34;: &#34;[::]:8081&#34;}
1.6763119347539454e+09	INFO	Starting server	{&#34;path&#34;: &#34;/metrics&#34;, &#34;kind&#34;: &#34;metrics&#34;, &#34;addr&#34;: &#34;127.0.0.1:8080&#34;}
I0213 18:12:37.253145       1 leaderelection.go:258] successfully acquired lease operators-test/1ef59d40.linuxera.org
1.6763119572531986e+09	DEBUG	events		reverse-words-operator-controller-manager-755f55cffc-9wprb_028ea174-80b7-4294-abfb-1d1aae892cd7 became leader		{&#34;type&#34;: &#34;Normal&#34;, &#34;object&#34;: {&#34;kind&#34;:&#34;Lease&#34;,&#34;namespace&#34;:&#34;operators-test&#34;,&#34;name&#34;:&#34;1ef59d40.linuxera.org&#34;,	&#34;uid&#34;:&#34;ae3f7dff-1624-47b2-9010-c666d559473d&#34;,&#34;apiVersion&#34;:&#34;coordination.k8s.io/v1&#34;,&#34;resourceVersion&#34;:&#34;11102046&#34;}, 	&#34;reason&#34;: &#34;LeaderElection&#34;}
1.6763119572534668e+09	INFO	Starting EventSource	{&#34;controller&#34;: &#34;reversewordsapp&#34;, &#34;controllerGroup&#34;: &#34;apps.	linuxera.org&#34;, &#34;controllerKind&#34;: &#34;ReverseWordsApp&#34;, &#34;source&#34;: &#34;kind source: *v1alpha1.ReverseWordsApp&#34;}
1.6763119572535148e+09	INFO	Starting EventSource	{&#34;controller&#34;: &#34;reversewordsapp&#34;, &#34;controllerGroup&#34;: &#34;apps.	linuxera.org&#34;, &#34;controllerKind&#34;: &#34;ReverseWordsApp&#34;, &#34;source&#34;: &#34;kind source: *v1.Deployment&#34;}
1.6763119572535224e+09	INFO	Starting EventSource	{&#34;controller&#34;: &#34;reversewordsapp&#34;, &#34;controllerGroup&#34;: &#34;apps.	linuxera.org&#34;, &#34;controllerKind&#34;: &#34;ReverseWordsApp&#34;, &#34;source&#34;: &#34;kind source: *v1.Service&#34;}
1.6763119572535274e+09	INFO	Starting Controller	{&#34;controller&#34;: &#34;reversewordsapp&#34;, &#34;controllerGroup&#34;: &#34;apps.	linuxera.org&#34;, &#34;controllerKind&#34;: &#34;ReverseWordsApp&#34;}
1.6763119573569405e+09	INFO	Starting workers	{&#34;controller&#34;: &#34;reversewordsapp&#34;, &#34;controllerGroup&#34;: &#34;apps.	linuxera.org&#34;, &#34;controllerKind&#34;: &#34;ReverseWordsApp&#34;, &#34;worker count&#34;: 10}
</code></pre></li><li><p>Now it&rsquo;s time to create ReverseWordsApp instances</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | kubectl -n $NAMESPACE create -f -
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps.linuxera.org/v1alpha1
</span></span></span><span class=line><span class=cl><span class=s>kind: ReverseWordsApp
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>    name: example-reversewordsapp
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>    replicas: 1
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | kubectl -n $NAMESPACE create -f -
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps.linuxera.org/v1alpha1
</span></span></span><span class=line><span class=cl><span class=s>kind: ReverseWordsApp
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>    name: example-reversewordsapp-2
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>    replicas: 2
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div></li><li><p>We should see two deployments and services being created, and if wee look at the status of our object we should see the pods backing the instance</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl -n <span class=nv>$NAMESPACE</span> get reversewordsapps example-reversewordsapp -o yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>apiVersion: apps.linuxera.org/v1alpha1
</span></span><span class=line><span class=cl>kind: ReverseWordsApp
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  creationTimestamp: <span class=s2>&#34;2023-02-13T18:13:48Z&#34;</span>
</span></span><span class=line><span class=cl>  finalizers:
</span></span><span class=line><span class=cl>  - finalizer.reversewordsapp.apps.linuxera.org
</span></span><span class=line><span class=cl>  generation: <span class=m>1</span>
</span></span><span class=line><span class=cl>  name: example-reversewordsapp
</span></span><span class=line><span class=cl>  namespace: operators-test
</span></span><span class=line><span class=cl>  resourceVersion: <span class=s2>&#34;11103763&#34;</span>
</span></span><span class=line><span class=cl>  uid: ef9351b2-cd44-47b0-ba66-8143f06267dc
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  replicas: <span class=m>1</span>
</span></span><span class=line><span class=cl>status:
</span></span><span class=line><span class=cl>  appPods:
</span></span><span class=line><span class=cl>  - dp-example-reversewordsapp-75cff95fd8-5qvm9
</span></span><span class=line><span class=cl>  conditions:
</span></span><span class=line><span class=cl>  - lastTransitionTime: <span class=s2>&#34;2023-02-13T18:13:48Z&#34;</span>
</span></span><span class=line><span class=cl>    message: <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    reason: ReverseWordsDeploymentNotReady
</span></span><span class=line><span class=cl>    status: <span class=s2>&#34;True&#34;</span>
</span></span><span class=line><span class=cl>    type: ReverseWordsDeploymentNotReady
</span></span><span class=line><span class=cl>  - lastTransitionTime: <span class=s2>&#34;2023-02-13T18:13:48Z&#34;</span>
</span></span><span class=line><span class=cl>    message: <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    reason: Ready
</span></span><span class=line><span class=cl>    status: <span class=s2>&#34;False&#34;</span>
</span></span><span class=line><span class=cl>    type: Ready
</span></span></code></pre></div></li><li><p>We can test our application now</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nv>LB_ENDPOINT</span><span class=o>=</span><span class=k>$(</span>kubectl -n <span class=nv>$NAMESPACE</span> get svc --selector<span class=o>=</span><span class=s1>&#39;app=example-reversewordsapp&#39;</span> -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.items[*].status.loadBalancer.ingress[*].ip}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>curl -X POST -d <span class=s1>&#39;{&#34;word&#34;:&#34;PALC&#34;}&#39;</span> http://<span class=nv>$LB_ENDPOINT</span>:8080
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;reverse_word&#34;</span>:<span class=s2>&#34;CLAP&#34;</span><span class=o>}</span>
</span></span></code></pre></div></li><li><p>Cleanup</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl -n <span class=nv>$NAMESPACE</span> delete reversewordsapp example-reversewordsapp example-reversewordsapp-2
</span></span><span class=line><span class=cl>kubectl delete -f config/crd/bases/apps.linuxera.org_reversewordsapps.yaml 
</span></span><span class=line><span class=cl>kubectl delete ns operators-test
</span></span></code></pre></div></li><li><p>That&rsquo;s it!</p></li></ol><h1 id=in-the-next-episode>In the next episode:<a hidden class=anchor aria-hidden=true href=#in-the-next-episode>#</a></h1><ul><li><a href=https://linuxera.org/integrating-operators-olm/>We will look at how to use OLM to release our operator</a></li><li>We will see a K8s controllers deep dive</li></ul><h1 id=sources>Sources<a hidden class=anchor aria-hidden=true href=#sources>#</a></h1><ul><li><a href=https://coreos.com/operators/>Operators by CoreOS</a></li><li><a href=https://engineering.bitnami.com/articles/a-deep-dive-into-kubernetes-controllers.html>A deep dive into Kubernetes Controllers</a></li><li><a href="https://www.youtube.com/watch?v=AUNPLQVxvmw">Writing Kube Controllers for Everyone</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://linuxera.org/tags/okd/>okd</a></li><li><a href=https://linuxera.org/tags/origin/>origin</a></li><li><a href=https://linuxera.org/tags/containers/>containers</a></li><li><a href=https://linuxera.org/tags/kubernetes/>kubernetes</a></li><li><a href=https://linuxera.org/tags/operators/>operators</a></li><li><a href=https://linuxera.org/tags/controllers/>controllers</a></li><li><a href=https://linuxera.org/tags/operator-framework/>operator framework</a></li><li><a href=https://linuxera.org/tags/operator-sdk/>operator sdk</a></li><li><a href=https://linuxera.org/tags/openshift/>openshift</a></li><li><a href=https://linuxera.org/tags/ocp/>ocp</a></li></ul><nav class=paginav><a class=prev href=https://linuxera.org/oauth-proxy-secure-applications-openshift/><span class=title>¬´ Prev</span><br><span>Using OpenShift OAuth Proxy to secure your Applications on OpenShift</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Writing Operators using the Operator Framework SDK on twitter" href="https://twitter.com/intent/tweet/?text=Writing%20Operators%20using%20the%20Operator%20Framework%20SDK&amp;url=https%3a%2f%2flinuxera.org%2fwriting-operators-using-operator-framework%2f&amp;hashtags=okd%2corigin%2ccontainers%2ckubernetes%2coperators%2ccontrollers%2coperatorframework%2coperatorsdk%2copenshift%2cocp"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Writing Operators using the Operator Framework SDK on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2flinuxera.org%2fwriting-operators-using-operator-framework%2f&amp;title=Writing%20Operators%20using%20the%20Operator%20Framework%20SDK&amp;summary=Writing%20Operators%20using%20the%20Operator%20Framework%20SDK&amp;source=https%3a%2f%2flinuxera.org%2fwriting-operators-using-operator-framework%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></div></footer><script src=https://utteranc.es/client.js repo=mvazquezc/mvazquezc.github.io issue-term=pathname label=blog-comments theme=preferred-color-scheme crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2023 <a href=https://linuxera.org/>Linuxera</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>