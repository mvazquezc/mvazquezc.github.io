<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Signing and verifying container images with Cosign and your own PKI | Linuxera</title><meta name=keywords content="cosing,sigstore,byok,pki,security"><meta name=description content="Signing and verifying container images with Cosign and your own PKI In this post we are going to cover how we can sign and verify container images using Cosign and our own PKI. You can learn more on how to build your own PKI with CFSSL in this post.
Warning
The way we will see to sign and verify images in this post is not the recommended approach. For production usage, you should use ephemeral keys as described here."><meta name=author content="Mario"><link rel=canonical href=https://linuxera.org/signing-verifying-container-images-with-cosign-own-pki/><link crossorigin=anonymous href=/assets/css/stylesheet.8cc7ef3cdd44c5188f9267864f378d8dd8892d583e0fd07b5e5321e496f1e4d1.css integrity="sha256-jMfvPN1ExRiPkmeGTzeNjdiJLVg+D9B7XlMh5Jbx5NE=" rel="preload stylesheet" as=style><link rel=icon href=https://linuxera.org/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://linuxera.org/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://linuxera.org/favicon-32x32.png><link rel=apple-touch-icon href=https://linuxera.org/apple-touch-icon.png><link rel=mask-icon href=https://linuxera.org/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer data-domain=linuxera.org src=https://stats.linuxera.org/js/script.file-downloads.hash.outbound-links.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script><meta property="og:title" content="Signing and verifying container images with Cosign and your own PKI"><meta property="og:description" content="Signing and verifying container images with Cosign and your own PKI In this post we are going to cover how we can sign and verify container images using Cosign and our own PKI. You can learn more on how to build your own PKI with CFSSL in this post.
Warning
The way we will see to sign and verify images in this post is not the recommended approach. For production usage, you should use ephemeral keys as described here."><meta property="og:type" content="article"><meta property="og:url" content="https://linuxera.org/signing-verifying-container-images-with-cosign-own-pki/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-25T00:00:00+00:00"><meta property="article:modified_time" content="2024-05-03T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Signing and verifying container images with Cosign and your own PKI"><meta name=twitter:description content="Signing and verifying container images with Cosign and your own PKI In this post we are going to cover how we can sign and verify container images using Cosign and our own PKI. You can learn more on how to build your own PKI with CFSSL in this post.
Warning
The way we will see to sign and verify images in this post is not the recommended approach. For production usage, you should use ephemeral keys as described here."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://linuxera.org/posts/"},{"@type":"ListItem","position":2,"name":"Signing and verifying container images with Cosign and your own PKI","item":"https://linuxera.org/signing-verifying-container-images-with-cosign-own-pki/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Signing and verifying container images with Cosign and your own PKI","name":"Signing and verifying container images with Cosign and your own PKI","description":"Signing and verifying container images with Cosign and your own PKI In this post we are going to cover how we can sign and verify container images using Cosign and our own PKI. You can learn more on how to build your own PKI with CFSSL in this post.\nWarning\nThe way we will see to sign and verify images in this post is not the recommended approach. For production usage, you should use ephemeral keys as described here.","keywords":["cosing","sigstore","byok","pki","security"],"articleBody":"Signing and verifying container images with Cosign and your own PKI In this post we are going to cover how we can sign and verify container images using Cosign and our own PKI. You can learn more on how to build your own PKI with CFSSL in this post.\nWarning\nThe way we will see to sign and verify images in this post is not the recommended approach. For production usage, you should use ephemeral keys as described here. Validity of certificates generated during this post it’s not recommended for production usage, make sure in production you have proper validity periods and rotation capabilities in place.\nSolution Overview We have our own Root CA that issued an Intermediate CA. This Intermediate CA issued two certificates, one for Team A to sign their images and another one for Team B to sign their images.\nThen, verification of image signatures will be done by using the Root CA public certificate.\nGenerating PKI with CFSSL Install required CFSSL binaries:\nsudo curl -L https://github.com/cloudflare/cfssl/releases/download/v1.6.5/cfssl_1.6.5_linux_amd64 -o /usr/local/bin/cfssl sudo curl -L https://github.com/cloudflare/cfssl/releases/download/v1.6.5/cfssljson_1.6.5_linux_amd64 -o /usr/local/bin/cfssljson sudo chmod +x /usr/local/bin/{cfssl,cfssljson} Define workdir for the files that will be generated during the post:\nexport WORKDIR=/var/tmp/cosign/ Generate Root and Intermediate CAs:\nmkdir -p $WORKDIR/cafiles/{root,intermediate,config,certificates} # Generate Root CA csr cat \u003c\u003c \"EOF\" \u003e $WORKDIR/cafiles/root/root-csr.json { \"CN\": \"Linuxera Root Certificate Authority\", \"key\": { \"algo\": \"ecdsa\", \"size\": 256 }, \"names\": [ { \"C\": \"ES\", \"L\": \"Valencia\", \"O\": \"IT\", \"OU\": \"Security\", \"ST\": \"Valencia\" } ], \"ca\": { \"expiry\": \"87600h\" } } EOF # Generate Intermediate CA csr cat \u003c\u003c \"EOF\" \u003e $WORKDIR/cafiles/intermediate/intermediate-csr.json { \"CN\": \"Linuxera Intermediate Certificate Authority\", \"key\": { \"algo\": \"ecdsa\", \"size\": 256 }, \"names\": [ { \"C\": \"ES\", \"L\": \"Valencia\", \"O\": \"IT\", \"OU\": \"Security\", \"ST\": \"Valencia\" } ] } EOF # Issue RootCA keypair cfssl gencert -initca $WORKDIR/cafiles/root/root-csr.json | cfssljson -bare $WORKDIR/cafiles/root/root-ca # Generate Intermediate CA key cfssl genkey $WORKDIR/cafiles/intermediate/intermediate-csr.json | cfssljson -bare $WORKDIR/cafiles/intermediate/intermediate-ca # Define cfssl profile for the intermediate CA cat \u003c\u003c \"EOF\" \u003e $WORKDIR/cafiles/config/config.json { \"signing\": { \"default\": { \"expiry\": \"8760h\" }, \"profiles\": { \"intermediate\": { \"usages\": [\"cert sign\", \"crl sign\"], \"expiry\": \"70080h\", \"ca_constraint\": { \"is_ca\": true, \"max_path_len\": 1 } } } } } EOF # Issue Intermediate CA cert using RootCA cfssl sign -ca $WORKDIR/cafiles/root/root-ca.pem -ca-key $WORKDIR/cafiles/root/root-ca-key.pem -config $WORKDIR/cafiles/config/config.json -profile intermediate $WORKDIR/cafiles/intermediate/intermediate-ca.csr | cfssljson -bare $WORKDIR/cafiles/intermediate/intermediate-ca # Put RootCA key to sleep rm -f $WORKDIR/cafiles/root/root-ca-key.pem Generate container signing certificates for Team A and Team B:\nAttention\nFor Cosign v2 verification to work, we need our certificates to provide some information in the SAN. We require it to provide a valid email and also to provide a valid oidcIssuer. The oidcIssuer is added via OID, you can find the details here. In the certs below you can see two OIDs added as extensions, the value for the one ending in 1,1 is a base64 encoded raw string, while the one ending in 1,8 is the base64 encoded ASN.1 string (you can check the code here to generate the string).\n# Define a new cosign profile cat \u003c\u003c \"EOF\" \u003e $WORKDIR/cafiles/config/config.json { \"signing\": { \"default\": { \"expiry\": \"8760h\" }, \"profiles\": { \"intermediate\": { \"usages\": [\"cert sign\", \"crl sign\"], \"expiry\": \"70080h\", \"ca_constraint\": { \"is_ca\": true, \"max_path_len\": 1, \"copy_extensions\": true } }, \"cosign\": { \"usages\": [\"signing\", \"digital signing\"], \"expiry\": \"8760h\", \"copy_extensions\": true } } } } EOF # Generate cosign keypair for team-a and team-b # cosign v2 requires email and uri SAN values which are configured under hosts cat \u003c\u003c \"EOF\" \u003e $WORKDIR/cafiles/certificates/team-a-csr.json { \"CN\": \"Team A Cosign Certificate\", \"key\": { \"algo\": \"ecdsa\", \"size\": 256 }, \"names\": [ { \"C\": \"ES\", \"L\": \"Valencia\", \"O\": \"IT\", \"OU\": \"Security\" } ], \"hosts\": [ \"team-a@linuxera.org\" ], \"extensions\": [ { \"id\": [1,3,6,1,4,1,57264,1,8], \"value\": \"ExRodHRwczovL2xpbnV4ZXJhLm9yZw==\" }, { \"id\": [1,3,6,1,4,1,57264,1,1], \"value\": \"aHR0cHM6Ly9saW51eGVyYS5vcmc=\" } ] } EOF cat \u003c\u003c \"EOF\" \u003e $WORKDIR/cafiles/certificates/team-b-csr.json { \"CN\": \"Team B Cosign Certificate\", \"key\": { \"algo\": \"ecdsa\", \"size\": 256 }, \"names\": [ { \"C\": \"ES\", \"L\": \"Valencia\", \"O\": \"IT\", \"OU\": \"Security\" } ], \"hosts\": [ \"team-b@linuxera.org\" ], \"extensions\": [ { \"id\": [1,3,6,1,4,1,57264,1,8], \"value\": \"ExRodHRwczovL2xpbnV4ZXJhLm9yZw==\" }, { \"id\": [1,3,6,1,4,1,57264,1,1], \"value\": \"aHR0cHM6Ly9saW51eGVyYS5vcmc=\" } ] } EOF # Issue certificates via the intermediate CA cfssl gencert -ca $WORKDIR/cafiles/intermediate/intermediate-ca.pem -ca-key $WORKDIR/cafiles/intermediate/intermediate-ca-key.pem -config $WORKDIR/cafiles/config/config.json -profile cosign $WORKDIR/cafiles/certificates/team-a-csr.json | cfssljson -bare $WORKDIR/cafiles/certificates/team-a cfssl gencert -ca $WORKDIR/cafiles/intermediate/intermediate-ca.pem -ca-key $WORKDIR/cafiles/intermediate/intermediate-ca-key.pem -config $WORKDIR/cafiles/config/config.json -profile cosign $WORKDIR/cafiles/certificates/team-b-csr.json | cfssljson -bare $WORKDIR/cafiles/certificates/team-b Alternative OpenSSL commands In case you want to rather use OpenSSL, these are the commands you need to run. Thanks to Frédéric Herrmann for sharing the information.\nAttention\nCommands below use RSA as encryption algorithm.\nGenerate Root CA\nopenssl req -x509 -newkey rsa:4096 -keyout root-ca-key.pem -sha256 -noenc -days 9999 -subj \"/C=ES/L=Valencia/O=IT/OU=Security/CN=Linuxera Root Certificate Authority\" -out root-ca.pem Generate Intermediate CA\n# Create request openssl req -noenc -newkey rsa:4096 -keyout intermediate-ca-key.pem -addext \"subjectKeyIdentifier = hash\" -addext \"keyUsage = critical,keyCertSign\" -addext \"basicConstraints = critical,CA:TRUE,pathlen:2\" -subj \"/C=ES/L=Valencia/O=IT/OU=Security/CN=Linuxera Intermediate Certificate Authority\" -out intermediate-ca.csr # Issue cert with Root CA openssl x509 -req -days 9999 -sha256 -in intermediate-ca.csr -CA root-ca.pem -CAkey root-ca-key.pem -copy_extensions copy -out intermediate-ca.pem Issue Team A cert\n# OID_1_1 is the hexadecimal representation of the oidcissuer url OID_1_1=$(echo -n \"https://linuxera.org\" | xxd -p -u) # Create request openssl req -noenc -newkey rsa:4096 -keyout team-a-key.pem -addext \"subjectKeyIdentifier = hash\" -addext \"basicConstraints = critical,CA:FALSE\" -addext \"keyUsage = critical,digitalSignature\" -addext \"subjectAltName = email:team-a@linuxera.org\" -addext \"1.3.6.1.4.1.57264.1.1 = DER:${OID_1_1}\" -addext \"1.3.6.1.4.1.57264.1.8 = ASN1:UTF8String:https://linuxera.org\" -subj \"/C=ES/L=Valencia/O=IT/OU=Security/CN=Team A Cosign Certificate\" -out team-a.csr # Issue cert with Intermediate CA openssl x509 -req -in team-a.csr -CA intermediate-ca.pem -CAkey intermediate-ca-key.pem -copy_extensions copy -days 9999 -sha256 -out team-a.pem Issue Team B cert\n# OID_1_1 is the hexadecimal representation of the oidcissuer url OID_1_1=$(echo -n \"https://linuxera.org\" | xxd -p -u) # Create request openssl req -noenc -newkey rsa:4096 -keyout team-b-key.pem -addext \"subjectKeyIdentifier = hash\" -addext \"basicConstraints = critical,CA:FALSE\" -addext \"keyUsage = critical,digitalSignature\" -addext \"subjectAltName = email:team-b@linuxera.org\" -addext \"1.3.6.1.4.1.57264.1.1 = DER:${OID_1_1}\" -addext \"1.3.6.1.4.1.57264.1.8 = ASN1:UTF8String:https://linuxera.org\" -subj \"/C=ES/L=Valencia/O=IT/OU=Security/CN=Team B Cosign Certificate\" -out team-b.csr # Issue cert with Intermediate CA openssl x509 -req -in team-b.csr -CA intermediate-ca.pem -CAkey intermediate-ca-key.pem -copy_extensions copy -days 9999 -sha256 -out team-b.pem Generate our container image We need a container image we will sign, on top of that we require our registry to support the upload of Cosign signatures. For this post I’ll be using quay.io.\nDefine our Quay image repository:\nIMAGE_ENDPOINT=quay.io/example/signingtest Generate a Dockerfile:\ncat \u003c\u003c'EOF' \u003e $WORKDIR/Dockerfile FROM registry.fedoraproject.org/fedora-minimal:39 ARG GREETING RUN echo $GREETING \u003e /tmp/HelloWorld USER 1024 CMD [\"sleep\", \"infinity\"] EOF Build the images for Team A and Team B:\npodman build -f $WORKDIR/Dockerfile --build-arg GREETING=\"Hello from Team A\" -t $IMAGE_ENDPOINT:team-a podman build -f $WORKDIR/Dockerfile --build-arg GREETING=\"Hello from Team B\" -t $IMAGE_ENDPOINT:team-b Push the images to the registry and store the images digest locally, this is required since we sign image digests, not tags:\npodman push --digestfile $WORKDIR/image-digest-team-a $IMAGE_ENDPOINT:team-a podman push --digestfile $WORKDIR/image-digest-team-b $IMAGE_ENDPOINT:team-b Signing container images with Cosign Attention\nDuring the exploratory work I started testing Cosign v1, that’s why I will document here how you can sign container images using v1. The steps that differ between both versions will have both options described. Nevertheless, you should be using v2.\nDownload Cosign CLI\nsudo curl -L https://github.com/sigstore/cosign/releases/download/v1.13.6/cosign-linux-amd64 -o /usr/local/bin/cosign-v1 sudo curl -L https://github.com/sigstore/cosign/releases/download/v2.2.4/cosign-linux-amd64 -o /usr/local/bin/cosign-v2 sudo chmod +x /usr/local/bin/cosign-v1 sudo chmod +x /usr/local/bin/cosign-v2 Build trust chain bundle (must start with the parent intermediate CA certificate of the signing certificate and end with the root certificate):\ncat $WORKDIR/cafiles/intermediate/intermediate-ca.pem $WORKDIR/cafiles/root/root-ca.pem \u003e $WORKDIR/ca-bundle.pem Team-A Image Signing Store container image digest:\nTEAM_A_IMAGE_DIGEST=$(cat $WORKDIR/image-digest-team-a) Import key into Cosign:\nWith v1:\ncosign-v1 import-key-pair --key $WORKDIR/cafiles/certificates/team-a-key.pem mv import-cosign.key $WORKDIR/import-team-a.key mv import-cosign.pub $WORKDIR/import-team-a.pub With v2:\ncosign-v2 import-key-pair --key $WORKDIR/cafiles/certificates/team-a-key.pem --output-key-prefix=$WORKDIR/import-team-a Sign with Cosign and our own key without uploading to transparency log:\nWith v1:\ncosign-v1 sign --key $WORKDIR/import-team-a.key --no-tlog-upload --cert $WORKDIR/cafiles/certificates/team-a.pem --cert-chain $WORKDIR/ca-bundle.pem $IMAGE_ENDPOINT@$TEAM_A_IMAGE_DIGEST With v2:\ncosign-v2 sign --key $WORKDIR/import-team-a.key --tlog-upload=false --cert $WORKDIR/cafiles/certificates/team-a.pem --cert-chain $WORKDIR/ca-bundle.pem $IMAGE_ENDPOINT@$TEAM_A_IMAGE_DIGEST Team-B Image Signing Store container image digest:\nTEAM_B_IMAGE_DIGEST=$(cat $WORKDIR/image-digest-team-b) Import key into Cosign:\nWith v1:\ncosign-v1 import-key-pair --key $WORKDIR/cafiles/certificates/team-b-key.pem mv import-cosign.key $WORKDIR/import-team-b.key mv import-cosign.pub $WORKDIR/import-team-b.pub With v2:\ncosign-v2 import-key-pair --key $WORKDIR/cafiles/certificates/team-b-key.pem --output-key-prefix=$WORKDIR/import-team-b Sign with Cosign and our own key without uploading to transparency log:\nWith v1:\ncosign-v1 sign --key $WORKDIR/import-team-b.key --no-tlog-upload --cert $WORKDIR/cafiles/certificates/team-b.pem --cert-chain $WORKDIR/ca-bundle.pem $IMAGE_ENDPOINT@$TEAM_B_IMAGE_DIGEST With v2:\ncosign-v2 sign --key $WORKDIR/import-team-b.key --tlog-upload=false --cert $WORKDIR/cafiles/certificates/team-b.pem --cert-chain $WORKDIR/ca-bundle.pem $IMAGE_ENDPOINT@$TEAM_B_IMAGE_DIGEST Verifying container images with Cosign and our Root CA We can verify the image signature in multiple ways, in this case we want to use only the Root CA public certificate to run the verification. Keep in mind that Cosign v2 doesn’t work with BYOK like v1 used to do. More info here.\nCosign v1 We need to disable rekor-url since we haven’t uploaded anything to the transparency log. More here.\nSIGSTORE_ROOT_FILE=$WORKDIR/cafiles/root/root-ca.pem COSIGN_EXPERIMENTAL=1 cosign-v1 verify --rekor-url=\"\" $IMAGE_ENDPOINT@$TEAM_A_IMAGE_DIGEST $IMAGE_ENDPOINT@$TEAM_B_IMAGE_DIGEST Verification for quay.io/example/signingtest@sha256:81a274fb4ed001132969dcf03de244d6f9b36d42d2b688b09a1c2d67691e6e41 -- The following checks were performed on each of these signatures: - The cosign claims were validated - Any certificates were verified against the Fulcio roots. [{\"critical\":{\"identity\":{\"docker-reference\":\"quay.io/example/signingtest\"},\"image\":{\"docker-manifest-digest\":\"sha256:81a274fb4ed001132969dcf03de244d6f9b36d42d2b688b09a1c2d67691e6e41\"},\"type\":\"cosign container image signature\"},\"optional\":{\"1.3.6.1.4.1.57264.1.1\":\"https://linuxera.org\",\"Issuer\":\"https://linuxera.org\",\"Subject\":\"team-a@linuxera.org\"}}] Verification for quay.io/example/signingtest@sha256:3bf90da5cd72d0057e4f06faf5669004262885005e662a93706fa85627d62cc5 -- The following checks were performed on each of these signatures: - The cosign claims were validated - Any certificates were verified against the Fulcio roots. [{\"critical\":{\"identity\":{\"docker-reference\":\"quay.io/example/signingtest\"},\"image\":{\"docker-manifest-digest\":\"sha256:3bf90da5cd72d0057e4f06faf5669004262885005e662a93706fa85627d62cc5\"},\"type\":\"cosign container image signature\"},\"optional\":{\"1.3.6.1.4.1.57264.1.1\":\"https://linuxera.org\",\"Issuer\":\"https://linuxera.org\",\"Subject\":\"team-b@linuxera.org\"}}] Cosign v2 For Cosign v2 to work we need to have an email and uri defined in the SAN fields of the signing certificate. On top of that, we need to pass a certificate identity and a certificate oidc issuer to the verify command. We can pass specific identities and issuers, or use a regexp. We will show both.\nUse specific issuers and identities:\nTeam A:\ncosign-v2 verify --certificate-identity='team-a@linuxera.org' --certificate-oidc-issuer='https://linuxera.org' --insecure-ignore-sct --insecure-ignore-tlog --cert-chain=$WORKDIR/cafiles/root/root-ca.pem $IMAGE_ENDPOINT@$TEAM_A_IMAGE_DIGEST Team B:\ncosign-v2 verify --certificate-identity='team-b@linuxera.org' --certificate-oidc-issuer='https://linuxera.org' --insecure-ignore-sct --insecure-ignore-tlog --cert-chain=$WORKDIR/cafiles/root/root-ca.pem $IMAGE_ENDPOINT@$TEAM_B_IMAGE_DIGEST Use a regexp:\ncosign-v2 verify --certificate-identity-regexp='team-.*@linuxera.org' --certificate-oidc-issuer-regexp='https://linuxer.*.org' --insecure-ignore-sct --insecure-ignore-tlog --cert-chain=$WORKDIR/cafiles/root/root-ca.pem $IMAGE_ENDPOINT@$TEAM_A_IMAGE_DIGEST $IMAGE_ENDPOINT@$TEAM_B_IMAGE_DIGEST Do not verify identities or issuers:\ncosign-v2 verify --certificate-identity-regexp='.*' --certificate-oidc-issuer-regexp='.*' --insecure-ignore-sct --insecure-ignore-tlog --cert-chain=$WORKDIR/cafiles/root/root-ca.pem $IMAGE_ENDPOINT@$TEAM_A_IMAGE_DIGEST $IMAGE_ENDPOINT@$TEAM_B_IMAGE_DIGEST The output for the different validations will be the same as seen in v1.\nGet signature details from our image with Skopeo We can check the containers signature details by using Skopeo. Let’s see an example for Team A image.\nGet the signature tag:\nSIGNATURE_TAG=$(echo $TEAM_A_IMAGE_DIGEST | sed \"s/:/-/\" | sed \"s/$/.sig/\") Get the certificate that signed the image:\nskopeo inspect docker://$IMAGE_ENDPOINT:$SIGNATURE_TAG | jq -r '.LayersData[].Annotations.\"dev.sigstore.cosign/certificate\"' | sed 's/\\\\n/\\n/g' | grep -v null | openssl x509 -text Get the trust chain for the certificate:\nskopeo inspect docker://$IMAGE_ENDPOINT:$SIGNATURE_TAG | jq -r '.LayersData[].Annotations.\"dev.sigstore.cosign/chain\"' | sed 's/\\\\n/\\n/g' | grep -v null Get the signature:\nskopeo inspect docker://$IMAGE_ENDPOINT:$SIGNATURE_TAG | jq -r '.LayersData[].Annotations.\"dev.cosignproject.cosign/signature\"' References https://docs.sigstore.dev/key_management/signing_with_self-managed_keys/ https://github.com/sigstore/cosign/issues/2632 https://github.com/sigstore/cosign/issues/2858 https://github.com/sigstore/cosign/issues/3616 Generate ASN.1 string for Fulcio Extensions Note\nThanks to Hayden Blauzvern for providing the information below and helping with the certificate extensions correctness in the certificate generation section.\nIn Fulcio’s cert profile, extensions 1,1 through 1,6 are raw strings. In 1,8 and future Fulcio extensions this changes to ASN.1 encoded string. You can encode a string using the code below.\npackage main import ( \"encoding/asn1\" \"encoding/base64\" \"fmt\" ) func main() { s := \"https://linuxera.org\" a, _ := asn1.Marshal(s) fmt.Println(a) fmt.Println(base64.StdEncoding.EncodeToString(a)) } ","wordCount":"1794","inLanguage":"en","datePublished":"2024-04-25T00:00:00Z","dateModified":"2024-05-03T00:00:00Z","author":{"@type":"Person","name":"Mario"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://linuxera.org/signing-verifying-container-images-with-cosign-own-pki/"},"publisher":{"@type":"Organization","name":"Linuxera","logo":{"@type":"ImageObject","url":"https://linuxera.org/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://linuxera.org/ accesskey=h title="Linuxera (Alt + H)">Linuxera</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://linuxera.org/ title="🏠 Home"><span>🏠 Home</span></a></li><li><a href=https://linuxera.org/archives/ title="🗄️ Archive"><span>🗄️ Archive</span></a></li><li><a href=https://linuxera.org/search/ title="🔎 Search"><span>🔎 Search</span></a></li><li><a href=https://linuxera.org/tags/ title="🏷️ Tags"><span>🏷️ Tags</span></a></li><li><a href=https://linuxera.org/presentations/ title="🎴 Presentations"><span>🎴 Presentations</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://linuxera.org/>Home</a>&nbsp;»&nbsp;<a href=https://linuxera.org/posts/>Posts</a></div><h1 class=post-title>Signing and verifying container images with Cosign and your own PKI</h1><div class=post-meta><span title='2024-04-25 00:00:00 +0000 UTC'>Published on April 25, 2024</span>&nbsp;·&nbsp;<span title='2024-05-03 00:00:00 +0000 UTC'>Last updated on May 3, 2024</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;Mario</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#signing-and-verifying-container-images-with-cosign-and-your-own-pki aria-label="Signing and verifying container images with Cosign and your own PKI">Signing and verifying container images with Cosign and your own PKI</a><ul><li><a href=#solution-overview aria-label="Solution Overview">Solution Overview</a></li><li><a href=#generating-pki-with-cfssl aria-label="Generating PKI with CFSSL">Generating PKI with CFSSL</a><ul><li><a href=#alternative-openssl-commands aria-label="Alternative OpenSSL commands">Alternative OpenSSL commands</a></li></ul></li><li><a href=#generate-our-container-image aria-label="Generate our container image">Generate our container image</a></li><li><a href=#signing-container-images-with-cosign aria-label="Signing container images with Cosign">Signing container images with Cosign</a><ul><li><a href=#team-a-image-signing aria-label="Team-A Image Signing">Team-A Image Signing</a></li><li><a href=#team-b-image-signing aria-label="Team-B Image Signing">Team-B Image Signing</a></li></ul></li><li><a href=#verifying-container-images-with-cosign-and-our-root-ca aria-label="Verifying container images with Cosign and our Root CA">Verifying container images with Cosign and our Root CA</a><ul><li><a href=#cosign-v1 aria-label="Cosign v1">Cosign v1</a></li><li><a href=#cosign-v2 aria-label="Cosign v2">Cosign v2</a></li></ul></li><li><a href=#get-signature-details-from-our-image-with-skopeo aria-label="Get signature details from our image with Skopeo">Get signature details from our image with Skopeo</a></li><li><a href=#references aria-label=References>References</a></li><li><a href=#generate-asn1-string-for-fulcio-extensions aria-label="Generate ASN.1 string for Fulcio Extensions">Generate ASN.1 string for Fulcio Extensions</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=signing-and-verifying-container-images-with-cosign-and-your-own-pki>Signing and verifying container images with Cosign and your own PKI<a hidden class=anchor aria-hidden=true href=#signing-and-verifying-container-images-with-cosign-and-your-own-pki>#</a></h1><p>In this post we are going to cover how we can sign and verify container images using <a href=https://github.com/sigstore/cosign>Cosign</a> and our own PKI. You can learn more on how to build your own PKI with CFSSL in <a href=https://linuxera.org/pki-with-cfssl/>this post</a>.</p><div class="admonition warning"><p class=admonition-title>Warning</p><p class=admonition>The way we will see to sign and verify images in this post is not the recommended approach. For production usage, you should use ephemeral keys as described <a href=https://docs.sigstore.dev/signing/signing_with_containers/>here</a>. Validity of certificates generated during this post it&rsquo;s not recommended for production usage, make sure in production you have proper validity periods and rotation capabilities in place.</p></div><h2 id=solution-overview>Solution Overview<a hidden class=anchor aria-hidden=true href=#solution-overview>#</a></h2><p>We have our own Root CA that issued an Intermediate CA. This Intermediate CA issued two certificates, one for Team A to sign their images and another one for Team B to sign their images.</p><p>Then, verification of image signatures will be done by using the Root CA public certificate.</p><p><img loading=lazy src=./overview.png alt="Solution Overview"></p><h2 id=generating-pki-with-cfssl>Generating PKI with CFSSL<a hidden class=anchor aria-hidden=true href=#generating-pki-with-cfssl>#</a></h2><ol><li><p>Install required CFSSL binaries:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>sudo curl -L https://github.com/cloudflare/cfssl/releases/download/v1.6.5/cfssl_1.6.5_linux_amd64 -o /usr/local/bin/cfssl
</span></span><span class=line><span class=cl>sudo curl -L https://github.com/cloudflare/cfssl/releases/download/v1.6.5/cfssljson_1.6.5_linux_amd64 -o /usr/local/bin/cfssljson
</span></span><span class=line><span class=cl>sudo chmod +x /usr/local/bin/<span class=o>{</span>cfssl,cfssljson<span class=o>}</span>
</span></span></code></pre></div></li><li><p>Define workdir for the files that will be generated during the post:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>export</span> <span class=nv>WORKDIR</span><span class=o>=</span>/var/tmp/cosign/
</span></span></code></pre></div></li><li><p>Generate Root and Intermediate CAs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>mkdir -p <span class=nv>$WORKDIR</span>/cafiles/<span class=o>{</span>root,intermediate,config,certificates<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=c1># Generate Root CA csr</span>
</span></span><span class=line><span class=cl>cat &lt;&lt; <span class=s2>&#34;EOF&#34;</span> &gt; <span class=nv>$WORKDIR</span>/cafiles/root/root-csr.json
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;Linuxera Root Certificate Authority&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;ecdsa&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;size&#34;</span>: <span class=m>256</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;names&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;C&#34;</span>: <span class=s2>&#34;ES&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;L&#34;</span>: <span class=s2>&#34;Valencia&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;O&#34;</span>: <span class=s2>&#34;IT&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;OU&#34;</span>: <span class=s2>&#34;Security&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;ST&#34;</span>: <span class=s2>&#34;Valencia&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>]</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;ca&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;expiry&#34;</span>: <span class=s2>&#34;87600h&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>EOF
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Generate Intermediate CA csr</span>
</span></span><span class=line><span class=cl>cat &lt;&lt; <span class=s2>&#34;EOF&#34;</span> &gt; <span class=nv>$WORKDIR</span>/cafiles/intermediate/intermediate-csr.json
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;Linuxera Intermediate Certificate Authority&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;ecdsa&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;size&#34;</span>: <span class=m>256</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;names&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;C&#34;</span>: <span class=s2>&#34;ES&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;L&#34;</span>: <span class=s2>&#34;Valencia&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;O&#34;</span>: <span class=s2>&#34;IT&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;OU&#34;</span>: <span class=s2>&#34;Security&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;ST&#34;</span>: <span class=s2>&#34;Valencia&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>EOF
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Issue RootCA keypair</span>
</span></span><span class=line><span class=cl>cfssl gencert -initca <span class=nv>$WORKDIR</span>/cafiles/root/root-csr.json <span class=p>|</span> cfssljson -bare <span class=nv>$WORKDIR</span>/cafiles/root/root-ca
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Generate Intermediate CA key</span>
</span></span><span class=line><span class=cl>cfssl genkey <span class=nv>$WORKDIR</span>/cafiles/intermediate/intermediate-csr.json <span class=p>|</span> cfssljson -bare <span class=nv>$WORKDIR</span>/cafiles/intermediate/intermediate-ca
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Define cfssl profile for the intermediate CA</span>
</span></span><span class=line><span class=cl>cat &lt;&lt; <span class=s2>&#34;EOF&#34;</span> &gt; <span class=nv>$WORKDIR</span>/cafiles/config/config.json
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;signing&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;default&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;expiry&#34;</span>: <span class=s2>&#34;8760h&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;profiles&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;intermediate&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;usages&#34;</span>: <span class=o>[</span><span class=s2>&#34;cert sign&#34;</span>, <span class=s2>&#34;crl sign&#34;</span><span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;expiry&#34;</span>: <span class=s2>&#34;70080h&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ca_constraint&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;is_ca&#34;</span>: true,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;max_path_len&#34;</span>: <span class=m>1</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>EOF
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Issue Intermediate CA cert using RootCA</span>
</span></span><span class=line><span class=cl>cfssl sign -ca <span class=nv>$WORKDIR</span>/cafiles/root/root-ca.pem -ca-key <span class=nv>$WORKDIR</span>/cafiles/root/root-ca-key.pem -config <span class=nv>$WORKDIR</span>/cafiles/config/config.json -profile intermediate <span class=nv>$WORKDIR</span>/cafiles/intermediate/intermediate-ca.csr <span class=p>|</span> cfssljson -bare <span class=nv>$WORKDIR</span>/cafiles/intermediate/intermediate-ca
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Put RootCA key to sleep </span>
</span></span><span class=line><span class=cl>rm -f <span class=nv>$WORKDIR</span>/cafiles/root/root-ca-key.pem
</span></span></code></pre></div></li><li><p>Generate container signing certificates for Team A and Team B:</p><div class="admonition attention"><p class=admonition-title>Attention</p><p class=admonition>For Cosign v2 verification to work, we need our certificates to provide some information in the SAN. We require it to provide a valid email and also to provide a valid oidcIssuer. The oidcIssuer is added via OID, you can find the details <a href=https://github.com/sigstore/fulcio/blob/main/docs/oid-info.md>here</a>. In the certs below you can see two OIDs added as extensions, the value for the one ending in <code>1,1</code> is a base64 encoded raw string, while the one ending in <code>1,8</code> is the base64 encoded ASN.1 string (you can check the code <a href=#generate-asn1-string-for-fulcio-extensions>here</a> to generate the string).</p></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># Define a new cosign profile</span>
</span></span><span class=line><span class=cl>cat &lt;&lt; <span class=s2>&#34;EOF&#34;</span> &gt; <span class=nv>$WORKDIR</span>/cafiles/config/config.json
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;signing&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;default&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;expiry&#34;</span>: <span class=s2>&#34;8760h&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;profiles&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;intermediate&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;usages&#34;</span>: <span class=o>[</span><span class=s2>&#34;cert sign&#34;</span>, <span class=s2>&#34;crl sign&#34;</span><span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;expiry&#34;</span>: <span class=s2>&#34;70080h&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ca_constraint&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;is_ca&#34;</span>: true,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;max_path_len&#34;</span>: 1,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;copy_extensions&#34;</span>: <span class=nb>true</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;cosign&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;usages&#34;</span>: <span class=o>[</span><span class=s2>&#34;signing&#34;</span>, <span class=s2>&#34;digital signing&#34;</span><span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;expiry&#34;</span>: <span class=s2>&#34;8760h&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;copy_extensions&#34;</span>: <span class=nb>true</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>EOF
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Generate cosign keypair for team-a and team-b</span>
</span></span><span class=line><span class=cl><span class=c1># cosign v2 requires email and uri SAN values which are configured under hosts</span>
</span></span><span class=line><span class=cl>cat &lt;&lt; <span class=s2>&#34;EOF&#34;</span> &gt; <span class=nv>$WORKDIR</span>/cafiles/certificates/team-a-csr.json
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;Team A Cosign Certificate&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;ecdsa&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;size&#34;</span>: <span class=m>256</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;names&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;C&#34;</span>: <span class=s2>&#34;ES&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;L&#34;</span>: <span class=s2>&#34;Valencia&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;O&#34;</span>: <span class=s2>&#34;IT&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;OU&#34;</span>: <span class=s2>&#34;Security&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>]</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hosts&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;team-a@linuxera.org&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>]</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;extensions&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;id&#34;</span>: <span class=o>[</span>1,3,6,1,4,1,57264,1,8<span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;value&#34;</span>: <span class=s2>&#34;ExRodHRwczovL2xpbnV4ZXJhLm9yZw==&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;id&#34;</span>: <span class=o>[</span>1,3,6,1,4,1,57264,1,1<span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;value&#34;</span>: <span class=s2>&#34;aHR0cHM6Ly9saW51eGVyYS5vcmc=&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>EOF
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &lt;&lt; <span class=s2>&#34;EOF&#34;</span> &gt; <span class=nv>$WORKDIR</span>/cafiles/certificates/team-b-csr.json
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;Team B Cosign Certificate&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;ecdsa&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;size&#34;</span>: <span class=m>256</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;names&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;C&#34;</span>: <span class=s2>&#34;ES&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;L&#34;</span>: <span class=s2>&#34;Valencia&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;O&#34;</span>: <span class=s2>&#34;IT&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;OU&#34;</span>: <span class=s2>&#34;Security&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>]</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hosts&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;team-b@linuxera.org&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>]</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;extensions&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;id&#34;</span>: <span class=o>[</span>1,3,6,1,4,1,57264,1,8<span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;value&#34;</span>: <span class=s2>&#34;ExRodHRwczovL2xpbnV4ZXJhLm9yZw==&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;id&#34;</span>: <span class=o>[</span>1,3,6,1,4,1,57264,1,1<span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;value&#34;</span>: <span class=s2>&#34;aHR0cHM6Ly9saW51eGVyYS5vcmc=&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>EOF
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Issue certificates via the intermediate CA</span>
</span></span><span class=line><span class=cl>cfssl gencert -ca <span class=nv>$WORKDIR</span>/cafiles/intermediate/intermediate-ca.pem -ca-key <span class=nv>$WORKDIR</span>/cafiles/intermediate/intermediate-ca-key.pem -config <span class=nv>$WORKDIR</span>/cafiles/config/config.json -profile cosign <span class=nv>$WORKDIR</span>/cafiles/certificates/team-a-csr.json <span class=p>|</span> cfssljson -bare <span class=nv>$WORKDIR</span>/cafiles/certificates/team-a
</span></span><span class=line><span class=cl>cfssl gencert -ca <span class=nv>$WORKDIR</span>/cafiles/intermediate/intermediate-ca.pem -ca-key <span class=nv>$WORKDIR</span>/cafiles/intermediate/intermediate-ca-key.pem -config <span class=nv>$WORKDIR</span>/cafiles/config/config.json -profile cosign <span class=nv>$WORKDIR</span>/cafiles/certificates/team-b-csr.json <span class=p>|</span> cfssljson -bare <span class=nv>$WORKDIR</span>/cafiles/certificates/team-b
</span></span></code></pre></div></li></ol><h3 id=alternative-openssl-commands>Alternative OpenSSL commands<a hidden class=anchor aria-hidden=true href=#alternative-openssl-commands>#</a></h3><p>In case you want to rather use OpenSSL, these are the commands you need to run. Thanks to <a href=https://www.linkedin.com/in/fredericherrmann/>Frédéric Herrmann</a> for sharing the information.</p><div class="admonition attention"><p class=admonition-title>Attention</p><p class=admonition>Commands below use RSA as encryption algorithm.</p></div><ol><li><p>Generate Root CA</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>openssl req -x509 -newkey rsa:4096 -keyout root-ca-key.pem -sha256 -noenc -days <span class=m>9999</span> -subj <span class=s2>&#34;/C=ES/L=Valencia/O=IT/OU=Security/CN=Linuxera Root Certificate Authority&#34;</span> -out root-ca.pem
</span></span></code></pre></div></li><li><p>Generate Intermediate CA</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># Create request</span>
</span></span><span class=line><span class=cl>openssl req -noenc -newkey rsa:4096 -keyout intermediate-ca-key.pem -addext <span class=s2>&#34;subjectKeyIdentifier = hash&#34;</span> -addext <span class=s2>&#34;keyUsage = critical,keyCertSign&#34;</span> -addext <span class=s2>&#34;basicConstraints = critical,CA:TRUE,pathlen:2&#34;</span> -subj <span class=s2>&#34;/C=ES/L=Valencia/O=IT/OU=Security/CN=Linuxera Intermediate Certificate Authority&#34;</span> -out intermediate-ca.csr
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Issue cert with Root CA</span>
</span></span><span class=line><span class=cl>openssl x509 -req -days <span class=m>9999</span> -sha256 -in intermediate-ca.csr -CA root-ca.pem -CAkey root-ca-key.pem -copy_extensions copy -out intermediate-ca.pem
</span></span></code></pre></div></li><li><p>Issue Team A cert</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># OID_1_1 is the hexadecimal representation of the oidcissuer url</span>
</span></span><span class=line><span class=cl><span class=nv>OID_1_1</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> -n <span class=s2>&#34;https://linuxera.org&#34;</span> <span class=p>|</span> xxd -p -u<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=c1># Create request</span>
</span></span><span class=line><span class=cl>openssl req -noenc -newkey rsa:4096 -keyout team-a-key.pem -addext <span class=s2>&#34;subjectKeyIdentifier = hash&#34;</span> -addext <span class=s2>&#34;basicConstraints = critical,CA:FALSE&#34;</span> -addext <span class=s2>&#34;keyUsage = critical,digitalSignature&#34;</span> -addext <span class=s2>&#34;subjectAltName = email:team-a@linuxera.org&#34;</span> -addext <span class=s2>&#34;1.3.6.1.4.1.57264.1.1 = DER:</span><span class=si>${</span><span class=nv>OID_1_1</span><span class=si>}</span><span class=s2>&#34;</span> -addext <span class=s2>&#34;1.3.6.1.4.1.57264.1.8 = ASN1:UTF8String:https://linuxera.org&#34;</span> -subj <span class=s2>&#34;/C=ES/L=Valencia/O=IT/OU=Security/CN=Team A Cosign Certificate&#34;</span> -out team-a.csr
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Issue cert with Intermediate CA</span>
</span></span><span class=line><span class=cl>openssl x509 -req -in team-a.csr -CA intermediate-ca.pem -CAkey intermediate-ca-key.pem -copy_extensions copy -days <span class=m>9999</span> -sha256 -out team-a.pem
</span></span></code></pre></div></li><li><p>Issue Team B cert</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># OID_1_1 is the hexadecimal representation of the oidcissuer url</span>
</span></span><span class=line><span class=cl><span class=nv>OID_1_1</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> -n <span class=s2>&#34;https://linuxera.org&#34;</span> <span class=p>|</span> xxd -p -u<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=c1># Create request</span>
</span></span><span class=line><span class=cl>openssl req -noenc -newkey rsa:4096 -keyout team-b-key.pem -addext <span class=s2>&#34;subjectKeyIdentifier = hash&#34;</span> -addext <span class=s2>&#34;basicConstraints = critical,CA:FALSE&#34;</span> -addext <span class=s2>&#34;keyUsage = critical,digitalSignature&#34;</span> -addext <span class=s2>&#34;subjectAltName = email:team-b@linuxera.org&#34;</span> -addext <span class=s2>&#34;1.3.6.1.4.1.57264.1.1 = DER:</span><span class=si>${</span><span class=nv>OID_1_1</span><span class=si>}</span><span class=s2>&#34;</span> -addext <span class=s2>&#34;1.3.6.1.4.1.57264.1.8 = ASN1:UTF8String:https://linuxera.org&#34;</span> -subj <span class=s2>&#34;/C=ES/L=Valencia/O=IT/OU=Security/CN=Team B Cosign Certificate&#34;</span> -out team-b.csr
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Issue cert with Intermediate CA</span>
</span></span><span class=line><span class=cl>openssl x509 -req -in team-b.csr -CA intermediate-ca.pem -CAkey intermediate-ca-key.pem -copy_extensions copy -days <span class=m>9999</span> -sha256 -out team-b.pem
</span></span></code></pre></div></li></ol><h2 id=generate-our-container-image>Generate our container image<a hidden class=anchor aria-hidden=true href=#generate-our-container-image>#</a></h2><p>We need a container image we will sign, on top of that we require our registry to support the upload of Cosign signatures. For this post I&rsquo;ll be using <a href=https://quay.io>quay.io</a>.</p><ol><li><p>Define our Quay image repository:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nv>IMAGE_ENDPOINT</span><span class=o>=</span>quay.io/example/signingtest
</span></span></code></pre></div></li><li><p>Generate a Dockerfile:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cat <span class=s>&lt;&lt;&#39;EOF&#39; &gt; $WORKDIR/Dockerfile
</span></span></span><span class=line><span class=cl><span class=s>FROM registry.fedoraproject.org/fedora-minimal:39
</span></span></span><span class=line><span class=cl><span class=s>ARG GREETING
</span></span></span><span class=line><span class=cl><span class=s>RUN echo $GREETING &gt; /tmp/HelloWorld
</span></span></span><span class=line><span class=cl><span class=s>USER 1024
</span></span></span><span class=line><span class=cl><span class=s>CMD [&#34;sleep&#34;, &#34;infinity&#34;]
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div></li><li><p>Build the images for Team A and Team B:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>podman build -f <span class=nv>$WORKDIR</span>/Dockerfile --build-arg <span class=nv>GREETING</span><span class=o>=</span><span class=s2>&#34;Hello from Team A&#34;</span> -t <span class=nv>$IMAGE_ENDPOINT</span>:team-a
</span></span><span class=line><span class=cl>podman build -f <span class=nv>$WORKDIR</span>/Dockerfile --build-arg <span class=nv>GREETING</span><span class=o>=</span><span class=s2>&#34;Hello from Team B&#34;</span> -t <span class=nv>$IMAGE_ENDPOINT</span>:team-b
</span></span></code></pre></div></li><li><p>Push the images to the registry and store the images digest locally, this is required since we sign image digests, not tags:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>podman push --digestfile <span class=nv>$WORKDIR</span>/image-digest-team-a <span class=nv>$IMAGE_ENDPOINT</span>:team-a
</span></span><span class=line><span class=cl>podman push --digestfile <span class=nv>$WORKDIR</span>/image-digest-team-b <span class=nv>$IMAGE_ENDPOINT</span>:team-b
</span></span></code></pre></div></li></ol><h2 id=signing-container-images-with-cosign>Signing container images with Cosign<a hidden class=anchor aria-hidden=true href=#signing-container-images-with-cosign>#</a></h2><div class="admonition attention"><p class=admonition-title>Attention</p><p class=admonition>During the exploratory work I started testing Cosign v1, that&rsquo;s why I will document here how you can sign container images using v1. The steps that differ between both versions will have both options described. Nevertheless, you should be using v2.</p></div><ol><li><p>Download Cosign CLI</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>sudo curl -L https://github.com/sigstore/cosign/releases/download/v1.13.6/cosign-linux-amd64 -o /usr/local/bin/cosign-v1
</span></span><span class=line><span class=cl>sudo curl -L https://github.com/sigstore/cosign/releases/download/v2.2.4/cosign-linux-amd64 -o /usr/local/bin/cosign-v2
</span></span><span class=line><span class=cl>sudo chmod +x /usr/local/bin/cosign-v1
</span></span><span class=line><span class=cl>sudo chmod +x /usr/local/bin/cosign-v2
</span></span></code></pre></div></li><li><p>Build trust chain bundle (must start with the parent intermediate CA certificate of the signing certificate and end with the root certificate):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cat <span class=nv>$WORKDIR</span>/cafiles/intermediate/intermediate-ca.pem <span class=nv>$WORKDIR</span>/cafiles/root/root-ca.pem &gt; <span class=nv>$WORKDIR</span>/ca-bundle.pem
</span></span></code></pre></div></li></ol><h3 id=team-a-image-signing>Team-A Image Signing<a hidden class=anchor aria-hidden=true href=#team-a-image-signing>#</a></h3><ol><li><p>Store container image digest:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nv>TEAM_A_IMAGE_DIGEST</span><span class=o>=</span><span class=k>$(</span>cat <span class=nv>$WORKDIR</span>/image-digest-team-a<span class=k>)</span>
</span></span></code></pre></div></li><li><p>Import key into Cosign:</p><ol><li><p>With v1:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cosign-v1 import-key-pair --key <span class=nv>$WORKDIR</span>/cafiles/certificates/team-a-key.pem
</span></span><span class=line><span class=cl>mv import-cosign.key <span class=nv>$WORKDIR</span>/import-team-a.key
</span></span><span class=line><span class=cl>mv import-cosign.pub <span class=nv>$WORKDIR</span>/import-team-a.pub
</span></span></code></pre></div></li><li><p>With v2:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cosign-v2 import-key-pair --key <span class=nv>$WORKDIR</span>/cafiles/certificates/team-a-key.pem --output-key-prefix<span class=o>=</span><span class=nv>$WORKDIR</span>/import-team-a
</span></span></code></pre></div></li></ol></li><li><p>Sign with Cosign and our own key without uploading to transparency log:</p><ol><li><p>With v1:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cosign-v1 sign --key <span class=nv>$WORKDIR</span>/import-team-a.key --no-tlog-upload --cert <span class=nv>$WORKDIR</span>/cafiles/certificates/team-a.pem --cert-chain <span class=nv>$WORKDIR</span>/ca-bundle.pem <span class=nv>$IMAGE_ENDPOINT</span>@<span class=nv>$TEAM_A_IMAGE_DIGEST</span>
</span></span></code></pre></div></li><li><p>With v2:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cosign-v2 sign --key <span class=nv>$WORKDIR</span>/import-team-a.key --tlog-upload<span class=o>=</span><span class=nb>false</span> --cert <span class=nv>$WORKDIR</span>/cafiles/certificates/team-a.pem --cert-chain <span class=nv>$WORKDIR</span>/ca-bundle.pem <span class=nv>$IMAGE_ENDPOINT</span>@<span class=nv>$TEAM_A_IMAGE_DIGEST</span>
</span></span></code></pre></div></li></ol></li></ol><h3 id=team-b-image-signing>Team-B Image Signing<a hidden class=anchor aria-hidden=true href=#team-b-image-signing>#</a></h3><ol><li><p>Store container image digest:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nv>TEAM_B_IMAGE_DIGEST</span><span class=o>=</span><span class=k>$(</span>cat <span class=nv>$WORKDIR</span>/image-digest-team-b<span class=k>)</span>
</span></span></code></pre></div></li><li><p>Import key into Cosign:</p><ol><li><p>With v1:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cosign-v1 import-key-pair --key <span class=nv>$WORKDIR</span>/cafiles/certificates/team-b-key.pem
</span></span><span class=line><span class=cl>mv import-cosign.key <span class=nv>$WORKDIR</span>/import-team-b.key
</span></span><span class=line><span class=cl>mv import-cosign.pub <span class=nv>$WORKDIR</span>/import-team-b.pub
</span></span></code></pre></div></li><li><p>With v2:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cosign-v2 import-key-pair --key <span class=nv>$WORKDIR</span>/cafiles/certificates/team-b-key.pem --output-key-prefix<span class=o>=</span><span class=nv>$WORKDIR</span>/import-team-b
</span></span></code></pre></div></li></ol></li><li><p>Sign with Cosign and our own key without uploading to transparency log:</p><ol><li><p>With v1:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cosign-v1 sign --key <span class=nv>$WORKDIR</span>/import-team-b.key --no-tlog-upload --cert <span class=nv>$WORKDIR</span>/cafiles/certificates/team-b.pem --cert-chain <span class=nv>$WORKDIR</span>/ca-bundle.pem <span class=nv>$IMAGE_ENDPOINT</span>@<span class=nv>$TEAM_B_IMAGE_DIGEST</span>
</span></span></code></pre></div></li><li><p>With v2:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cosign-v2 sign --key <span class=nv>$WORKDIR</span>/import-team-b.key --tlog-upload<span class=o>=</span><span class=nb>false</span> --cert <span class=nv>$WORKDIR</span>/cafiles/certificates/team-b.pem --cert-chain <span class=nv>$WORKDIR</span>/ca-bundle.pem <span class=nv>$IMAGE_ENDPOINT</span>@<span class=nv>$TEAM_B_IMAGE_DIGEST</span>
</span></span></code></pre></div></li></ol></li></ol><h2 id=verifying-container-images-with-cosign-and-our-root-ca>Verifying container images with Cosign and our Root CA<a hidden class=anchor aria-hidden=true href=#verifying-container-images-with-cosign-and-our-root-ca>#</a></h2><p>We can verify the image signature in multiple ways, in this case we want to use only the Root CA public certificate to run the verification. Keep in mind that Cosign v2 doesn&rsquo;t work with BYOK like v1 used to do. <a href=https://github.com/sigstore/cosign/issues/2632>More info here</a>.</p><h3 id=cosign-v1>Cosign v1<a hidden class=anchor aria-hidden=true href=#cosign-v1>#</a></h3><p>We need to disable rekor-url since we haven&rsquo;t uploaded anything to the transparency log. <a href=https://github.com/sigstore/cosign/issues/2858>More here</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nv>SIGSTORE_ROOT_FILE</span><span class=o>=</span><span class=nv>$WORKDIR</span>/cafiles/root/root-ca.pem <span class=nv>COSIGN_EXPERIMENTAL</span><span class=o>=</span><span class=m>1</span> cosign-v1 verify --rekor-url<span class=o>=</span><span class=s2>&#34;&#34;</span> <span class=nv>$IMAGE_ENDPOINT</span>@<span class=nv>$TEAM_A_IMAGE_DIGEST</span> <span class=nv>$IMAGE_ENDPOINT</span>@<span class=nv>$TEAM_B_IMAGE_DIGEST</span>
</span></span></code></pre></div><pre tabindex=0><code class=language-output data-lang=output>Verification for quay.io/example/signingtest@sha256:81a274fb4ed001132969dcf03de244d6f9b36d42d2b688b09a1c2d67691e6e41 --
The following checks were performed on each of these signatures:
  - The cosign claims were validated
  - Any certificates were verified against the Fulcio roots.

[{&#34;critical&#34;:{&#34;identity&#34;:{&#34;docker-reference&#34;:&#34;quay.io/example/signingtest&#34;},&#34;image&#34;:{&#34;docker-manifest-digest&#34;:&#34;sha256:81a274fb4ed001132969dcf03de244d6f9b36d42d2b688b09a1c2d67691e6e41&#34;},&#34;type&#34;:&#34;cosign container image signature&#34;},&#34;optional&#34;:{&#34;1.3.6.1.4.1.57264.1.1&#34;:&#34;https://linuxera.org&#34;,&#34;Issuer&#34;:&#34;https://linuxera.org&#34;,&#34;Subject&#34;:&#34;team-a@linuxera.org&#34;}}]

Verification for quay.io/example/signingtest@sha256:3bf90da5cd72d0057e4f06faf5669004262885005e662a93706fa85627d62cc5 --
The following checks were performed on each of these signatures:
  - The cosign claims were validated
  - Any certificates were verified against the Fulcio roots.

[{&#34;critical&#34;:{&#34;identity&#34;:{&#34;docker-reference&#34;:&#34;quay.io/example/signingtest&#34;},&#34;image&#34;:{&#34;docker-manifest-digest&#34;:&#34;sha256:3bf90da5cd72d0057e4f06faf5669004262885005e662a93706fa85627d62cc5&#34;},&#34;type&#34;:&#34;cosign container image signature&#34;},&#34;optional&#34;:{&#34;1.3.6.1.4.1.57264.1.1&#34;:&#34;https://linuxera.org&#34;,&#34;Issuer&#34;:&#34;https://linuxera.org&#34;,&#34;Subject&#34;:&#34;team-b@linuxera.org&#34;}}]
</code></pre><h3 id=cosign-v2>Cosign v2<a hidden class=anchor aria-hidden=true href=#cosign-v2>#</a></h3><p>For Cosign v2 to work we need to have an email and uri defined in the SAN fields of the signing certificate. On top of that, we need to pass a certificate identity and a certificate oidc issuer to the verify command. We can pass specific identities and issuers, or use a regexp. We will show both.</p><ol><li><p>Use specific issuers and identities:</p><ol><li><p>Team A:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cosign-v2 verify --certificate-identity<span class=o>=</span><span class=s1>&#39;team-a@linuxera.org&#39;</span> --certificate-oidc-issuer<span class=o>=</span><span class=s1>&#39;https://linuxera.org&#39;</span> --insecure-ignore-sct --insecure-ignore-tlog --cert-chain<span class=o>=</span><span class=nv>$WORKDIR</span>/cafiles/root/root-ca.pem  <span class=nv>$IMAGE_ENDPOINT</span>@<span class=nv>$TEAM_A_IMAGE_DIGEST</span>
</span></span></code></pre></div></li><li><p>Team B:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cosign-v2 verify --certificate-identity<span class=o>=</span><span class=s1>&#39;team-b@linuxera.org&#39;</span> --certificate-oidc-issuer<span class=o>=</span><span class=s1>&#39;https://linuxera.org&#39;</span> --insecure-ignore-sct --insecure-ignore-tlog --cert-chain<span class=o>=</span><span class=nv>$WORKDIR</span>/cafiles/root/root-ca.pem  <span class=nv>$IMAGE_ENDPOINT</span>@<span class=nv>$TEAM_B_IMAGE_DIGEST</span>
</span></span></code></pre></div></li></ol></li><li><p>Use a regexp:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cosign-v2 verify --certificate-identity-regexp<span class=o>=</span><span class=s1>&#39;team-.*@linuxera.org&#39;</span> --certificate-oidc-issuer-regexp<span class=o>=</span><span class=s1>&#39;https://linuxer.*.org&#39;</span> --insecure-ignore-sct --insecure-ignore-tlog --cert-chain<span class=o>=</span><span class=nv>$WORKDIR</span>/cafiles/root/root-ca.pem <span class=nv>$IMAGE_ENDPOINT</span>@<span class=nv>$TEAM_A_IMAGE_DIGEST</span> <span class=nv>$IMAGE_ENDPOINT</span>@<span class=nv>$TEAM_B_IMAGE_DIGEST</span>
</span></span></code></pre></div></li><li><p>Do not verify identities or issuers:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cosign-v2 verify --certificate-identity-regexp<span class=o>=</span><span class=s1>&#39;.*&#39;</span> --certificate-oidc-issuer-regexp<span class=o>=</span><span class=s1>&#39;.*&#39;</span> --insecure-ignore-sct --insecure-ignore-tlog --cert-chain<span class=o>=</span><span class=nv>$WORKDIR</span>/cafiles/root/root-ca.pem  <span class=nv>$IMAGE_ENDPOINT</span>@<span class=nv>$TEAM_A_IMAGE_DIGEST</span> <span class=nv>$IMAGE_ENDPOINT</span>@<span class=nv>$TEAM_B_IMAGE_DIGEST</span>
</span></span></code></pre></div></li></ol><p>The output for the different validations will be the same as seen in v1.</p><h2 id=get-signature-details-from-our-image-with-skopeo>Get signature details from our image with Skopeo<a hidden class=anchor aria-hidden=true href=#get-signature-details-from-our-image-with-skopeo>#</a></h2><p>We can check the containers signature details by using Skopeo. Let&rsquo;s see an example for Team A image.</p><ol><li><p>Get the signature tag:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nv>SIGNATURE_TAG</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$TEAM_A_IMAGE_DIGEST</span> <span class=p>|</span> sed <span class=s2>&#34;s/:/-/&#34;</span> <span class=p>|</span> sed <span class=s2>&#34;s/</span>$<span class=s2>/.sig/&#34;</span><span class=k>)</span>
</span></span></code></pre></div></li><li><p>Get the certificate that signed the image:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>skopeo inspect docker://<span class=nv>$IMAGE_ENDPOINT</span>:<span class=nv>$SIGNATURE_TAG</span> <span class=p>|</span> jq -r <span class=s1>&#39;.LayersData[].Annotations.&#34;dev.sigstore.cosign/certificate&#34;&#39;</span> <span class=p>|</span> sed <span class=s1>&#39;s/\\n/\n/g&#39;</span> <span class=p>|</span> grep -v null <span class=p>|</span> openssl x509 -text
</span></span></code></pre></div></li><li><p>Get the trust chain for the certificate:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>skopeo inspect docker://<span class=nv>$IMAGE_ENDPOINT</span>:<span class=nv>$SIGNATURE_TAG</span> <span class=p>|</span> jq -r <span class=s1>&#39;.LayersData[].Annotations.&#34;dev.sigstore.cosign/chain&#34;&#39;</span> <span class=p>|</span> sed <span class=s1>&#39;s/\\n/\n/g&#39;</span> <span class=p>|</span> grep -v null
</span></span></code></pre></div></li><li><p>Get the signature:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>skopeo inspect docker://<span class=nv>$IMAGE_ENDPOINT</span>:<span class=nv>$SIGNATURE_TAG</span> <span class=p>|</span> jq -r <span class=s1>&#39;.LayersData[].Annotations.&#34;dev.cosignproject.cosign/signature&#34;&#39;</span>
</span></span></code></pre></div></li></ol><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ul><li><a href=https://docs.sigstore.dev/key_management/signing_with_self-managed_keys/>https://docs.sigstore.dev/key_management/signing_with_self-managed_keys/</a></li><li><a href=https://github.com/sigstore/cosign/issues/2632>https://github.com/sigstore/cosign/issues/2632</a></li><li><a href=https://github.com/sigstore/cosign/issues/2858>https://github.com/sigstore/cosign/issues/2858</a></li><li><a href=https://github.com/sigstore/cosign/issues/3616>https://github.com/sigstore/cosign/issues/3616</a></li></ul><h2 id=generate-asn1-string-for-fulcio-extensions>Generate ASN.1 string for Fulcio Extensions<a hidden class=anchor aria-hidden=true href=#generate-asn1-string-for-fulcio-extensions>#</a></h2><div class="admonition tip"><p class=admonition-title>Note</p><p class=admonition>Thanks to <a href=https://github.com/haydentherapper>Hayden Blauzvern</a> for providing the information below and helping with the certificate extensions correctness in the certificate generation section.</p></div><p>In Fulcio&rsquo;s cert profile, extensions <code>1,1</code> through <code>1,6</code> are raw strings. In <code>1,8</code> and future Fulcio extensions this changes to ASN.1 encoded string. You can encode a string using the code below.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;encoding/asn1&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;encoding/base64&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>:=</span> <span class=s>&#34;https://linuxera.org&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>a</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>asn1</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>base64</span><span class=p>.</span><span class=nx>StdEncoding</span><span class=p>.</span><span class=nf>EncodeToString</span><span class=p>(</span><span class=nx>a</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://linuxera.org/tags/cosing/>cosing</a></li><li><a href=https://linuxera.org/tags/sigstore/>sigstore</a></li><li><a href=https://linuxera.org/tags/byok/>byok</a></li><li><a href=https://linuxera.org/tags/pki/>pki</a></li><li><a href=https://linuxera.org/tags/security/>security</a></li></ul><nav class=paginav><a class=next href=https://linuxera.org/extending-vxlan-across-nodes-with-wireguard/><span class=title>Next »</span><br><span>Extending a VXLAN across nodes with Wireguard</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Signing and verifying container images with Cosign and your own PKI on twitter" href="https://twitter.com/intent/tweet/?text=Signing%20and%20verifying%20container%20images%20with%20Cosign%20and%20your%20own%20PKI&url=https%3a%2f%2flinuxera.org%2fsigning-verifying-container-images-with-cosign-own-pki%2f&hashtags=cosing%2csigstore%2cbyok%2cpki%2csecurity"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Signing and verifying container images with Cosign and your own PKI on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2flinuxera.org%2fsigning-verifying-container-images-with-cosign-own-pki%2f&title=Signing%20and%20verifying%20container%20images%20with%20Cosign%20and%20your%20own%20PKI&summary=Signing%20and%20verifying%20container%20images%20with%20Cosign%20and%20your%20own%20PKI&source=https%3a%2f%2flinuxera.org%2fsigning-verifying-container-images-with-cosign-own-pki%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></div></footer><div class=share-buttons><p>If this post has been helpful to you, consider <u><a target=_blank href=https://ko-fi.com/mvazce>supporting the work.</a></u></p></div><script src=https://utteranc.es/client.js repo=mvazquezc/mvazquezc.github.io issue-term=pathname label=blog-comments theme=preferred-color-scheme crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://linuxera.org/>Linuxera</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>