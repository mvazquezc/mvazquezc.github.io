<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Exposing multiple Kubernetes clusters with a single load balancer and a single public IP | Linuxera</title><meta name=keywords content="kubernetes,openshift,haproxy,loadbalancer"><meta name=description content="Exposing multiple Kubernetes clusters with a single load balancer and a single public IP My colleague Alberto Losada and I have been working on a lab lately. The lab is composed of three OpenShift clusters on VMs, these VMs are deployed on an isolated libvirt network, which means that we cannot access them from outside the hypervisor.
In order to solve this issue, we wanted to expose the three clusters using the public IP available in the hypervisor."><meta name=author content="Mario"><link rel=canonical href=https://linuxera.org/exposing-multiple-kubernetes-clusters-single-lb-and-ip/><link crossorigin=anonymous href=/assets/css/stylesheet.8cc7ef3cdd44c5188f9267864f378d8dd8892d583e0fd07b5e5321e496f1e4d1.css integrity="sha256-jMfvPN1ExRiPkmeGTzeNjdiJLVg+D9B7XlMh5Jbx5NE=" rel="preload stylesheet" as=style><link rel=icon href=https://linuxera.org/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://linuxera.org/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://linuxera.org/favicon-32x32.png><link rel=apple-touch-icon href=https://linuxera.org/apple-touch-icon.png><link rel=mask-icon href=https://linuxera.org/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer data-domain=linuxera.org src=https://stats.linuxera.org/js/script.file-downloads.hash.outbound-links.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script><meta property="og:title" content="Exposing multiple Kubernetes clusters with a single load balancer and a single public IP"><meta property="og:description" content="Exposing multiple Kubernetes clusters with a single load balancer and a single public IP My colleague Alberto Losada and I have been working on a lab lately. The lab is composed of three OpenShift clusters on VMs, these VMs are deployed on an isolated libvirt network, which means that we cannot access them from outside the hypervisor.
In order to solve this issue, we wanted to expose the three clusters using the public IP available in the hypervisor."><meta property="og:type" content="article"><meta property="og:url" content="https://linuxera.org/exposing-multiple-kubernetes-clusters-single-lb-and-ip/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-21T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-21T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Exposing multiple Kubernetes clusters with a single load balancer and a single public IP"><meta name=twitter:description content="Exposing multiple Kubernetes clusters with a single load balancer and a single public IP My colleague Alberto Losada and I have been working on a lab lately. The lab is composed of three OpenShift clusters on VMs, these VMs are deployed on an isolated libvirt network, which means that we cannot access them from outside the hypervisor.
In order to solve this issue, we wanted to expose the three clusters using the public IP available in the hypervisor."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://linuxera.org/posts/"},{"@type":"ListItem","position":2,"name":"Exposing multiple Kubernetes clusters with a single load balancer and a single public IP","item":"https://linuxera.org/exposing-multiple-kubernetes-clusters-single-lb-and-ip/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Exposing multiple Kubernetes clusters with a single load balancer and a single public IP","name":"Exposing multiple Kubernetes clusters with a single load balancer and a single public IP","description":"Exposing multiple Kubernetes clusters with a single load balancer and a single public IP My colleague Alberto Losada and I have been working on a lab lately. The lab is composed of three OpenShift clusters on VMs, these VMs are deployed on an isolated libvirt network, which means that we cannot access them from outside the hypervisor.\nIn order to solve this issue, we wanted to expose the three clusters using the public IP available in the hypervisor.","keywords":["kubernetes","openshift","haproxy","loadbalancer"],"articleBody":"Exposing multiple Kubernetes clusters with a single load balancer and a single public IP My colleague Alberto Losada and I have been working on a lab lately. The lab is composed of three OpenShift clusters on VMs, these VMs are deployed on an isolated libvirt network, which means that we cannot access them from outside the hypervisor.\nIn order to solve this issue, we wanted to expose the three clusters using the public IP available in the hypervisor. This setup should be valid for any Kubernetes cluster.\nAPI and Ingress endpoints In our case, our OpenShift clusters have two different endpoints, one for the Kubernetes API Server, and another one for the cluster Ingress:\nAPI Endpoint: 6443 port on control plane nodes Cluster Ingress: 80 and 443 ports on compute nodes We have three clusters:\nhub-cluster.linuxera.lab managed1.linuxera.lab managed2. linuxera.lab Each cluster has two DNS records:\napi.. -\u003e points to the hypervisor public IP *.apps.. -\u003e points to the hypervisor public IP For example, for the hub-cluster we will have: api.hub-cluster.linuxera.lab and *.apps.hub-cluster.linuxera.lab.\nLoad balancing requirements Usually, when you want to expose multiple clusters under the same load balancer you either use different public IPs, or different ports. For example, if you wanted to expose three clusters you could use three different IPs. Your load balancer will listen for connections on these IPs and depending on the IP receiving the request the load balancer will redirect traffic to the cluster exposed by that IP.\nA different approach would be using the same IP for the load balancer but different ports, for example cluster1 API will be published in port 6443, cluster2 in port 6444, etc.\nIn this lab environment we only had a public IP, and we didn’t want to use different ports. We wanted to be able to route request based on the destination cluster. On top of that, we didn’t want to do TLS termination in the load balancer, instead we wanted the different clusters to do that.\nDetecting destination for the connections Users using our clusters will connect to the different clusters APIs and ingress endpoints. When they do that, depending on the destination cluster these connections will have different information that we can use to redirect those connections to the proper cluster.\nFor connections going to the HTTP Ingress endpoint we will use the Host header. For TLS connections going to the HTTPS/API ingress endpoints we will use the SNI from the TLS handshake.\nOur solution We decided to go with HAProxy. The architecture looks like this:\nAnd our configuration file:\nglobal log 127.0.0.1 local2 maxconn 4000 daemon defaults mode tcp log global retries 3 timeout http-request 10s timeout queue 1m timeout connect 10s timeout client 1m timeout server 1m timeout http-keep-alive 10s timeout check 10s maxconn 3000 listen stats-50000 bind :50000 mode http log global maxconn 10 timeout client 100s timeout server 100s timeout connect 100s stats enable stats hide-version stats refresh 30s stats show-node stats auth admin:password stats uri /haproxy?stats frontend apis-6443 bind :6443 mode tcp tcp-request inspect-delay 5s tcp-request content accept if { req_ssl_hello_type 1 } acl ACL_hub req_ssl_sni -i api.hub-cluster.linuxera.lab acl ACL_managed1 req_ssl_sni -i api.managed1.linuxera.lab acl ACL_managed2 req_ssl_sni -i api.managed2.linuxera.lab use_backend be_api_hub_6443 if ACL_hub use_backend be_api_managed1_6443 if ACL_managed1 use_backend be_api_managed2_6443 if ACL_managed2 frontend routers-http-80 bind :80 mode http acl ACL_hub hdr(host) -m reg -i ^[^\\.]+\\.apps\\.hub\\.linuxera\\.lab acl ACL_managed1 hdr(host) -m reg -i ^[^\\.]+\\.apps\\.managed1\\.linuxera\\.lab acl ACL_managed2 hdr(host) -m reg -i ^[^\\.]+\\.apps\\.managed2\\.linuxera\\.lab use_backend be_ingress_hub_80 if ACL_hub use_backend be_ingress_managed1_80 if ACL_managed1 use_backend be_ingress_managed2_80 if ACL_managed2 frontend routers-https-443 bind :443 mode tcp tcp-request inspect-delay 5s tcp-request content accept if { req_ssl_hello_type 1 } acl ACL_hub req_ssl_sni -m reg -i ^[^\\.]+\\.apps\\.hub\\.linuxera\\.lab acl ACL_managed1 req_ssl_sni -m reg -i ^[^\\.]+\\.apps\\.managed1\\.linuxera\\.lab acl ACL_managed2 req_ssl_sni -m reg -i ^[^\\.]+\\.apps\\.managed2\\.linuxera\\.lab use_backend be_ingress_hub_443 if ACL_hub use_backend be_ingress_managed1_443 if ACL_managed1 use_backend be_ingress_managed2_443 if ACL_managed2 backend be_api_hub_6443 mode tcp balance source option ssl-hello-chk server controlplane0 192.168.125.20:6443 check inter 1s server controlplane1 192.168.125.21:6443 check inter 1s server controlplane2 192.168.125.22:6443 check inter 1s backend be_api_managed1_6443 mode tcp balance source option ssl-hello-chk server controlplane0 192.168.125.30:6443 check inter 1s server controlplane1 192.168.125.31:6443 check inter 1s server controlplane2 192.168.125.32:6443 check inter 1s backend be_api_managed2_6443 mode tcp balance source option ssl-hello-chk server controlplane0 192.168.125.40:6443 check inter 1s server controlplane1 192.168.125.41:6443 check inter 1s server controlplane2 192.168.125.42:6443 check inter 1s backend be_ingress_hub_80 mode http balance hdr(Host) hash-type consistent option forwardfor http-send-name-header Host server compute0 192.168.125.23:80 check inter 1s server compute1 192.168.125.24:80 check inter 1s server compute2 192.168.125.25:80 check inter 1s backend be_ingress_hub_443 mode tcp balance source option ssl-hello-chk server compute0 192.168.125.23:443 check inter 1s server compute1 192.168.125.24:443 check inter 1s server compute2 192.168.125.25:443 check inter 1s backend be_ingress_managed1_80 mode http balance hdr(Host) hash-type consistent option forwardfor http-send-name-header Host server compute0 192.168.125.33:80 check inter 1s server compute1 192.168.125.34:80 check inter 1s server compute2 192.168.125.35:80 check inter 1s backend be_ingress_managed1_443 mode tcp balance source option ssl-hello-chk server compute0 192.168.125.33:443 check inter 1s server compute1 192.168.125.34:443 check inter 1s server compute2 192.168.125.35:443 check inter 1s backend be_ingress_managed2_80 mode http balance hdr(Host) hash-type consistent option forwardfor http-send-name-header Host server compute0 192.168.125.43:80 check inter 1s server compute1 192.168.125.44:80 check inter 1s server compute2 192.168.125.45:80 check inter 1s backend be_ingress_managed2_443 mode tcp balance source option ssl-hello-chk server compute0 192.168.125.43:443 check inter 1s server compute1 192.168.125.44:443 check inter 1s server compute2 192.168.125.45:443 check inter 1s From this configuration file we can remark the following parameters:\nRedirect to different API backends based on SNI\nacl ACL_hub req_ssl_sni -i api.hub-cluster.linuxera.lab acl ACL_managed1 req_ssl_sni -i api.managed1.linuxera.lab acl ACL_managed2 req_ssl_sni -i api.managed2.linuxera.lab Redirect to different http ingress backends based on Host header and wildcard domain\nacl ACL_hub hdr(host) -m reg -i ^[^\\.]+\\.apps\\.hub\\.linuxera\\.lab acl ACL_managed1 hdr(host) -m reg -i ^[^\\.]+\\.apps\\.managed1\\.linuxera\\.lab acl ACL_managed2 hdr(host) -m reg -i ^[^\\.]+\\.apps\\.managed2\\.linuxera\\.lab Redirect to different https ingress backends based on SNI and wildcard domain\nAttention\nWe also add tcp-request inspect-delay 5s for HAProxy to have enough time to inspect the connection.\ntcp-request inspect-delay 5s tcp-request content accept if { req_ssl_hello_type 1 } acl ACL_hub req_ssl_sni -m reg -i ^[^\\.]+\\.apps\\.hub\\.linuxera\\.lab acl ACL_managed1 req_ssl_sni -m reg -i ^[^\\.]+\\.apps\\.managed1\\.linuxera\\.lab acl ACL_managed2 req_ssl_sni -m reg -i ^[^\\.]+\\.apps\\.managed2\\.linuxera\\.lab ","wordCount":"1002","inLanguage":"en","datePublished":"2023-03-21T00:00:00Z","dateModified":"2023-03-21T00:00:00Z","author":{"@type":"Person","name":"Mario"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://linuxera.org/exposing-multiple-kubernetes-clusters-single-lb-and-ip/"},"publisher":{"@type":"Organization","name":"Linuxera","logo":{"@type":"ImageObject","url":"https://linuxera.org/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://linuxera.org/ accesskey=h title="Linuxera (Alt + H)">Linuxera</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://linuxera.org/ title="🏠 Home"><span>🏠 Home</span></a></li><li><a href=https://linuxera.org/archives/ title="🗄️ Archive"><span>🗄️ Archive</span></a></li><li><a href=https://linuxera.org/search/ title="🔎 Search"><span>🔎 Search</span></a></li><li><a href=https://linuxera.org/tags/ title="🏷️ Tags"><span>🏷️ Tags</span></a></li><li><a href=https://linuxera.org/presentations/ title="🎴 Presentations"><span>🎴 Presentations</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://linuxera.org/>Home</a>&nbsp;»&nbsp;<a href=https://linuxera.org/posts/>Posts</a></div><h1 class=post-title>Exposing multiple Kubernetes clusters with a single load balancer and a single public IP</h1><div class=post-meta><span title='2023-03-21 00:00:00 +0000 UTC'>Published on March 21, 2023</span>&nbsp;·&nbsp;<span title='2023-03-21 00:00:00 +0000 UTC'>Last updated on March 21, 2023</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Mario</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#exposing-multiple-kubernetes-clusters-with-a-single-load-balancer-and-a-single-public-ip aria-label="Exposing multiple Kubernetes clusters with a single load balancer and a single public IP">Exposing multiple Kubernetes clusters with a single load balancer and a single public IP</a><ul><li><a href=#api-and-ingress-endpoints aria-label="API and Ingress endpoints">API and Ingress endpoints</a></li><li><a href=#load-balancing-requirements aria-label="Load balancing requirements">Load balancing requirements</a></li><li><a href=#detecting-destination-for-the-connections aria-label="Detecting destination for the connections">Detecting destination for the connections</a></li><li><a href=#our-solution aria-label="Our solution">Our solution</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=exposing-multiple-kubernetes-clusters-with-a-single-load-balancer-and-a-single-public-ip>Exposing multiple Kubernetes clusters with a single load balancer and a single public IP<a hidden class=anchor aria-hidden=true href=#exposing-multiple-kubernetes-clusters-with-a-single-load-balancer-and-a-single-public-ip>#</a></h1><p>My colleague <a href=https://twitter.com/_ZaNN_>Alberto Losada</a> and I have been working on a lab lately. The lab is composed of three <a href=https://www.redhat.com/en/technologies/cloud-computing/openshift>OpenShift</a> clusters on VMs, these VMs are deployed on an isolated libvirt network, which means that we cannot access them from outside the hypervisor.</p><p>In order to solve this issue, we wanted to expose the three clusters using the public IP available in the hypervisor. This setup should be valid for any Kubernetes cluster.</p><h2 id=api-and-ingress-endpoints>API and Ingress endpoints<a hidden class=anchor aria-hidden=true href=#api-and-ingress-endpoints>#</a></h2><p>In our case, our OpenShift clusters have two different endpoints, one for the Kubernetes API Server, and another one for the cluster Ingress:</p><ul><li>API Endpoint: <strong>6443</strong> port on control plane nodes</li><li>Cluster Ingress: <strong>80</strong> and <strong>443</strong> ports on compute nodes</li></ul><p>We have three clusters:</p><ul><li>hub-cluster.linuxera.lab</li><li>managed1.linuxera.lab</li><li>managed2. linuxera.lab</li></ul><p>Each cluster has two DNS records:</p><ul><li>api.&lt;clustername>.&lt;basedomain>    -> points to the hypervisor public IP</li><li>*.apps.&lt;clustername>.&lt;basedomain> -> points to the hypervisor public IP</li></ul><p>For example, for the <code>hub-cluster</code> we will have: <code>api.hub-cluster.linuxera.lab</code> and <code>*.apps.hub-cluster.linuxera.lab</code>.</p><h2 id=load-balancing-requirements>Load balancing requirements<a hidden class=anchor aria-hidden=true href=#load-balancing-requirements>#</a></h2><p>Usually, when you want to expose multiple clusters under the same load balancer you either use different public IPs, or different ports. For example, if you wanted to expose three clusters you could use three different IPs. Your load balancer will listen for connections on these IPs and depending on the IP receiving the request the load balancer will redirect traffic to the cluster exposed by that IP.</p><p>A different approach would be using the same IP for the load balancer but different ports, for example cluster1 API will be published in port 6443, cluster2 in port 6444, etc.</p><p>In this lab environment we only had a public IP, and we didn&rsquo;t want to use different ports. We wanted to be able to route request based on the destination cluster. On top of that, we didn&rsquo;t want to do TLS termination in the load balancer, instead we wanted the different clusters to do that.</p><h2 id=detecting-destination-for-the-connections>Detecting destination for the connections<a hidden class=anchor aria-hidden=true href=#detecting-destination-for-the-connections>#</a></h2><p>Users using our clusters will connect to the different clusters APIs and ingress endpoints. When they do that, depending on the destination cluster these connections will have different information that we can use to redirect those connections to the proper cluster.</p><p>For connections going to the HTTP Ingress endpoint we will use the <code>Host</code> header. For TLS connections going to the HTTPS/API ingress endpoints we will use the <code>SNI</code> from the TLS handshake.</p><h2 id=our-solution>Our solution<a hidden class=anchor aria-hidden=true href=#our-solution>#</a></h2><p>We decided to go with HAProxy. The architecture looks like this:</p><p><img loading=lazy src=./lb-arch.png alt="Load Balancer Arch"></p><p>And our configuration file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>global
</span></span></span><span class=line><span class=cl><span class=go>    log         127.0.0.1 local2
</span></span></span><span class=line><span class=cl><span class=go>    maxconn     4000
</span></span></span><span class=line><span class=cl><span class=go>    daemon
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>defaults
</span></span></span><span class=line><span class=cl><span class=go>    mode                    tcp
</span></span></span><span class=line><span class=cl><span class=go>    log                     global
</span></span></span><span class=line><span class=cl><span class=go>    retries                 3
</span></span></span><span class=line><span class=cl><span class=go>    timeout http-request    10s
</span></span></span><span class=line><span class=cl><span class=go>    timeout queue           1m
</span></span></span><span class=line><span class=cl><span class=go>    timeout connect         10s
</span></span></span><span class=line><span class=cl><span class=go>    timeout client          1m
</span></span></span><span class=line><span class=cl><span class=go>    timeout server          1m
</span></span></span><span class=line><span class=cl><span class=go>    timeout http-keep-alive 10s
</span></span></span><span class=line><span class=cl><span class=go>    timeout check           10s
</span></span></span><span class=line><span class=cl><span class=go>    maxconn                 3000
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listen stats-50000
</span></span></span><span class=line><span class=cl><span class=go>    bind :50000
</span></span></span><span class=line><span class=cl><span class=go>    mode            http
</span></span></span><span class=line><span class=cl><span class=go>    log             global
</span></span></span><span class=line><span class=cl><span class=go>    maxconn 10
</span></span></span><span class=line><span class=cl><span class=go>    timeout client  100s
</span></span></span><span class=line><span class=cl><span class=go>    timeout server  100s
</span></span></span><span class=line><span class=cl><span class=go>    timeout connect 100s
</span></span></span><span class=line><span class=cl><span class=go>    stats enable
</span></span></span><span class=line><span class=cl><span class=go>    stats hide-version
</span></span></span><span class=line><span class=cl><span class=go>    stats refresh 30s
</span></span></span><span class=line><span class=cl><span class=go>    stats show-node
</span></span></span><span class=line><span class=cl><span class=go>    stats auth admin:password
</span></span></span><span class=line><span class=cl><span class=go>    stats uri  /haproxy?stats
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>frontend apis-6443
</span></span></span><span class=line><span class=cl><span class=go>    bind :6443
</span></span></span><span class=line><span class=cl><span class=go>    mode tcp
</span></span></span><span class=line><span class=cl><span class=go>    tcp-request inspect-delay 5s
</span></span></span><span class=line><span class=cl><span class=go>    tcp-request content accept if { req_ssl_hello_type 1 }
</span></span></span><span class=line><span class=cl><span class=go>    acl ACL_hub req_ssl_sni -i api.hub-cluster.linuxera.lab
</span></span></span><span class=line><span class=cl><span class=go>    acl ACL_managed1 req_ssl_sni -i api.managed1.linuxera.lab
</span></span></span><span class=line><span class=cl><span class=go>    acl ACL_managed2 req_ssl_sni -i api.managed2.linuxera.lab
</span></span></span><span class=line><span class=cl><span class=go>    use_backend be_api_hub_6443 if ACL_hub
</span></span></span><span class=line><span class=cl><span class=go>    use_backend be_api_managed1_6443 if ACL_managed1
</span></span></span><span class=line><span class=cl><span class=go>    use_backend be_api_managed2_6443 if ACL_managed2
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>frontend routers-http-80
</span></span></span><span class=line><span class=cl><span class=go>    bind :80
</span></span></span><span class=line><span class=cl><span class=go>    mode http
</span></span></span><span class=line><span class=cl><span class=go>    acl ACL_hub hdr(host) -m reg -i ^[^\.]+\.apps\.hub\.linuxera\.lab
</span></span></span><span class=line><span class=cl><span class=go>    acl ACL_managed1 hdr(host) -m reg -i ^[^\.]+\.apps\.managed1\.linuxera\.lab
</span></span></span><span class=line><span class=cl><span class=go>    acl ACL_managed2 hdr(host) -m reg -i ^[^\.]+\.apps\.managed2\.linuxera\.lab
</span></span></span><span class=line><span class=cl><span class=go>    use_backend be_ingress_hub_80 if ACL_hub
</span></span></span><span class=line><span class=cl><span class=go>    use_backend be_ingress_managed1_80 if ACL_managed1
</span></span></span><span class=line><span class=cl><span class=go>    use_backend be_ingress_managed2_80 if ACL_managed2
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>frontend routers-https-443
</span></span></span><span class=line><span class=cl><span class=go>    bind :443
</span></span></span><span class=line><span class=cl><span class=go>    mode tcp
</span></span></span><span class=line><span class=cl><span class=go>    tcp-request inspect-delay 5s
</span></span></span><span class=line><span class=cl><span class=go>    tcp-request content accept if { req_ssl_hello_type 1 }
</span></span></span><span class=line><span class=cl><span class=go>    acl ACL_hub req_ssl_sni -m reg -i ^[^\.]+\.apps\.hub\.linuxera\.lab
</span></span></span><span class=line><span class=cl><span class=go>    acl ACL_managed1 req_ssl_sni -m reg -i ^[^\.]+\.apps\.managed1\.linuxera\.lab
</span></span></span><span class=line><span class=cl><span class=go>    acl ACL_managed2 req_ssl_sni -m reg -i ^[^\.]+\.apps\.managed2\.linuxera\.lab
</span></span></span><span class=line><span class=cl><span class=go>    use_backend be_ingress_hub_443 if ACL_hub
</span></span></span><span class=line><span class=cl><span class=go>    use_backend be_ingress_managed1_443 if ACL_managed1
</span></span></span><span class=line><span class=cl><span class=go>    use_backend be_ingress_managed2_443 if ACL_managed2
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>backend be_api_hub_6443
</span></span></span><span class=line><span class=cl><span class=go>    mode tcp
</span></span></span><span class=line><span class=cl><span class=go>    balance source
</span></span></span><span class=line><span class=cl><span class=go>    option ssl-hello-chk
</span></span></span><span class=line><span class=cl><span class=go>    server controlplane0 192.168.125.20:6443 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go>    server controlplane1 192.168.125.21:6443 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go>    server controlplane2 192.168.125.22:6443 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go>    
</span></span></span><span class=line><span class=cl><span class=go>backend be_api_managed1_6443
</span></span></span><span class=line><span class=cl><span class=go>    mode tcp
</span></span></span><span class=line><span class=cl><span class=go>    balance source
</span></span></span><span class=line><span class=cl><span class=go>    option ssl-hello-chk
</span></span></span><span class=line><span class=cl><span class=go>    server controlplane0 192.168.125.30:6443 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go>    server controlplane1 192.168.125.31:6443 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go>    server controlplane2 192.168.125.32:6443 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>backend be_api_managed2_6443
</span></span></span><span class=line><span class=cl><span class=go>    mode tcp
</span></span></span><span class=line><span class=cl><span class=go>    balance source
</span></span></span><span class=line><span class=cl><span class=go>    option ssl-hello-chk
</span></span></span><span class=line><span class=cl><span class=go>    server controlplane0 192.168.125.40:6443 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go>    server controlplane1 192.168.125.41:6443 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go>    server controlplane2 192.168.125.42:6443 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>backend be_ingress_hub_80
</span></span></span><span class=line><span class=cl><span class=go>    mode http
</span></span></span><span class=line><span class=cl><span class=go>    balance hdr(Host)
</span></span></span><span class=line><span class=cl><span class=go>    hash-type consistent
</span></span></span><span class=line><span class=cl><span class=go>    option forwardfor
</span></span></span><span class=line><span class=cl><span class=go>    http-send-name-header Host
</span></span></span><span class=line><span class=cl><span class=go>    server compute0 192.168.125.23:80 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go>    server compute1 192.168.125.24:80 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go>    server compute2 192.168.125.25:80 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>backend be_ingress_hub_443
</span></span></span><span class=line><span class=cl><span class=go>    mode tcp
</span></span></span><span class=line><span class=cl><span class=go>    balance source
</span></span></span><span class=line><span class=cl><span class=go>    option ssl-hello-chk
</span></span></span><span class=line><span class=cl><span class=go>    server compute0 192.168.125.23:443 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go>    server compute1 192.168.125.24:443 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go>    server compute2 192.168.125.25:443 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>backend be_ingress_managed1_80
</span></span></span><span class=line><span class=cl><span class=go>    mode http
</span></span></span><span class=line><span class=cl><span class=go>    balance hdr(Host)
</span></span></span><span class=line><span class=cl><span class=go>    hash-type consistent
</span></span></span><span class=line><span class=cl><span class=go>    option forwardfor
</span></span></span><span class=line><span class=cl><span class=go>    http-send-name-header Host
</span></span></span><span class=line><span class=cl><span class=go>    server compute0 192.168.125.33:80 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go>    server compute1 192.168.125.34:80 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go>    server compute2 192.168.125.35:80 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>backend be_ingress_managed1_443
</span></span></span><span class=line><span class=cl><span class=go>    mode tcp
</span></span></span><span class=line><span class=cl><span class=go>    balance source
</span></span></span><span class=line><span class=cl><span class=go>    option ssl-hello-chk
</span></span></span><span class=line><span class=cl><span class=go>    server compute0 192.168.125.33:443 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go>    server compute1 192.168.125.34:443 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go>    server compute2 192.168.125.35:443 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>backend be_ingress_managed2_80
</span></span></span><span class=line><span class=cl><span class=go>    mode http
</span></span></span><span class=line><span class=cl><span class=go>    balance hdr(Host)
</span></span></span><span class=line><span class=cl><span class=go>    hash-type consistent
</span></span></span><span class=line><span class=cl><span class=go>    option forwardfor
</span></span></span><span class=line><span class=cl><span class=go>    http-send-name-header Host
</span></span></span><span class=line><span class=cl><span class=go>    server compute0 192.168.125.43:80 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go>    server compute1 192.168.125.44:80 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go>    server compute2 192.168.125.45:80 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>backend be_ingress_managed2_443
</span></span></span><span class=line><span class=cl><span class=go>    mode tcp
</span></span></span><span class=line><span class=cl><span class=go>    balance source
</span></span></span><span class=line><span class=cl><span class=go>    option ssl-hello-chk
</span></span></span><span class=line><span class=cl><span class=go>    server compute0 192.168.125.43:443 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go>    server compute1 192.168.125.44:443 check inter 1s
</span></span></span><span class=line><span class=cl><span class=go>    server compute2 192.168.125.45:443 check inter 1s
</span></span></span></code></pre></div><p>From this configuration file we can remark the following parameters:</p><ol><li><p>Redirect to different API backends based on SNI</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>acl ACL_hub req_ssl_sni -i api.hub-cluster.linuxera.lab
</span></span></span><span class=line><span class=cl><span class=go>acl ACL_managed1 req_ssl_sni -i api.managed1.linuxera.lab
</span></span></span><span class=line><span class=cl><span class=go>acl ACL_managed2 req_ssl_sni -i api.managed2.linuxera.lab
</span></span></span></code></pre></div></li><li><p>Redirect to different http ingress backends based on Host header and wildcard domain</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>acl ACL_hub hdr(host) -m reg -i ^[^\.]+\.apps\.hub\.linuxera\.lab
</span></span></span><span class=line><span class=cl><span class=go>acl ACL_managed1 hdr(host) -m reg -i ^[^\.]+\.apps\.managed1\.linuxera\.lab
</span></span></span><span class=line><span class=cl><span class=go>acl ACL_managed2 hdr(host) -m reg -i ^[^\.]+\.apps\.managed2\.linuxera\.lab
</span></span></span></code></pre></div></li><li><p>Redirect to different https ingress backends based on SNI and wildcard domain</p><div class="admonition attention"><p class=admonition-title>Attention</p><p class=admonition>We also add <code>tcp-request inspect-delay 5s</code> for HAProxy to have enough time to inspect the connection.</p></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>tcp-request inspect-delay 5s
</span></span></span><span class=line><span class=cl><span class=go>tcp-request content accept if { req_ssl_hello_type 1 }
</span></span></span><span class=line><span class=cl><span class=go>acl ACL_hub req_ssl_sni -m reg -i ^[^\.]+\.apps\.hub\.linuxera\.lab
</span></span></span><span class=line><span class=cl><span class=go>acl ACL_managed1 req_ssl_sni -m reg -i ^[^\.]+\.apps\.managed1\.linuxera\.lab
</span></span></span><span class=line><span class=cl><span class=go>acl ACL_managed2 req_ssl_sni -m reg -i ^[^\.]+\.apps\.managed2\.linuxera\.lab
</span></span></span></code></pre></div></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://linuxera.org/tags/kubernetes/>kubernetes</a></li><li><a href=https://linuxera.org/tags/openshift/>openshift</a></li><li><a href=https://linuxera.org/tags/haproxy/>haproxy</a></li><li><a href=https://linuxera.org/tags/loadbalancer/>loadbalancer</a></li></ul><nav class=paginav><a class=prev href=https://linuxera.org/cpu-memory-management-kubernetes-cgroupsv2/><span class=title>« Prev</span><br><span>CPU and Memory Management on Kubernetes with Cgroupsv2</span></a>
<a class=next href=https://linuxera.org/enhanced-version-and-build-information-for-your-go-programs/><span class=title>Next »</span><br><span>Enhanced Version and Build Information for your Go programs with ldflags</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Exposing multiple Kubernetes clusters with a single load balancer and a single public IP on twitter" href="https://twitter.com/intent/tweet/?text=Exposing%20multiple%20Kubernetes%20clusters%20with%20a%20single%20load%20balancer%20and%20a%20single%20public%20IP&url=https%3a%2f%2flinuxera.org%2fexposing-multiple-kubernetes-clusters-single-lb-and-ip%2f&hashtags=kubernetes%2copenshift%2chaproxy%2cloadbalancer"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Exposing multiple Kubernetes clusters with a single load balancer and a single public IP on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2flinuxera.org%2fexposing-multiple-kubernetes-clusters-single-lb-and-ip%2f&title=Exposing%20multiple%20Kubernetes%20clusters%20with%20a%20single%20load%20balancer%20and%20a%20single%20public%20IP&summary=Exposing%20multiple%20Kubernetes%20clusters%20with%20a%20single%20load%20balancer%20and%20a%20single%20public%20IP&source=https%3a%2f%2flinuxera.org%2fexposing-multiple-kubernetes-clusters-single-lb-and-ip%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></div></footer><div class=share-buttons><p>If this post has been helpful to you, consider <u><a target=_blank href=https://ko-fi.com/mvazce>supporting the work.</a></u></p></div><script src=https://utteranc.es/client.js repo=mvazquezc/mvazquezc.github.io issue-term=pathname label=blog-comments theme=preferred-color-scheme crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://linuxera.org/>Linuxera</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>