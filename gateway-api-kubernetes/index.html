<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Gateway API for Kubernetes | Linuxera</title><meta name=keywords content="kubernetes,gateway-api,ingress"><meta name=description content="Gateway API for Kubernetes In this post we will go over a new project by the SIG-NETWORK that aims to evolve Kubernetes service networking.
I&rsquo;ll be using a Kubernetes v1.26 (latest at the time of this writing). The tool used to create the cluster is kcli and the command used was:
kcli create kube generic -P ctlplanes=1 -P workers=1 -P ctlplane_memory=4096 -P numcpus=8 -P worker_memory=8192 -P image=fedora37 -P sdn=calico -P version=1."><meta name=author content="Mario"><link rel=canonical href=https://linuxera.org/gateway-api-kubernetes/><link crossorigin=anonymous href=/assets/css/stylesheet.8cc7ef3cdd44c5188f9267864f378d8dd8892d583e0fd07b5e5321e496f1e4d1.css integrity="sha256-jMfvPN1ExRiPkmeGTzeNjdiJLVg+D9B7XlMh5Jbx5NE=" rel="preload stylesheet" as=style><link rel=icon href=https://linuxera.org/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://linuxera.org/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://linuxera.org/favicon-32x32.png><link rel=apple-touch-icon href=https://linuxera.org/apple-touch-icon.png><link rel=mask-icon href=https://linuxera.org/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer data-domain=linuxera.org src=https://stats.linuxera.org/js/script.file-downloads.hash.outbound-links.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script><meta property="og:title" content="Gateway API for Kubernetes"><meta property="og:description" content="Gateway API for Kubernetes In this post we will go over a new project by the SIG-NETWORK that aims to evolve Kubernetes service networking.
I&rsquo;ll be using a Kubernetes v1.26 (latest at the time of this writing). The tool used to create the cluster is kcli and the command used was:
kcli create kube generic -P ctlplanes=1 -P workers=1 -P ctlplane_memory=4096 -P numcpus=8 -P worker_memory=8192 -P image=fedora37 -P sdn=calico -P version=1."><meta property="og:type" content="article"><meta property="og:url" content="https://linuxera.org/gateway-api-kubernetes/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-24T00:00:00+00:00"><meta property="article:modified_time" content="2023-04-24T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Gateway API for Kubernetes"><meta name=twitter:description content="Gateway API for Kubernetes In this post we will go over a new project by the SIG-NETWORK that aims to evolve Kubernetes service networking.
I&rsquo;ll be using a Kubernetes v1.26 (latest at the time of this writing). The tool used to create the cluster is kcli and the command used was:
kcli create kube generic -P ctlplanes=1 -P workers=1 -P ctlplane_memory=4096 -P numcpus=8 -P worker_memory=8192 -P image=fedora37 -P sdn=calico -P version=1."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://linuxera.org/posts/"},{"@type":"ListItem","position":2,"name":"Gateway API for Kubernetes","item":"https://linuxera.org/gateway-api-kubernetes/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Gateway API for Kubernetes","name":"Gateway API for Kubernetes","description":"Gateway API for Kubernetes In this post we will go over a new project by the SIG-NETWORK that aims to evolve Kubernetes service networking.\nI\u0026rsquo;ll be using a Kubernetes v1.26 (latest at the time of this writing). The tool used to create the cluster is kcli and the command used was:\nkcli create kube generic -P ctlplanes=1 -P workers=1 -P ctlplane_memory=4096 -P numcpus=8 -P worker_memory=8192 -P image=fedora37 -P sdn=calico -P version=1.","keywords":["kubernetes","gateway-api","ingress"],"articleBody":"Gateway API for Kubernetes In this post we will go over a new project by the SIG-NETWORK that aims to evolve Kubernetes service networking.\nI’ll be using a Kubernetes v1.26 (latest at the time of this writing). The tool used to create the cluster is kcli and the command used was:\nkcli create kube generic -P ctlplanes=1 -P workers=1 -P ctlplane_memory=4096 -P numcpus=8 -P worker_memory=8192 -P image=fedora37 -P sdn=calico -P version=1.26 -P ingress=false -P metallb=true -P domain=linuxera.org gateway-api-cluster Introduction to Kubernetes Gateway API As we said in the previous section, Gateway API is a new project by the SIG-NETWORK. This project aims to become the preferred solution for managing external traffic into a Kubernetes cluster.\nCompared to traditional Ingress Controllers, Gateway API provides a more declarative and standardized approach to configuring and managing network traffic.\nFor example, Gateway API allows the definition and configuration for routing, load balancing, and other traffic policies in a more consistent and unified manner, regardless of the underlying infrastructure or cloud provider.\nOn top of that, effort has been put in making Gateway API more extensible and support a wider range of uses cases, making it a more future-proof solution for managing traffic in modern cloud-native environments.\nNew APIs Gateway API introduces new APIs to our Kubernetes clusters, you can see the APIs as well as the target personas in the image below:\nImage Source\nGatewayClass The infrastructure provider will offer one or more GatewayClasses for the user. A decoupling mechanism will implement the Gateway (usually a controller) from the user.\nFor example, the infrastructure provider could create two GatewayClasses:\ninternal: Can be used to expose apps internally. external: Can be used to expose apps externally. Then some Gateway will implement these GatewayClasses and the user don’t need to know how that’s implemented, instead user only chooses if the app gets externally published or not.\nYou can read more about the GatewayClass here.\nGateway When the cluster operator creates a Gateway that triggers an action in the infrastructure like:\nCall a cloud API to create a Load Balancer. Deploy a software load balancer in the cluster. etc. The Gateway always has a reference to the GatewayClass that it implements, and at the same time the GatewayClass has a reference to the controller (or decoupling mechanism) that implements the GatewayClass itself.\nThe Gateway object defines some other properties like which ports, protocols, tls settings, etc.\nYou can read more about the Gateway here.\nHTTPRoute Application developers will make use of HTTPRoutes in order to get ingress traffic to their applications. This API specifies the routing behavior for HTTP/s requests from the Gateway listener to a service.\nBelow image shows how traffic flows from client to pod:\nImage Source\nYou can read more about the HTTPRoute here.\nTrying Gateway API with NGinx Gateway Controller In this section we will be deploying all the required bits to expose an application via HTTP/s using HTTPRoutes. Three scenarios will be covered:\nExposing an APP via HTTP. Blue/Green with weights. Exposing an APP via HTTPs. The following software versions were used:\nKubernetes v1.26.4 Gateway API v0.6.2 MetalLB v0.13.9 Deploying the Gateway API For this introduction we are deploying the standard APIs, so we won’t get support for TCPRoute, TLSRoute, etc. Only basic support for HTTPRoute will be available.\nDeploy the Gateway API CRDs and admission server\nkubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v0.6.2/standard-install.yaml If we check the pods created in the gateway-system namespace, we will see the admission server running:\nkubectl -n gateway-system get pods NAME READY STATUS RESTARTS AGE gateway-api-admission-l2dnj 0/1 Completed 0 30s gateway-api-admission-patch-sh6tw 0/1 Completed 1 30s gateway-api-admission-server-546bdb8747-q5jxw 1/1 Running 0 30s At this point we have the Gateway API running, next step will be choosing the Gateway API implementation we want to use. You can find a list of current implementations here. For this post, we will be using the NGinx Gateway implementation.\nDeploying the NGinx Gateway Controller The code for the controller can be found here.\nThe instructions to deploy the controller use the commit 23092c6e1b17e91177bdb5f43bef477f90d1cc63 which is the content of the main branch as of April 24th.\nCreate the namespace where the controller will be deployed:\nkubectl apply -f https://raw.githubusercontent.com/nginxinc/nginx-kubernetes-gateway/23092c6e1b17e91177bdb5f43bef477f90d1cc63/deploy/manifests/namespace.yaml Create the njs-modules, this is used by NGinx to implement the data plane:\nNote\nnjs is a subset of the JavaScript language that allows extending nginx functionality.\ncurl -L https://raw.githubusercontent.com/nginxinc/nginx-kubernetes-gateway/23092c6e1b17e91177bdb5f43bef477f90d1cc63/internal/nginx/modules/src/httpmatches.js -o /tmp/httpmatches.js kubectl -n nginx-gateway create configmap njs-modules --from-file=/tmp/httpmatches.js rm -f /tmp/httpmatches.js Create the GatewayClass that will use the nginx controller as backend:\nkubectl apply -f https://raw.githubusercontent.com/nginxinc/nginx-kubernetes-gateway/23092c6e1b17e91177bdb5f43bef477f90d1cc63/deploy/manifests/gatewayclass.yaml Finally, deploy the NGinx Gateway Controller:\nNote\nContainer nginx-gateway is using ghcr.io/nginxinc/nginx-kubernetes-gateway:edge which at the time of this writing points to ghcr.io/nginxinc/nginx-kubernetes-gateway@sha256:e67a8e8553a581404cfbf1343f60c67cd9a6c68436b7367bb1ea8fbbef862c8e.\nkubectl apply -f https://raw.githubusercontent.com/nginxinc/nginx-kubernetes-gateway/23092c6e1b17e91177bdb5f43bef477f90d1cc63/deploy/manifests/nginx-gateway.yaml After a few moments, the controller pod will be running:\nkubectl -n nginx-gateway get pods NAME READY STATUS RESTARTS AGE nginx-gateway-54dc684b98-xnrv8 2/2 Running 0 30s We need to expose the gateway controller, we will be using a LoadBalancer service for that. In our cluster we are using MetalLB.\nNote\nYou can read how to deploy MetalLB on the official docs. If you’re running on a cloud provider, you should be good to go without MetalLB.\nkubectl apply -f https://raw.githubusercontent.com/nginxinc/nginx-kubernetes-gateway/23092c6e1b17e91177bdb5f43bef477f90d1cc63/deploy/manifests/service/loadbalancer.yaml We should have a Service with an external IP set:\nkubectl -n nginx-gateway get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE nginx-gateway LoadBalancer 10.107.59.82 192.168.122.240 80:30970/TCP,443:31783/TCP 7s In order to be able to expose our applications we need proper DNS resolution, we will be configuring a wildcard record in our DNS server. In this case we’re creating a record *.apps.gateway-api.test.lab that points to the external IP 192.168.122.240.\nNote\nThis wildcard domain will be used when exposing our apps.\ndig +short anything.apps.gateway-api.test.lab 192.168.122.240 At this point we are ready to start exposing our applications with the NGinx Gateway.\nExposing applications with the NGinx Gateway As previously stated, the following scenarios will be covered:\nExposing an APP via HTTP. Blue/Green with weights. Exposing an APP via HTTPs. Exposing an APP via HTTP For this scenario we are just deploying a simple app and making it available for HTTP calls.\nDeploy the simple app:\ncat \u003c","wordCount":"2365","inLanguage":"en","datePublished":"2023-04-24T00:00:00Z","dateModified":"2023-04-24T00:00:00Z","author":{"@type":"Person","name":"Mario"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://linuxera.org/gateway-api-kubernetes/"},"publisher":{"@type":"Organization","name":"Linuxera","logo":{"@type":"ImageObject","url":"https://linuxera.org/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://linuxera.org/ accesskey=h title="Linuxera (Alt + H)">Linuxera</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://linuxera.org/ title="🏠 Home"><span>🏠 Home</span></a></li><li><a href=https://linuxera.org/archives/ title="🗄️ Archive"><span>🗄️ Archive</span></a></li><li><a href=https://linuxera.org/search/ title="🔎 Search"><span>🔎 Search</span></a></li><li><a href=https://linuxera.org/tags/ title="🏷️ Tags"><span>🏷️ Tags</span></a></li><li><a href=https://linuxera.org/presentations/ title="🎴 Presentations"><span>🎴 Presentations</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://linuxera.org/>Home</a>&nbsp;»&nbsp;<a href=https://linuxera.org/posts/>Posts</a></div><h1 class=post-title>Gateway API for Kubernetes</h1><div class=post-meta><span title='2023-04-24 00:00:00 +0000 UTC'>Published on April 24, 2023</span>&nbsp;·&nbsp;<span title='2023-04-24 00:00:00 +0000 UTC'>Last updated on April 24, 2023</span>&nbsp;·&nbsp;12 min&nbsp;·&nbsp;Mario</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#gateway-api-for-kubernetes aria-label="Gateway API for Kubernetes">Gateway API for Kubernetes</a><ul><li><a href=#introduction-to-kubernetes-gateway-api aria-label="Introduction to Kubernetes Gateway API">Introduction to Kubernetes Gateway API</a><ul><li><a href=#new-apis aria-label="New APIs">New APIs</a><ul><li><a href=#gatewayclass aria-label=GatewayClass>GatewayClass</a></li><li><a href=#gateway aria-label=Gateway>Gateway</a></li><li><a href=#httproute aria-label=HTTPRoute>HTTPRoute</a></li></ul></li></ul></li><li><a href=#trying-gateway-api-with-nginx-gateway-controller aria-label="Trying Gateway API with NGinx Gateway Controller">Trying Gateway API with NGinx Gateway Controller</a><ul><li><a href=#deploying-the-gateway-api aria-label="Deploying the Gateway API">Deploying the Gateway API</a></li><li><a href=#deploying-the-nginx-gateway-controller aria-label="Deploying the NGinx Gateway Controller">Deploying the NGinx Gateway Controller</a></li><li><a href=#exposing-applications-with-the-nginx-gateway aria-label="Exposing applications with the NGinx Gateway">Exposing applications with the NGinx Gateway</a><ul><li><a href=#exposing-an-app-via-http aria-label="Exposing an APP via HTTP">Exposing an APP via HTTP</a></li><li><a href=#bluegreen-with-weights aria-label="Blue/Green with weights">Blue/Green with weights</a></li><li><a href=#exposing-an-app-via-https aria-label="Exposing an APP via HTTPs">Exposing an APP via HTTPs</a></li></ul></li></ul></li><li><a href=#closing-thoughts aria-label="Closing Thoughts">Closing Thoughts</a></li><li><a href=#useful-resources aria-label="Useful Resources">Useful Resources</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=gateway-api-for-kubernetes>Gateway API for Kubernetes<a hidden class=anchor aria-hidden=true href=#gateway-api-for-kubernetes>#</a></h1><p>In this post we will go over a new project by the <a href=https://github.com/kubernetes/community/tree/master/sig-network>SIG-NETWORK</a> that aims to evolve Kubernetes service networking.</p><p>I&rsquo;ll be using a Kubernetes v1.26 (latest at the time of this writing). The tool used to create the cluster is <a href=https://kcli.readthedocs.io/>kcli</a> and the command used was:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kcli create kube generic -P <span class=nv>ctlplanes</span><span class=o>=</span><span class=m>1</span> -P <span class=nv>workers</span><span class=o>=</span><span class=m>1</span> -P <span class=nv>ctlplane_memory</span><span class=o>=</span><span class=m>4096</span> -P <span class=nv>numcpus</span><span class=o>=</span><span class=m>8</span> -P <span class=nv>worker_memory</span><span class=o>=</span><span class=m>8192</span> -P <span class=nv>image</span><span class=o>=</span>fedora37 -P <span class=nv>sdn</span><span class=o>=</span>calico -P <span class=nv>version</span><span class=o>=</span>1.26 -P <span class=nv>ingress</span><span class=o>=</span><span class=nb>false</span> -P <span class=nv>metallb</span><span class=o>=</span><span class=nb>true</span> -P <span class=nv>domain</span><span class=o>=</span>linuxera.org gateway-api-cluster
</span></span></code></pre></div><h2 id=introduction-to-kubernetes-gateway-api>Introduction to Kubernetes Gateway API<a hidden class=anchor aria-hidden=true href=#introduction-to-kubernetes-gateway-api>#</a></h2><p>As we said in the previous section, Gateway API is a new project by the SIG-NETWORK. This project aims to become the preferred solution for managing external traffic into a Kubernetes cluster.</p><p>Compared to traditional Ingress Controllers, Gateway API provides a more declarative and standardized approach to configuring and managing network traffic.</p><p>For example, Gateway API allows the definition and configuration for routing, load balancing, and other traffic policies in a more consistent and unified manner, regardless of the underlying infrastructure or cloud provider.</p><p>On top of that, effort has been put in making Gateway API more extensible and support a wider range of uses cases, making it a more future-proof solution for managing traffic in modern cloud-native environments.</p><h3 id=new-apis>New APIs<a hidden class=anchor aria-hidden=true href=#new-apis>#</a></h3><p>Gateway API introduces new APIs to our Kubernetes clusters, you can see the APIs as well as the target personas in the image below:</p><p><img loading=lazy src=./api-model.png alt="Gateway API personas">
<sup><a href=https://gateway-api.sigs.k8s.io/>Image Source</a></sup></p><h4 id=gatewayclass>GatewayClass<a hidden class=anchor aria-hidden=true href=#gatewayclass>#</a></h4><p>The infrastructure provider will offer one or more <code>GatewayClasses</code> for the user. A decoupling mechanism will implement the <code>Gateway</code> (usually a controller) from the user.</p><p>For example, the infrastructure provider could create two <code>GatewayClasses</code>:</p><ul><li><code>internal</code>: Can be used to expose apps internally.</li><li><code>external</code>: Can be used to expose apps externally.</li></ul><p>Then some <code>Gateway</code> will implement these <code>GatewayClasses</code> and the user don&rsquo;t need to know how that&rsquo;s implemented, instead user only chooses if the app gets externally published or not.</p><p>You can read more about the <code>GatewayClass</code> <a href=https://gateway-api.sigs.k8s.io/api-types/gatewayclass/>here</a>.</p><h4 id=gateway>Gateway<a hidden class=anchor aria-hidden=true href=#gateway>#</a></h4><p>When the cluster operator creates a <code>Gateway</code> that triggers an action in the infrastructure like:</p><ul><li>Call a cloud API to create a Load Balancer.</li><li>Deploy a software load balancer in the cluster.</li><li>etc.</li></ul><p>The <code>Gateway</code> always has a reference to the <code>GatewayClass</code> that it implements, and at the same time the <code>GatewayClass</code> has a reference to the controller (or decoupling mechanism) that implements the <code>GatewayClass</code> itself.</p><p>The <code>Gateway</code> object defines some other properties like which ports, protocols, tls settings, etc.</p><p>You can read more about the <code>Gateway</code> <a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>here</a>.</p><h4 id=httproute>HTTPRoute<a hidden class=anchor aria-hidden=true href=#httproute>#</a></h4><p>Application developers will make use of <code>HTTPRoutes</code> in order to get ingress traffic to their applications. This API specifies the routing behavior for HTTP/s requests from the Gateway listener to a service.</p><p>Below image shows how traffic flows from client to pod:</p><p><img loading=lazy src=./httproute-basic-example.png alt="Traffic flow from client to pod using HTTPRoute">
<sup><a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>Image Source</a></sup></p><p>You can read more about the <code>HTTPRoute</code> <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>here</a>.</p><h2 id=trying-gateway-api-with-nginx-gateway-controller>Trying Gateway API with NGinx Gateway Controller<a hidden class=anchor aria-hidden=true href=#trying-gateway-api-with-nginx-gateway-controller>#</a></h2><p>In this section we will be deploying all the required bits to expose an application via <code>HTTP/s</code> using <code>HTTPRoutes</code>. Three scenarios will be covered:</p><ul><li>Exposing an APP via HTTP.</li><li>Blue/Green with weights.</li><li>Exposing an APP via HTTPs.</li></ul><p>The following software versions were used:</p><ul><li>Kubernetes v1.26.4</li><li>Gateway API v0.6.2</li><li>MetalLB v0.13.9</li></ul><h3 id=deploying-the-gateway-api>Deploying the Gateway API<a hidden class=anchor aria-hidden=true href=#deploying-the-gateway-api>#</a></h3><p>For this introduction we are deploying the <a href=https://gateway-api.sigs.k8s.io/concepts/versioning/#release-channels-eg-experimental-standard>standard APIs</a>, so we won&rsquo;t get support for <code>TCPRoute</code>, <code>TLSRoute</code>, etc. Only basic support for <code>HTTPRoute</code> will be available.</p><ol><li><p>Deploy the Gateway API CRDs and admission server</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v0.6.2/standard-install.yaml
</span></span></code></pre></div></li><li><p>If we check the pods created in the <code>gateway-system</code> namespace, we will see the admission server running:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl -n gateway-system get pods
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>NAME                                            READY   STATUS      RESTARTS   AGE
</span></span></span><span class=line><span class=cl><span class=go>gateway-api-admission-l2dnj                     0/1     Completed   0          30s
</span></span></span><span class=line><span class=cl><span class=go>gateway-api-admission-patch-sh6tw               0/1     Completed   1          30s
</span></span></span><span class=line><span class=cl><span class=go>gateway-api-admission-server-546bdb8747-q5jxw   1/1     Running     0          30s
</span></span></span></code></pre></div></li></ol><p>At this point we have the Gateway API running, next step will be choosing the Gateway API implementation we want to use. You can find a list of current implementations <a href=https://gateway-api.sigs.k8s.io/implementations/>here</a>. For this post, we will be using the NGinx Gateway implementation.</p><h3 id=deploying-the-nginx-gateway-controller>Deploying the NGinx Gateway Controller<a hidden class=anchor aria-hidden=true href=#deploying-the-nginx-gateway-controller>#</a></h3><p>The code for the controller can be found <a href=https://github.com/nginxinc/nginx-kubernetes-gateway>here</a>.</p><p>The instructions to deploy the controller use the commit <code>23092c6e1b17e91177bdb5f43bef477f90d1cc63</code> which is the content of the <code>main</code> branch as of April 24th.</p><ol><li><p>Create the namespace where the controller will be deployed:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl apply -f https://raw.githubusercontent.com/nginxinc/nginx-kubernetes-gateway/23092c6e1b17e91177bdb5f43bef477f90d1cc63/deploy/manifests/namespace.yaml
</span></span></code></pre></div></li><li><p>Create the <code>njs-modules</code>, this is used by NGinx to implement the data plane:</p><div class="admonition tip"><p class=admonition-title>Note</p><p class=admonition><code>njs</code> is a subset of the JavaScript language that allows extending nginx functionality.</p></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>curl -L https://raw.githubusercontent.com/nginxinc/nginx-kubernetes-gateway/23092c6e1b17e91177bdb5f43bef477f90d1cc63/internal/nginx/modules/src/httpmatches.js -o /tmp/httpmatches.js
</span></span><span class=line><span class=cl>kubectl -n nginx-gateway create configmap njs-modules --from-file<span class=o>=</span>/tmp/httpmatches.js
</span></span><span class=line><span class=cl>rm -f /tmp/httpmatches.js
</span></span></code></pre></div></li><li><p>Create the <code>GatewayClass</code> that will use the nginx controller as backend:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl apply -f https://raw.githubusercontent.com/nginxinc/nginx-kubernetes-gateway/23092c6e1b17e91177bdb5f43bef477f90d1cc63/deploy/manifests/gatewayclass.yaml
</span></span></code></pre></div></li><li><p>Finally, deploy the NGinx Gateway Controller:</p><div class="admonition tip"><p class=admonition-title>Note</p><p class=admonition>Container nginx-gateway is using <code>ghcr.io/nginxinc/nginx-kubernetes-gateway:edge</code> which at the time of this writing points to <code>ghcr.io/nginxinc/nginx-kubernetes-gateway@sha256:e67a8e8553a581404cfbf1343f60c67cd9a6c68436b7367bb1ea8fbbef862c8e</code>.</p></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl apply -f https://raw.githubusercontent.com/nginxinc/nginx-kubernetes-gateway/23092c6e1b17e91177bdb5f43bef477f90d1cc63/deploy/manifests/nginx-gateway.yaml
</span></span></code></pre></div></li><li><p>After a few moments, the controller pod will be running:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl -n nginx-gateway get pods
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>NAME                             READY   STATUS    RESTARTS   AGE
</span></span></span><span class=line><span class=cl><span class=go>nginx-gateway-54dc684b98-xnrv8   2/2     Running   0          30s
</span></span></span></code></pre></div></li><li><p>We need to expose the gateway controller, we will be using a <code>LoadBalancer</code> service for that. In our cluster we are using <code>MetalLB</code>.</p><div class="admonition tip"><p class=admonition-title>Note</p><p class=admonition>You can read how to deploy MetalLB on the <a href=https://metallb.universe.tf/installation/>official docs</a>. If you&rsquo;re running on a cloud provider, you should be good to go without MetalLB.</p></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl apply -f https://raw.githubusercontent.com/nginxinc/nginx-kubernetes-gateway/23092c6e1b17e91177bdb5f43bef477f90d1cc63/deploy/manifests/service/loadbalancer.yaml
</span></span></code></pre></div></li><li><p>We should have a <code>Service</code> with an external IP set:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl -n nginx-gateway get svc
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>NAME            TYPE           CLUSTER-IP     EXTERNAL-IP       PORT(S)                      AGE
</span></span></span><span class=line><span class=cl><span class=go>nginx-gateway   LoadBalancer   10.107.59.82   192.168.122.240   80:30970/TCP,443:31783/TCP   7s
</span></span></span></code></pre></div></li><li><p>In order to be able to expose our applications we need proper DNS resolution, we will be configuring a wildcard record in our DNS server. In this case we&rsquo;re creating a record <code>*.apps.gateway-api.test.lab</code> that points to the external IP <code>192.168.122.240</code>.</p><div class="admonition tip"><p class=admonition-title>Note</p><p class=admonition>This wildcard domain will be used when exposing our apps.</p></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>dig +short anything.apps.gateway-api.test.lab
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>192.168.122.240
</span></span></span></code></pre></div></li></ol><p>At this point we are ready to start exposing our applications with the NGinx Gateway.</p><h3 id=exposing-applications-with-the-nginx-gateway>Exposing applications with the NGinx Gateway<a hidden class=anchor aria-hidden=true href=#exposing-applications-with-the-nginx-gateway>#</a></h3><p>As previously stated, the following scenarios will be covered:</p><ul><li>Exposing an APP via HTTP.</li><li>Blue/Green with weights.</li><li>Exposing an APP via HTTPs.</li></ul><h4 id=exposing-an-app-via-http>Exposing an APP via HTTP<a hidden class=anchor aria-hidden=true href=#exposing-an-app-via-http>#</a></h4><p>For this scenario we are just deploying a simple app and making it available for HTTP calls.</p><ol><li><p>Deploy the simple app:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Namespace
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: reverse-words
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: reverse-words-blue
</span></span></span><span class=line><span class=cl><span class=s>  namespace: reverse-words
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app: reverse-words-blue
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 1
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      app: reverse-words-blue
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        app: reverse-words-blue
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - name: reverse-words
</span></span></span><span class=line><span class=cl><span class=s>        image: quay.io/mavazque/reversewords:0.27
</span></span></span><span class=line><span class=cl><span class=s>        ports:
</span></span></span><span class=line><span class=cl><span class=s>        - containerPort: 8080
</span></span></span><span class=line><span class=cl><span class=s>          name: http
</span></span></span><span class=line><span class=cl><span class=s>        env:
</span></span></span><span class=line><span class=cl><span class=s>        - name: RELEASE
</span></span></span><span class=line><span class=cl><span class=s>          value: &#34;Blue&#34;
</span></span></span><span class=line><span class=cl><span class=s>        livenessProbe:
</span></span></span><span class=line><span class=cl><span class=s>          httpGet:
</span></span></span><span class=line><span class=cl><span class=s>            path: /health
</span></span></span><span class=line><span class=cl><span class=s>            port: 8080
</span></span></span><span class=line><span class=cl><span class=s>          initialDelaySeconds: 5
</span></span></span><span class=line><span class=cl><span class=s>          timeoutSeconds: 2
</span></span></span><span class=line><span class=cl><span class=s>          periodSeconds: 15
</span></span></span><span class=line><span class=cl><span class=s>        readinessProbe:
</span></span></span><span class=line><span class=cl><span class=s>          httpGet:
</span></span></span><span class=line><span class=cl><span class=s>            path: /health
</span></span></span><span class=line><span class=cl><span class=s>            port: 8080
</span></span></span><span class=line><span class=cl><span class=s>          initialDelaySeconds: 10
</span></span></span><span class=line><span class=cl><span class=s>          timeoutSeconds: 2
</span></span></span><span class=line><span class=cl><span class=s>          periodSeconds: 15
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Service
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app: reverse-words-blue
</span></span></span><span class=line><span class=cl><span class=s>  name: reverse-words-blue
</span></span></span><span class=line><span class=cl><span class=s>  namespace: reverse-words
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  ports:
</span></span></span><span class=line><span class=cl><span class=s>  - port: 8080
</span></span></span><span class=line><span class=cl><span class=s>    protocol: TCP
</span></span></span><span class=line><span class=cl><span class=s>    targetPort: http
</span></span></span><span class=line><span class=cl><span class=s>    name: http
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    app: reverse-words-blue
</span></span></span><span class=line><span class=cl><span class=s>  type: ClusterIP
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div></li><li><p>With the app running we will create a <code>Gateway</code> resource pointing to the NGinx Gateway Class created earlier. On top of that, it will only listen for HTTP connections on port <code>80</code>:</p><div class="admonition tip"><p class=admonition-title>Note</p><p class=admonition>When creating <code>HTTPRoutes</code> in the <code>reverse-words</code> namespace we will reference this Gateway and the listener to be used to expose our application. We can have multiple <code>Gateways</code> per namespace, for example: One <code>Gateway</code> that exposes services using NGinx, another one that uses <code>HAProxy</code>, and a third one that uses <code>F5 Big IP</code>, etc.</p></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: Gateway
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: gateway
</span></span></span><span class=line><span class=cl><span class=s>  namespace: reverse-words
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    domain: k8s-gateway.nginx.org
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  gatewayClassName: nginx
</span></span></span><span class=line><span class=cl><span class=s>  listeners:
</span></span></span><span class=line><span class=cl><span class=s>  - name: http
</span></span></span><span class=line><span class=cl><span class=s>    port: 80
</span></span></span><span class=line><span class=cl><span class=s>    protocol: HTTP
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div></li><li><p>Finally, let&rsquo;s create the <code>HTTPRoute</code>:</p><div class="admonition tip"><p class=admonition-title>Note</p><p class=admonition>This <code>HTTPRoute</code> uses the <code>Gateway</code> named <code>gateway</code> in this namespace, and will use the listener <code>http</code> to publish the route. The <code>Service</code> being exposed is the <code>reverse-words-blue</code> service on port <code>8080</code>.</p></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: HTTPRoute
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: reversewords
</span></span></span><span class=line><span class=cl><span class=s>  namespace: reverse-words
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  parentRefs:
</span></span></span><span class=line><span class=cl><span class=s>  - name: gateway
</span></span></span><span class=line><span class=cl><span class=s>    sectionName: http
</span></span></span><span class=line><span class=cl><span class=s>  hostnames:
</span></span></span><span class=line><span class=cl><span class=s>  - reverse-words.apps.gateway-api.test.lab
</span></span></span><span class=line><span class=cl><span class=s>  rules:
</span></span></span><span class=line><span class=cl><span class=s>  - backendRefs:
</span></span></span><span class=line><span class=cl><span class=s>    - name: reverse-words-blue
</span></span></span><span class=line><span class=cl><span class=s>      port: 8080
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div></li><li><p>We can now access our application:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>curl http://reverse-words.apps.gateway-api.test.lab
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Reverse Words Release: Blue. App version: v0.0.27
</span></span></span></code></pre></div></li></ol><h4 id=bluegreen-with-weights>Blue/Green with weights<a hidden class=anchor aria-hidden=true href=#bluegreen-with-weights>#</a></h4><p>In this scenario we have two versions of the same service, and we will move traffic gradually to the newer version.</p><div class="admonition attention"><p class=admonition-title>Attention</p><p class=admonition>This scenario relies on the application deployed on the previous section.</p></div><ol><li><p>Deploy the new version of our application (<code>Green</code>)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: reverse-words-green
</span></span></span><span class=line><span class=cl><span class=s>  namespace: reverse-words
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app: reverse-words-green
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 1
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      app: reverse-words-green
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        app: reverse-words-green
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - name: reverse-words
</span></span></span><span class=line><span class=cl><span class=s>        image: quay.io/mavazque/reversewords:0.28
</span></span></span><span class=line><span class=cl><span class=s>        ports:
</span></span></span><span class=line><span class=cl><span class=s>        - containerPort: 8080
</span></span></span><span class=line><span class=cl><span class=s>          name: http
</span></span></span><span class=line><span class=cl><span class=s>        env:
</span></span></span><span class=line><span class=cl><span class=s>        - name: RELEASE
</span></span></span><span class=line><span class=cl><span class=s>          value: &#34;Green&#34;
</span></span></span><span class=line><span class=cl><span class=s>        livenessProbe:
</span></span></span><span class=line><span class=cl><span class=s>          httpGet:
</span></span></span><span class=line><span class=cl><span class=s>            path: /health
</span></span></span><span class=line><span class=cl><span class=s>            port: 8080
</span></span></span><span class=line><span class=cl><span class=s>          initialDelaySeconds: 5
</span></span></span><span class=line><span class=cl><span class=s>          timeoutSeconds: 2
</span></span></span><span class=line><span class=cl><span class=s>          periodSeconds: 15
</span></span></span><span class=line><span class=cl><span class=s>        readinessProbe:
</span></span></span><span class=line><span class=cl><span class=s>          httpGet:
</span></span></span><span class=line><span class=cl><span class=s>            path: /health
</span></span></span><span class=line><span class=cl><span class=s>            port: 8080
</span></span></span><span class=line><span class=cl><span class=s>          initialDelaySeconds: 10
</span></span></span><span class=line><span class=cl><span class=s>          timeoutSeconds: 2
</span></span></span><span class=line><span class=cl><span class=s>          periodSeconds: 15
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Service
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app: reverse-words-green
</span></span></span><span class=line><span class=cl><span class=s>  name: reverse-words-green
</span></span></span><span class=line><span class=cl><span class=s>  namespace: reverse-words
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  ports:
</span></span></span><span class=line><span class=cl><span class=s>  - port: 8080
</span></span></span><span class=line><span class=cl><span class=s>    protocol: TCP
</span></span></span><span class=line><span class=cl><span class=s>    targetPort: http
</span></span></span><span class=line><span class=cl><span class=s>    name: http
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    app: reverse-words-green
</span></span></span><span class=line><span class=cl><span class=s>  type: ClusterIP
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div></li><li><p>Patch the old <code>HTTPRoute</code> and add the new backend + weights:</p><div class="admonition tip"><p class=admonition-title>Note</p><p class=admonition>Below route will send most of the request to the old service (<code>Blue</code>) and a few ones to the new one (<code>Green</code>).</p></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: HTTPRoute
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: reversewords
</span></span></span><span class=line><span class=cl><span class=s>  namespace: reverse-words
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  parentRefs:
</span></span></span><span class=line><span class=cl><span class=s>  - name: gateway
</span></span></span><span class=line><span class=cl><span class=s>    sectionName: http
</span></span></span><span class=line><span class=cl><span class=s>  hostnames:
</span></span></span><span class=line><span class=cl><span class=s>  - reverse-words.apps.gateway-api.test.lab
</span></span></span><span class=line><span class=cl><span class=s>  rules:
</span></span></span><span class=line><span class=cl><span class=s>  - backendRefs:
</span></span></span><span class=line><span class=cl><span class=s>    - name: reverse-words-blue
</span></span></span><span class=line><span class=cl><span class=s>      port: 8080
</span></span></span><span class=line><span class=cl><span class=s>      weight: 90
</span></span></span><span class=line><span class=cl><span class=s>    - name: reverse-words-green
</span></span></span><span class=line><span class=cl><span class=s>      port: 8080
</span></span></span><span class=line><span class=cl><span class=s>      weight: 10
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div></li><li><p>If we try to access our application this is what we will get:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=k>for</span> i in <span class=k>$(</span>seq <span class=m>1</span> 10<span class=k>)</span><span class=p>;</span><span class=k>do</span> curl http://reverse-words.apps.gateway-api.test.lab<span class=p>;</span> <span class=k>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Reverse Words Release: Blue. App version: v0.0.27
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Blue. App version: v0.0.27
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Blue. App version: v0.0.27
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Blue. App version: v0.0.27
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Blue. App version: v0.0.27
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Blue. App version: v0.0.27
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Blue. App version: v0.0.27
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Green. App version: v0.0.28
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Blue. App version: v0.0.27
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Blue. App version: v0.0.27   
</span></span></span></code></pre></div></li><li><p>We can update the weights, so traffic gets distributed evenly:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl -n reverse-words patch httproute reversewords -p <span class=s1>&#39;{&#34;spec&#34;:{&#34;rules&#34;:[{&#34;backendRefs&#34;:[{&#34;group&#34;:&#34;&#34;,&#34;kind&#34;:&#34;Service&#34;,&#34;name&#34;:&#34;reverse-words-blue&#34;,&#34;port&#34;:8080,&#34;weight&#34;:50},{&#34;group&#34;:&#34;&#34;,&#34;kind&#34;:&#34;Service&#34;,&#34;name&#34;:&#34;reverse-words-green&#34;,&#34;port&#34;:8080,&#34;weight&#34;:50}],&#34;matches&#34;:[{&#34;path&#34;:{&#34;type&#34;:&#34;PathPrefix&#34;,&#34;value&#34;:&#34;/&#34;}}]}]}}&#39;</span> --type merge
</span></span></code></pre></div></li><li><p>And check the impact:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=k>for</span> i in <span class=k>$(</span>seq <span class=m>1</span> 10<span class=k>)</span><span class=p>;</span><span class=k>do</span> curl http://reverse-words.apps.gateway-api.test.lab<span class=p>;</span> <span class=k>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Reverse Words Release: Blue. App version: v0.0.27
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Green. App version: v0.0.28
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Blue. App version: v0.0.27
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Blue. App version: v0.0.27
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Blue. App version: v0.0.27
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Blue. App version: v0.0.27
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Green. App version: v0.0.28
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Blue. App version: v0.0.27
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Green. App version: v0.0.28
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Green. App version: v0.0.28
</span></span></span></code></pre></div></li><li><p>We can move weight to <code>0</code> to remove the old service (<code>Blue</code>) from the load balancing:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl -n reverse-words patch httproute reversewords -p <span class=s1>&#39;{&#34;spec&#34;:{&#34;rules&#34;:[{&#34;backendRefs&#34;:[{&#34;group&#34;:&#34;&#34;,&#34;kind&#34;:&#34;Service&#34;,&#34;name&#34;:&#34;reverse-words-blue&#34;,&#34;port&#34;:8080,&#34;weight&#34;:0},{&#34;group&#34;:&#34;&#34;,&#34;kind&#34;:&#34;Service&#34;,&#34;name&#34;:&#34;reverse-words-green&#34;,&#34;port&#34;:8080,&#34;weight&#34;:100}],&#34;matches&#34;:[{&#34;path&#34;:{&#34;type&#34;:&#34;PathPrefix&#34;,&#34;value&#34;:&#34;/&#34;}}]}]}}&#39;</span> --type merge
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=k>for</span> i in <span class=k>$(</span>seq <span class=m>1</span> 10<span class=k>)</span><span class=p>;</span><span class=k>do</span> curl http://reverse-words.apps.gateway-api.test.lab<span class=p>;</span> <span class=k>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Reverse Words Release: Green. App version: v0.0.28
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Green. App version: v0.0.28
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Green. App version: v0.0.28
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Green. App version: v0.0.28
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Green. App version: v0.0.28
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Green. App version: v0.0.28
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Green. App version: v0.0.28
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Green. App version: v0.0.28
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Green. App version: v0.0.28
</span></span></span><span class=line><span class=cl><span class=go>Reverse Words Release: Green. App version: v0.0.28
</span></span></span></code></pre></div></li></ol><h4 id=exposing-an-app-via-https>Exposing an APP via HTTPs<a hidden class=anchor aria-hidden=true href=#exposing-an-app-via-https>#</a></h4><p>For this scenario we are just configuring the Gateway to do TLS termination at the edge, after that we will expose our simple app via HTTPs and redirect HTTP requests to the HTTPs port.</p><div class="admonition attention"><p class=admonition-title>Attention</p><p class=admonition>This scenario relies on the application deployed on the previous section.</p></div><ol><li><p>We need a TLS cert, let&rsquo;s generate a self-signed one:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>openssl req -new -newkey rsa:2048 -sha256 -days <span class=m>3650</span> -nodes -x509 -extensions v3_ca -keyout /tmp/tls.key -out /tmp/tls.crt -subj <span class=s2>&#34;/C=ES/ST=Valencia/L=Valencia/O=IT/OU=IT/CN=*.apps.gateway-api.test.lab&#34;</span> -addext <span class=s2>&#34;subjectAltName = DNS:*.apps.gateway-api.test.lab&#34;</span>
</span></span></code></pre></div></li><li><p>The certificate needs to be stored in a secret:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl -n reverse-words create secret tls reversewords-gateway-tls --cert<span class=o>=</span>/tmp/tls.crt --key<span class=o>=</span>/tmp/tls.key
</span></span></code></pre></div></li><li><p>The <code>Gateway</code> needs to be updated, a new listener for the https protocol will be created on port 443. This listener will be our TLS terminator and will use the certificate we just created:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: Gateway
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: gateway
</span></span></span><span class=line><span class=cl><span class=s>  namespace: reverse-words
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    domain: k8s-gateway.nginx.org
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  gatewayClassName: nginx
</span></span></span><span class=line><span class=cl><span class=s>  listeners:
</span></span></span><span class=line><span class=cl><span class=s>  - name: http
</span></span></span><span class=line><span class=cl><span class=s>    port: 80
</span></span></span><span class=line><span class=cl><span class=s>    protocol: HTTP
</span></span></span><span class=line><span class=cl><span class=s>  - name: https
</span></span></span><span class=line><span class=cl><span class=s>    port: 443
</span></span></span><span class=line><span class=cl><span class=s>    protocol: HTTPS
</span></span></span><span class=line><span class=cl><span class=s>    tls:
</span></span></span><span class=line><span class=cl><span class=s>      mode: Terminate
</span></span></span><span class=line><span class=cl><span class=s>      certificateRefs:
</span></span></span><span class=line><span class=cl><span class=s>      - kind: Secret
</span></span></span><span class=line><span class=cl><span class=s>        name: reversewords-gateway-tls
</span></span></span><span class=line><span class=cl><span class=s>        namespace: reverse-words
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div></li><li><p>Let&rsquo;s remove the old <code>HTTPRoute</code> and create a new one exposing the app via HTTPs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl -n reverse-words delete httproute reversewords
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: HTTPRoute
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: reversewords
</span></span></span><span class=line><span class=cl><span class=s>  namespace: reverse-words
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  parentRefs:
</span></span></span><span class=line><span class=cl><span class=s>  - name: gateway
</span></span></span><span class=line><span class=cl><span class=s>    sectionName: https
</span></span></span><span class=line><span class=cl><span class=s>  hostnames:
</span></span></span><span class=line><span class=cl><span class=s>  - reverse-words.apps.gateway-api.test.lab
</span></span></span><span class=line><span class=cl><span class=s>  rules:
</span></span></span><span class=line><span class=cl><span class=s>  - backendRefs:
</span></span></span><span class=line><span class=cl><span class=s>    - name: reverse-words-green
</span></span></span><span class=line><span class=cl><span class=s>      port: 8080
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div></li><li><p>We can now access our app via https:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>curl -k https://reverse-words.apps.gateway-api.test.lab
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Reverse Words Release: Green. App version: v0.0.28
</span></span></span></code></pre></div></li><li><p>If we try to access the app via http:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>curl http://reverse-words.apps.gateway-api.test.lab
</span></span></code></pre></div><div class="admonition tip"><p class=admonition-title>Note</p><p class=admonition>Our <code>HTTPRoute</code> does not expose the app via http, this is expected.</p></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>&lt;html&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;body&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;hr&gt;&lt;center&gt;nginx/1.23.4&lt;/center&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;/body&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;/html&gt;
</span></span></span></code></pre></div></li><li><p>Usually you want to redirect users hitting the HTTP endpoint to the HTTPs endpoint, lets configure that:</p><div class="admonition tip"><p class=admonition-title>Note</p><p class=admonition>We need to create a new <code>HTTPRoute</code>, but if you take a closer look you will not see any backends being referenced, instead we are applying a <code>RequestRedirect</code> filter to tell the client to go look the HTTPs endpoint. More on filters <a href=https://gateway-api.sigs.k8s.io/v1alpha2/guides/http-redirect-rewrite/>here</a>.</p></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: HTTPRoute
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: reversewords-tls-redirect
</span></span></span><span class=line><span class=cl><span class=s>  namespace: reverse-words
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  parentRefs:
</span></span></span><span class=line><span class=cl><span class=s>  - name: gateway
</span></span></span><span class=line><span class=cl><span class=s>    sectionName: http
</span></span></span><span class=line><span class=cl><span class=s>  hostnames:
</span></span></span><span class=line><span class=cl><span class=s>  - reverse-words.apps.gateway-api.test.lab
</span></span></span><span class=line><span class=cl><span class=s>  rules:
</span></span></span><span class=line><span class=cl><span class=s>  - filters:
</span></span></span><span class=line><span class=cl><span class=s>    - type: RequestRedirect
</span></span></span><span class=line><span class=cl><span class=s>      requestRedirect:
</span></span></span><span class=line><span class=cl><span class=s>        scheme: https
</span></span></span><span class=line><span class=cl><span class=s>        port: 443
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div></li><li><p>If we access the HTTP endpoint, we&rsquo;re told to go somewhere else:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>curl http://reverse-words.apps.gateway-api.test.lab
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>&lt;html&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;head&gt;&lt;title&gt;302 Found&lt;/title&gt;&lt;/head&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;body&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;center&gt;&lt;h1&gt;302 Found&lt;/h1&gt;&lt;/center&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;hr&gt;&lt;center&gt;nginx/1.23.4&lt;/center&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;/body&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;/html&gt;
</span></span></span></code></pre></div></li><li><p>If we tell <code>curl</code> to follow redirects (<code>-L</code>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>curl -Lk http://reverse-words.apps.gateway-api.test.lab
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Reverse Words Release: Green. App version: v0.0.28
</span></span></span></code></pre></div></li></ol><h2 id=closing-thoughts>Closing Thoughts<a hidden class=anchor aria-hidden=true href=#closing-thoughts>#</a></h2><p>Gateway API is a step forward in terms of standardization, allowing better integrations with 3rd party providers as well as providing a more general API for proxying that can be used for more protocols than just HTTP.</p><p>It&rsquo;s important to keep in mind that Gateway API will not be replacing the Ingress API, instead as stated above it will be used to enable proxying of other protocols on top of HTTP like gRPC, TCP, etc.</p><h2 id=useful-resources>Useful Resources<a hidden class=anchor aria-hidden=true href=#useful-resources>#</a></h2><ul><li><a href=https://gateway-api.sigs.k8s.io/>https://gateway-api.sigs.k8s.io/</a></li><li><a href=https://gateway-api.sigs.k8s.io/v1alpha2/guides/>https://gateway-api.sigs.k8s.io/v1alpha2/guides/</a></li><li><a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>https://gateway-api.sigs.k8s.io/api-types/httproute/</a></li><li><a href=https://gateway-api.sigs.k8s.io/api-types/referencegrant/>https://gateway-api.sigs.k8s.io/api-types/referencegrant/</a></li><li><a href=https://github.com/nginxinc/nginx-kubernetes-gateway/blob/main/docs/installation.md>https://github.com/nginxinc/nginx-kubernetes-gateway/blob/main/docs/installation.md</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://linuxera.org/tags/kubernetes/>kubernetes</a></li><li><a href=https://linuxera.org/tags/gateway-api/>gateway-api</a></li><li><a href=https://linuxera.org/tags/ingress/>ingress</a></li></ul><nav class=paginav><a class=prev href=https://linuxera.org/pki-with-cfssl/><span class=title>« Prev</span><br><span>PKI with CFSSL</span></a>
<a class=next href=https://linuxera.org/cpu-memory-management-kubernetes-cgroupsv2/><span class=title>Next »</span><br><span>CPU and Memory Management on Kubernetes with Cgroupsv2</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Gateway API for Kubernetes on twitter" href="https://twitter.com/intent/tweet/?text=Gateway%20API%20for%20Kubernetes&url=https%3a%2f%2flinuxera.org%2fgateway-api-kubernetes%2f&hashtags=kubernetes%2cgateway-api%2cingress"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Gateway API for Kubernetes on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2flinuxera.org%2fgateway-api-kubernetes%2f&title=Gateway%20API%20for%20Kubernetes&summary=Gateway%20API%20for%20Kubernetes&source=https%3a%2f%2flinuxera.org%2fgateway-api-kubernetes%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></div></footer><div class=share-buttons><p>If this post has been helpful to you, consider <u><a target=_blank href=https://ko-fi.com/mvazce>supporting the work.</a></u></p></div><script src=https://utteranc.es/client.js repo=mvazquezc/mvazquezc.github.io issue-term=pathname label=blog-comments theme=preferred-color-scheme crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://linuxera.org/>Linuxera</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>