<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Integrating our Operators with OLM | Linuxera</title><meta name=keywords content="okd,origin,containers,kubernetes,operators,controllers,operator framework,operator sdk,operator lifecycle manager,olm"><meta name=description content="Introduction This post is a continuation of our previous blog Writing Operators using the Operator Framework SDK.
We will continue working on the operator created on the previous blog, if you want to be able to follow this blog, you will need to run the steps from the previous blog.
Operator Lifecycle Manager The Operator Lifecycle Manager is an open source toolkit to manage Operators in an effective, automated and scalable way."><meta name=author content="Mario"><link rel=canonical href=https://linuxera.org/integrating-operators-olm/><link crossorigin=anonymous href=/assets/css/stylesheet.8cc7ef3cdd44c5188f9267864f378d8dd8892d583e0fd07b5e5321e496f1e4d1.css integrity="sha256-jMfvPN1ExRiPkmeGTzeNjdiJLVg+D9B7XlMh5Jbx5NE=" rel="preload stylesheet" as=style><link rel=icon href=https://linuxera.org/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://linuxera.org/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://linuxera.org/favicon-32x32.png><link rel=apple-touch-icon href=https://linuxera.org/apple-touch-icon.png><link rel=mask-icon href=https://linuxera.org/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-7598JKCK1E"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-7598JKCK1E",{anonymize_ip:!1})}</script><meta property="og:title" content="Integrating our Operators with OLM"><meta property="og:description" content="Introduction This post is a continuation of our previous blog Writing Operators using the Operator Framework SDK.
We will continue working on the operator created on the previous blog, if you want to be able to follow this blog, you will need to run the steps from the previous blog.
Operator Lifecycle Manager The Operator Lifecycle Manager is an open source toolkit to manage Operators in an effective, automated and scalable way."><meta property="og:type" content="article"><meta property="og:url" content="https://linuxera.org/integrating-operators-olm/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-16T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-13T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Integrating our Operators with OLM"><meta name=twitter:description content="Introduction This post is a continuation of our previous blog Writing Operators using the Operator Framework SDK.
We will continue working on the operator created on the previous blog, if you want to be able to follow this blog, you will need to run the steps from the previous blog.
Operator Lifecycle Manager The Operator Lifecycle Manager is an open source toolkit to manage Operators in an effective, automated and scalable way."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://linuxera.org/posts/"},{"@type":"ListItem","position":2,"name":"Integrating our Operators with OLM","item":"https://linuxera.org/integrating-operators-olm/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Integrating our Operators with OLM","name":"Integrating our Operators with OLM","description":"Introduction This post is a continuation of our previous blog Writing Operators using the Operator Framework SDK.\nWe will continue working on the operator created on the previous blog, if you want to be able to follow this blog, you will need to run the steps from the previous blog.\nOperator Lifecycle Manager The Operator Lifecycle Manager is an open source toolkit to manage Operators in an effective, automated and scalable way.","keywords":["okd","origin","containers","kubernetes","operators","controllers","operator framework","operator sdk","operator lifecycle manager","olm"],"articleBody":"Introduction This post is a continuation of our previous blog Writing Operators using the Operator Framework SDK.\nWe will continue working on the operator created on the previous blog, if you want to be able to follow this blog, you will need to run the steps from the previous blog.\nOperator Lifecycle Manager The Operator Lifecycle Manager is an open source toolkit to manage Operators in an effective, automated and scalable way. You can learn more here.\nDuring this post we will integrate our Reverse Words Operator into OLM, that way we will be able to use OLM to manager our Operator lifecycle.\nIntegrating Reverse Words Operator into OLM Deploy OLM Some Kubernetes distributions, like OpenShift come with OLM pre-installed, if you’re using a distribution with doesn’t come with OLM or you don’t know if your Kubernetes cluster is running OLM already you can use the operator-sdk command to find out.\noperator-sdk olm status If your cluster is not running olm and you want to deploy it, you can run the following command:\noperator-sdk olm install Once we know OLM is present in our cluster we can continue and start the creation of our Operator Bundle.\nOperator Bundle An Operator Bundle consists of different manifests (CSVs and CRDs) and some metadata that defines the Operator at a specific version.\nYou can read more about Bundles here.\nRequirements At the moment of this writing the following versions were used:\ngolang-1.19.5 Operator Framework SDK v1.26.1 Kubernetes 1.24 opm v1.26.3 Creating the Operator Bundle We need to change to the Reverse Words Operator folder and run the make bundle command. We will be asked for some information.\ncd ~/operators-projects/reverse-words-operator/ QUAY_USERNAME= make bundle VERSION=0.0.1 CHANNELS=alpha DEFAULT_CHANNEL=alpha IMG=quay.io/$QUAY_USERNAME/reversewords-operator:v0.0.1 NOTE: Example output\nDisplay name for the operator (required): \u003e Reverse Words Operator Description for the operator (required): \u003e Deploys and Manages instances of the Reverse Words Application Provider's name for the operator (required): \u003e Linuxera Any relevant URL for the provider name (optional): \u003e linuxera.org Comma-separated list of keywords for your operator (required): \u003e reverse,reversewords,linuxera Comma-separated list of maintainers and their emails (e.g. 'name1:email1, name2:email2') (required): \u003e mario@linuxera.org Above command has generated some files:\nbundle ├── manifests │ ├── apps.linuxera.org_reversewordsapps.yaml │ ├── reverse-words-operator.clusterserviceversion.yaml │ ├── reverse-words-operator-controller-manager-metrics-service_v1_service.yaml │ ├── reverse-words-operator-manager-config_v1_configmap.yaml │ └── reverse-words-operator-metrics-reader_rbac.authorization.k8s.io_v1beta1_clusterrole.yaml ├── metadata │ └── annotations.yaml └── tests └── scorecard └── config.yaml We need to tweak the ClusterServiceVersion a bit:\nConfigure proper installModes Add WATCH_NAMESPACE env var to the operator deployment Add an Icon to our Operator You can download the modified CSV here:\ncurl -Ls https://linuxera.org/integrating-operators-olm/reverse-words-operator.clusterserviceversion_v0.0.1.yaml -o ~/operators-projects/reverse-words-operator/bundle/manifests/reverse-words-operator.clusterserviceversion.yaml sed -i \"s/QUAY_USER/$QUAY_USERNAME/g\" ~/operators-projects/reverse-words-operator/bundle/manifests/reverse-words-operator.clusterserviceversion.yaml Now that we have the Operator Bundle ready we can build it and push it to Quay. After that we will build the catalog image and once the catalog image is ready, we will use it to deploy our operator.\nNOTE: If you use podman instead of docker you can edit the Makefile and change docker commands by podman commands\nBuild and Push the bundle\nmake bundle-build bundle-push BUNDLE_IMG=quay.io/$QUAY_USERNAME/reversewords-operator-bundle:v0.0.1 Validate the bundle\noperator-sdk bundle validate quay.io/$QUAY_USERNAME/reversewords-operator-bundle:v0.0.1 -b podman Create the Catalog Image\nNote\nWith this new file-based approach, it’s highly recommended to keep control of your catalog in Git. The operator framework team created an example repo you can fork here.\n# Download opm tool sudo curl -sL https://github.com/operator-framework/operator-registry/releases/download/v1.26.3/linux-amd64-opm -o /usr/local/bin/opm \u0026\u0026 sudo chmod +x /usr/local/bin/opm # Create the catalog image mkdir reversewords-catalog opm generate dockerfile reversewords-catalog opm init reverse-words-operator --default-channel=alpha --output yaml \u003e reversewords-catalog/operator.yaml # Add bundle opm render quay.io/$QUAY_USERNAME/reversewords-operator-bundle:v0.0.1 --output yaml \u003e\u003e reversewords-catalog/operator.yaml # Initialize the alpha channel cat \u003c\u003c EOF \u003e\u003e reversewords-catalog/operator.yaml --- schema: olm.channel package: reverse-words-operator name: alpha entries: - name: reverse-words-operator.v0.0.1 EOF # Validate the catalog opm validate reversewords-catalog \u0026\u0026 echo \"OK\" Building and pushing the catalog image\npodman build . -f reversewords-catalog.Dockerfile -t quay.io/$QUAY_USERNAME/reversewords-catalog:latest podman push quay.io/$QUAY_USERNAME/reversewords-catalog:latest Deploy the Operator using OLM At this point we have our bundle and catalog images ready, we just need to create the required CatalogSource into the cluster so we get access to our Operator bundle.\nOLM_NAMESPACE=$(kubectl get pods -A | grep catalog-operator | awk '{print $1}') cat \u003c","wordCount":"1183","inLanguage":"en","datePublished":"2020-09-16T00:00:00Z","dateModified":"2023-02-13T00:00:00Z","author":{"@type":"Person","name":"Mario"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://linuxera.org/integrating-operators-olm/"},"publisher":{"@type":"Organization","name":"Linuxera","logo":{"@type":"ImageObject","url":"https://linuxera.org/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://linuxera.org/ accesskey=h title="Linuxera (Alt + H)">Linuxera</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://linuxera.org/ title="🏠 Home"><span>🏠 Home</span></a></li><li><a href=https://linuxera.org/archives/ title="🗄️ Archive"><span>🗄️ Archive</span></a></li><li><a href=https://linuxera.org/search/ title="🔎 Search"><span>🔎 Search</span></a></li><li><a href=https://linuxera.org/tags/ title="🏷️ Tags"><span>🏷️ Tags</span></a></li><li><a href=https://linuxera.org/presentations/ title="🎴 Presentations"><span>🎴 Presentations</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://linuxera.org/>Home</a>&nbsp;»&nbsp;<a href=https://linuxera.org/posts/>Posts</a></div><h1 class=post-title>Integrating our Operators with OLM</h1><div class=post-meta><span title='2020-09-16 00:00:00 +0000 UTC'>Published on September 16, 2020</span>&nbsp;·&nbsp;<span title='2023-02-13 00:00:00 +0000 UTC'>Last updated on February 13, 2023</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Mario</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#introduction aria-label=Introduction>Introduction</a></li><li><a href=#operator-lifecycle-manager aria-label="Operator Lifecycle Manager">Operator Lifecycle Manager</a></li><li><a href=#integrating-reverse-words-operator-into-olm aria-label="Integrating Reverse Words Operator into OLM">Integrating Reverse Words Operator into OLM</a><ul><li><a href=#deploy-olm aria-label="Deploy OLM">Deploy OLM</a></li><li><a href=#operator-bundle aria-label="Operator Bundle">Operator Bundle</a></li><li><a href=#requirements aria-label=Requirements>Requirements</a><ul><li><a href=#creating-the-operator-bundle aria-label="Creating the Operator Bundle">Creating the Operator Bundle</a></li></ul></li><li><a href=#deploy-the-operator-using-olm aria-label="Deploy the Operator using OLM">Deploy the Operator using OLM</a></li><li><a href=#publish-an-upgrade-for-our-operator aria-label="Publish an upgrade for our Operator">Publish an upgrade for our Operator</a></li><li><a href=#updating-to-a-new-operator-version aria-label="Updating to a new Operator version">Updating to a new Operator version</a></li></ul></li><li><a href=#sources aria-label=Sources>Sources</a></li></ul></div></details></div><div class=post-content><h1 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h1><p>This post is a continuation of our previous blog <a href=https://linuxera.org/writing-operators-using-operator-framework/>Writing Operators using the Operator Framework SDK</a>.</p><p>We will continue working on the operator created on the previous blog, if you want to be able to follow this blog, you will need to run the steps from the previous blog.</p><h1 id=operator-lifecycle-manager>Operator Lifecycle Manager<a hidden class=anchor aria-hidden=true href=#operator-lifecycle-manager>#</a></h1><p>The <a href=https://github.com/operator-framework/operator-lifecycle-manager>Operator Lifecycle Manager</a> is an open source toolkit to manage Operators in an effective, automated
and scalable way. You can learn more <a href=https://github.com/operator-framework/operator-lifecycle-manager#overview>here</a>.</p><p>During this post we will integrate our Reverse Words Operator into OLM, that way we will be able to use OLM to manager our Operator lifecycle.</p><h1 id=integrating-reverse-words-operator-into-olm>Integrating Reverse Words Operator into OLM<a hidden class=anchor aria-hidden=true href=#integrating-reverse-words-operator-into-olm>#</a></h1><h2 id=deploy-olm>Deploy OLM<a hidden class=anchor aria-hidden=true href=#deploy-olm>#</a></h2><p>Some Kubernetes distributions, like <a href=https://www.openshift.com/>OpenShift</a> come with OLM pre-installed, if you&rsquo;re using a distribution with doesn&rsquo;t come with OLM or you don&rsquo;t
know if your Kubernetes cluster is running OLM already you can use the <code>operator-sdk</code> command to find out.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>operator-sdk olm status
</span></span></code></pre></div><p>If your cluster is not running olm and you want to deploy it, you can run the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>operator-sdk olm install
</span></span></code></pre></div><p>Once we know OLM is present in our cluster we can continue and start the creation of our Operator Bundle.</p><h2 id=operator-bundle>Operator Bundle<a hidden class=anchor aria-hidden=true href=#operator-bundle>#</a></h2><p>An Operator Bundle consists of different manifests (CSVs and CRDs) and some metadata that defines the Operator at a specific version.</p><p>You can read more about Bundles <a href=https://github.com/operator-framework/operator-registry/blob/v1.12.6/docs/design/operator-bundle.md>here</a>.</p><h2 id=requirements>Requirements<a hidden class=anchor aria-hidden=true href=#requirements>#</a></h2><p>At the moment of this writing the following versions were used:</p><ul><li>golang-1.19.5</li><li>Operator Framework SDK v1.26.1</li><li>Kubernetes 1.24</li><li>opm v1.26.3</li></ul><h3 id=creating-the-operator-bundle>Creating the Operator Bundle<a hidden class=anchor aria-hidden=true href=#creating-the-operator-bundle>#</a></h3><p>We need to change to the Reverse Words Operator folder and run the <code>make bundle</code> command. We will be asked for some information.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>cd</span> ~/operators-projects/reverse-words-operator/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>QUAY_USERNAME</span><span class=o>=</span>&lt;username&gt;
</span></span><span class=line><span class=cl>make bundle <span class=nv>VERSION</span><span class=o>=</span>0.0.1 <span class=nv>CHANNELS</span><span class=o>=</span>alpha <span class=nv>DEFAULT_CHANNEL</span><span class=o>=</span>alpha <span class=nv>IMG</span><span class=o>=</span>quay.io/<span class=nv>$QUAY_USERNAME</span>/reversewords-operator:v0.0.1
</span></span></code></pre></div><blockquote><p><strong>NOTE</strong>: Example output</p></blockquote><pre tabindex=0><code>Display name for the operator (required): 
&gt; Reverse Words Operator

Description for the operator (required): 
&gt; Deploys and Manages instances of the Reverse Words Application

Provider&#39;s name for the operator (required): 
&gt; Linuxera

Any relevant URL for the provider name (optional): 
&gt; linuxera.org

Comma-separated list of keywords for your operator (required): 
&gt; reverse,reversewords,linuxera

Comma-separated list of maintainers and their emails (e.g. &#39;name1:email1, name2:email2&#39;) (required): 
&gt; mario@linuxera.org

&lt;omitted_output&gt;
</code></pre><p>Above command has generated some files:</p><pre tabindex=0><code>bundle
├── manifests
│   ├── apps.linuxera.org_reversewordsapps.yaml
│   ├── reverse-words-operator.clusterserviceversion.yaml
│   ├── reverse-words-operator-controller-manager-metrics-service_v1_service.yaml
│   ├── reverse-words-operator-manager-config_v1_configmap.yaml
│   └── reverse-words-operator-metrics-reader_rbac.authorization.k8s.io_v1beta1_clusterrole.yaml
├── metadata
│   └── annotations.yaml
└── tests
    └── scorecard
        └── config.yaml
</code></pre><p>We need to tweak the ClusterServiceVersion a bit:</p><ol><li>Configure proper <code>installModes</code></li><li>Add WATCH_NAMESPACE env var to the operator deployment</li><li>Add an Icon to our Operator</li></ol><p>You can download the modified CSV here:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>curl -Ls https://linuxera.org/integrating-operators-olm/reverse-words-operator.clusterserviceversion_v0.0.1.yaml -o ~/operators-projects/reverse-words-operator/bundle/manifests/reverse-words-operator.clusterserviceversion.yaml
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s/QUAY_USER/</span><span class=nv>$QUAY_USERNAME</span><span class=s2>/g&#34;</span> ~/operators-projects/reverse-words-operator/bundle/manifests/reverse-words-operator.clusterserviceversion.yaml
</span></span></code></pre></div><p>Now that we have the Operator Bundle ready we can build it and push it to <a href=https://quay.io>Quay</a>. After that we will build the catalog image and once the catalog image is ready, we will use it to deploy our operator.</p><blockquote><p><strong>NOTE</strong>: If you use podman instead of docker you can edit the Makefile and change docker commands by podman commands</p></blockquote><ol><li><p>Build and Push the bundle</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>make bundle-build bundle-push <span class=nv>BUNDLE_IMG</span><span class=o>=</span>quay.io/<span class=nv>$QUAY_USERNAME</span>/reversewords-operator-bundle:v0.0.1
</span></span></code></pre></div></li><li><p>Validate the bundle</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>operator-sdk bundle validate quay.io/<span class=nv>$QUAY_USERNAME</span>/reversewords-operator-bundle:v0.0.1 -b podman
</span></span></code></pre></div></li><li><p>Create the Catalog Image</p><div class="admonition tip"><p class=admonition-title>Note</p><p class=admonition>With this new file-based approach, it&rsquo;s highly recommended to keep control of your catalog in Git. The operator framework team created an example repo you can fork <a href=https://github.com/operator-framework/cool-catalog>here</a>.</p></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># Download opm tool</span>
</span></span><span class=line><span class=cl>sudo curl -sL https://github.com/operator-framework/operator-registry/releases/download/v1.26.3/linux-amd64-opm -o /usr/local/bin/opm <span class=o>&amp;&amp;</span> sudo chmod +x /usr/local/bin/opm
</span></span><span class=line><span class=cl><span class=c1># Create the catalog image</span>
</span></span><span class=line><span class=cl>mkdir reversewords-catalog
</span></span><span class=line><span class=cl>opm generate dockerfile reversewords-catalog
</span></span><span class=line><span class=cl>opm init reverse-words-operator --default-channel<span class=o>=</span>alpha --output yaml &gt; reversewords-catalog/operator.yaml
</span></span><span class=line><span class=cl><span class=c1># Add bundle</span>
</span></span><span class=line><span class=cl>opm render quay.io/<span class=nv>$QUAY_USERNAME</span>/reversewords-operator-bundle:v0.0.1 --output yaml &gt;&gt; reversewords-catalog/operator.yaml
</span></span><span class=line><span class=cl><span class=c1># Initialize the alpha channel</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt; EOF &gt;&gt; reversewords-catalog/operator.yaml
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>schema: olm.channel
</span></span></span><span class=line><span class=cl><span class=s>package: reverse-words-operator
</span></span></span><span class=line><span class=cl><span class=s>name: alpha
</span></span></span><span class=line><span class=cl><span class=s>entries:
</span></span></span><span class=line><span class=cl><span class=s>  - name: reverse-words-operator.v0.0.1
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl><span class=c1># Validate the catalog</span>
</span></span><span class=line><span class=cl>opm validate reversewords-catalog <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;OK&#34;</span>
</span></span></code></pre></div></li><li><p>Building and pushing the catalog image</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>podman build . -f reversewords-catalog.Dockerfile -t quay.io/<span class=nv>$QUAY_USERNAME</span>/reversewords-catalog:latest
</span></span><span class=line><span class=cl>podman push quay.io/<span class=nv>$QUAY_USERNAME</span>/reversewords-catalog:latest
</span></span></code></pre></div></li></ol><h2 id=deploy-the-operator-using-olm>Deploy the Operator using OLM<a hidden class=anchor aria-hidden=true href=#deploy-the-operator-using-olm>#</a></h2><p>At this point we have our bundle and catalog images ready, we just need to create the required <code>CatalogSource</code> into the cluster so we get access to our Operator bundle.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nv>OLM_NAMESPACE</span><span class=o>=</span><span class=k>$(</span>kubectl get pods -A <span class=p>|</span> grep catalog-operator <span class=p>|</span> awk <span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | kubectl create -f -
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: operators.coreos.com/v1alpha1
</span></span></span><span class=line><span class=cl><span class=s>kind: CatalogSource
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: reversewords-catalog
</span></span></span><span class=line><span class=cl><span class=s>  namespace: $OLM_NAMESPACE
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  sourceType: grpc
</span></span></span><span class=line><span class=cl><span class=s>  displayName: &#34;ReverseWords Catalog&#34;
</span></span></span><span class=line><span class=cl><span class=s>  publisher: Linuxera
</span></span></span><span class=line><span class=cl><span class=s>  image: quay.io/$QUAY_USERNAME/reversewords-catalog:latest
</span></span></span><span class=line><span class=cl><span class=s>  updateStrategy:
</span></span></span><span class=line><span class=cl><span class=s>    registryPoll:
</span></span></span><span class=line><span class=cl><span class=s>      interval: 1m0s
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>A pod will be created on the OLM namespace:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl -n <span class=nv>$OLM_NAMESPACE</span> get pod -l olm.catalogSource<span class=o>=</span>reversewords-catalog
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                         READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>reversewords-catalog-d8qbw   1/1     Running   <span class=m>0</span>          12s
</span></span></code></pre></div><p>OLM will read the CSVs from our Operator Bundle and will load the Package Manifest into the cluster:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl get packagemanifest -l <span class=nv>catalog</span><span class=o>=</span>reversewords-catalog
</span></span><span class=line><span class=cl>NAME                     CATALOG                AGE
</span></span><span class=line><span class=cl>reverse-words-operator   ReverseWords Catalog   30s
</span></span></code></pre></div><p>At this point we can create a <code>Subscription</code> to our operator:</p><ol><li><p>Create a new namespace</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nv>NAMESPACE</span><span class=o>=</span>test-operator-subscription
</span></span><span class=line><span class=cl>kubectl create ns <span class=nv>$NAMESPACE</span>
</span></span></code></pre></div></li><li><p>Create the subscription in the namespace we just created</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | kubectl -n $NAMESPACE create -f - 
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: operators.coreos.com/v1alpha1
</span></span></span><span class=line><span class=cl><span class=s>kind: Subscription
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: reversewords-subscription
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  channel: alpha
</span></span></span><span class=line><span class=cl><span class=s>  name: reverse-words-operator
</span></span></span><span class=line><span class=cl><span class=s>  installPlanApproval: Automatic
</span></span></span><span class=line><span class=cl><span class=s>  source: reversewords-catalog
</span></span></span><span class=line><span class=cl><span class=s>  sourceNamespace: $OLM_NAMESPACE
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: operators.coreos.com/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: OperatorGroup
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: reverse-words-operatorgroup
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  targetNamespaces:
</span></span></span><span class=line><span class=cl><span class=s>  - $NAMESPACE
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div></li><li><p>The operator will be deployed in the namespace</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl -n <span class=nv>$NAMESPACE</span> get pods
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                                                         READY   STATUS             RESTARTS   AGE
</span></span><span class=line><span class=cl>reverse-words-operator-controller-manager-844d897db4-hsnmw   2/2     Running   <span class=m>0</span>          12s
</span></span></code></pre></div></li></ol><h2 id=publish-an-upgrade-for-our-operator>Publish an upgrade for our Operator<a hidden class=anchor aria-hidden=true href=#publish-an-upgrade-for-our-operator>#</a></h2><p>We have seen how to create a bundle for our operator, now we are going to see how we can add new versions to the bundle and link them so we can publish updates for the operators.</p><p>In the previous steps we create the version <code>v0.0.1</code> for our Operator, we are going to create and publish a <code>v0.0.2</code> version:</p><p>First we create a new CSV version in the same channel we used for v0.0.1:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>make bundle <span class=nv>VERSION</span><span class=o>=</span>0.0.2 <span class=nv>CHANNELS</span><span class=o>=</span>alpha <span class=nv>DEFAULT_CHANNEL</span><span class=o>=</span>alpha <span class=nv>IMG</span><span class=o>=</span>quay.io/<span class=nv>$QUAY_USERNAME</span>/reversewords-operator:v0.0.2
</span></span></code></pre></div><p>We need to tweak the ClusterServiceVersion a bit:</p><ol><li>Configure proper <code>installModes</code></li><li>Add WATCH_NAMESPACE env var to the operator deployment</li><li>Add an Icon to our Operator</li></ol><p>You can download the modified CSV here:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>curl -Ls https://linuxera.org/integrating-operators-olm/reverse-words-operator.clusterserviceversion_v0.0.2.yaml -o ~/operators-projects/reverse-words-operator/bundle/manifests/reverse-words-operator.clusterserviceversion.yaml
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s/QUAY_USER/</span><span class=nv>$QUAY_USERNAME</span><span class=s2>/g&#34;</span> ~/operators-projects/reverse-words-operator/bundle/manifests/reverse-words-operator.clusterserviceversion.yaml
</span></span></code></pre></div><p>Now that we have the new Operator Bundle ready we can build it and push it to <a href=https://quay.io>Quay</a>. After that we will update and build the catalog image.</p><ol><li><p>Build and push the new bundle</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>make bundle-build bundle-push <span class=nv>BUNDLE_IMG</span><span class=o>=</span>quay.io/<span class=nv>$QUAY_USERNAME</span>/reversewords-operator-bundle:v0.0.2
</span></span></code></pre></div></li><li><p>Validate the new bundle</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>operator-sdk bundle validate quay.io/<span class=nv>$QUAY_USERNAME</span>/reversewords-operator-bundle:v0.0.2 -b podman
</span></span></code></pre></div></li><li><p>Update the Catalog Image</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># Add bundle</span>
</span></span><span class=line><span class=cl>opm render quay.io/<span class=nv>$QUAY_USERNAME</span>/reversewords-operator-bundle:v0.0.2 --output yaml &gt;&gt; reversewords-catalog/operator.yaml
</span></span><span class=line><span class=cl><span class=c1># Update the alpha channel: Edit file reversewords-catalog/operator.yaml and change</span>
</span></span><span class=line><span class=cl>entries:
</span></span><span class=line><span class=cl>  - name: reverse-words-operator.v0.0.1
</span></span><span class=line><span class=cl>  - name: reverse-words-operator.v0.0.2
</span></span><span class=line><span class=cl>    replaces: reverse-words-operator.v0.0.1
</span></span><span class=line><span class=cl><span class=c1># Validate the catalog</span>
</span></span><span class=line><span class=cl>opm validate reversewords-catalog <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;OK&#34;</span>
</span></span></code></pre></div></li><li><p>Build and push the catalog image</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>podman build . -f reversewords-catalog.Dockerfile -t quay.io/<span class=nv>$QUAY_USERNAME</span>/reversewords-catalog:latest
</span></span><span class=line><span class=cl>podman push quay.io/<span class=nv>$QUAY_USERNAME</span>/reversewords-catalog:latest
</span></span></code></pre></div></li></ol><p>OLM is continuously checking for new bundles in the Catalog Images based on the <code>updateStrategy</code> we configured in our <code>CatalogSource</code>. After a few moments, the new CSV <code>v0.0.2</code> should be available.</p><h2 id=updating-to-a-new-operator-version>Updating to a new Operator version<a hidden class=anchor aria-hidden=true href=#updating-to-a-new-operator-version>#</a></h2><p>Depending on the <code>installPlanApproval</code> you selected when you created the subscription the operator will be updated automatically when a new version is published or you may need to approve the <code>installPlan</code> so the operator gets updated.</p><h1 id=sources>Sources<a hidden class=anchor aria-hidden=true href=#sources>#</a></h1><ul><li><a href=https://github.com/operator-framework/operator-sdk/blob/master/website/content/en/docs/olm-integration/generation.md>OLM Generation Docs</a></li><li><a href=https://github.com/operator-framework/operator-registry/blob/master/README.md>Operator Registry Docs</a></li><li><a href=https://sdk.operatorframework.io/docs/olm-integration/quickstart-bundle/>Operator SDK OLM Integration Bundle Quickstart</a></li><li><a href=https://sdk.operatorframework.io/docs/olm-integration/generation/>Operator SDK Generating Manifests and Metadata</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://linuxera.org/tags/okd/>okd</a></li><li><a href=https://linuxera.org/tags/origin/>origin</a></li><li><a href=https://linuxera.org/tags/containers/>containers</a></li><li><a href=https://linuxera.org/tags/kubernetes/>kubernetes</a></li><li><a href=https://linuxera.org/tags/operators/>operators</a></li><li><a href=https://linuxera.org/tags/controllers/>controllers</a></li><li><a href=https://linuxera.org/tags/operator-framework/>operator framework</a></li><li><a href=https://linuxera.org/tags/operator-sdk/>operator sdk</a></li><li><a href=https://linuxera.org/tags/operator-lifecycle-manager/>operator lifecycle manager</a></li><li><a href=https://linuxera.org/tags/olm/>olm</a></li></ul><nav class=paginav><a class=prev href=https://linuxera.org/containers-under-the-hood/><span class=title>« Prev</span><br><span>Containers under the Hood</span></a>
<a class=next href=https://linuxera.org/prometheus-metrics-on-your-applications/><span class=title>Next »</span><br><span>Enabling Prometheus Metrics on your Applications</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Integrating our Operators with OLM on twitter" href="https://twitter.com/intent/tweet/?text=Integrating%20our%20Operators%20with%20OLM&url=https%3a%2f%2flinuxera.org%2fintegrating-operators-olm%2f&hashtags=okd%2corigin%2ccontainers%2ckubernetes%2coperators%2ccontrollers%2coperatorframework%2coperatorsdk%2coperatorlifecyclemanager%2colm"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Integrating our Operators with OLM on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2flinuxera.org%2fintegrating-operators-olm%2f&title=Integrating%20our%20Operators%20with%20OLM&summary=Integrating%20our%20Operators%20with%20OLM&source=https%3a%2f%2flinuxera.org%2fintegrating-operators-olm%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></div></footer><div class=share-buttons><p>If this post has been helpful to you, consider <u><a target=_blank href=https://ko-fi.com/mvazce>supporting the work.</a></u></p></div><script src=https://utteranc.es/client.js repo=mvazquezc/mvazquezc.github.io issue-term=pathname label=blog-comments theme=preferred-color-scheme crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://linuxera.org/>Linuxera</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>