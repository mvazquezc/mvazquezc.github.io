<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Integrating cert-manager with CFSSL Multirootca | Linuxera</title><meta name=keywords content="pki,private ca,TLS,cfssl,multirootca,cert-manager"><meta name=description content="Integrating cert-manager with CFSSL Multirootca In a previous post we saw how we could run our own PKI using the CFSSL tooling. This post assumes you have read the previous one.
The starting point is an empty Kubernetes cluster, we want to deploy cert-manager on it and on top of that we want to get it configured to issue certificates with our own PKI infrastructure running Multirootca.
I’ll be using a Kubernetes v1."><meta name=author content="Mario"><link rel=canonical href=https://linuxera.org/integrating-cert-manager-with-cfssl-multirootca/><link crossorigin=anonymous href=/assets/css/stylesheet.8cc7ef3cdd44c5188f9267864f378d8dd8892d583e0fd07b5e5321e496f1e4d1.css integrity="sha256-jMfvPN1ExRiPkmeGTzeNjdiJLVg+D9B7XlMh5Jbx5NE=" rel="preload stylesheet" as=style><link rel=icon href=https://linuxera.org/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://linuxera.org/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://linuxera.org/favicon-32x32.png><link rel=apple-touch-icon href=https://linuxera.org/apple-touch-icon.png><link rel=mask-icon href=https://linuxera.org/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-7598JKCK1E"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-7598JKCK1E",{anonymize_ip:!1})}</script><meta property="og:title" content="Integrating cert-manager with CFSSL Multirootca"><meta property="og:description" content="Integrating cert-manager with CFSSL Multirootca In a previous post we saw how we could run our own PKI using the CFSSL tooling. This post assumes you have read the previous one.
The starting point is an empty Kubernetes cluster, we want to deploy cert-manager on it and on top of that we want to get it configured to issue certificates with our own PKI infrastructure running Multirootca.
I’ll be using a Kubernetes v1."><meta property="og:type" content="article"><meta property="og:url" content="https://linuxera.org/integrating-cert-manager-with-cfssl-multirootca/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-10T00:00:00+00:00"><meta property="article:modified_time" content="2023-08-10T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Integrating cert-manager with CFSSL Multirootca"><meta name=twitter:description content="Integrating cert-manager with CFSSL Multirootca In a previous post we saw how we could run our own PKI using the CFSSL tooling. This post assumes you have read the previous one.
The starting point is an empty Kubernetes cluster, we want to deploy cert-manager on it and on top of that we want to get it configured to issue certificates with our own PKI infrastructure running Multirootca.
I’ll be using a Kubernetes v1."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://linuxera.org/posts/"},{"@type":"ListItem","position":2,"name":"Integrating cert-manager with CFSSL Multirootca","item":"https://linuxera.org/integrating-cert-manager-with-cfssl-multirootca/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Integrating cert-manager with CFSSL Multirootca","name":"Integrating cert-manager with CFSSL Multirootca","description":"Integrating cert-manager with CFSSL Multirootca In a previous post we saw how we could run our own PKI using the CFSSL tooling. This post assumes you have read the previous one.\nThe starting point is an empty Kubernetes cluster, we want to deploy cert-manager on it and on top of that we want to get it configured to issue certificates with our own PKI infrastructure running Multirootca.\nI’ll be using a Kubernetes v1.","keywords":["pki","private ca","TLS","cfssl","multirootca","cert-manager"],"articleBody":"Integrating cert-manager with CFSSL Multirootca In a previous post we saw how we could run our own PKI using the CFSSL tooling. This post assumes you have read the previous one.\nThe starting point is an empty Kubernetes cluster, we want to deploy cert-manager on it and on top of that we want to get it configured to issue certificates with our own PKI infrastructure running Multirootca.\nI’ll be using a Kubernetes v1.27 (latest at the time of this writing). The tool used to create the cluster is kcli and the command used was:\nkcli create kube generic -P ctlplanes=1 -P workers=1 -P ctlplane_memory=4096 -P numcpus=8 -P worker_memory=8192 -P image=fedora37 -P sdn=calico -P version=1.27 -P domain=linuxera.org cert-manager-cluster Introduction to cert-manager I recommend reading the official introduction from the cert-manager project page.\nWe are going to configure cert-manager to talk to our multirootca server in order to request certificates. The external provider we will be using is the one created by Wikimedia here.\nYou can read more about external providers here.\nDeploying cert-manager We will be using helm to deploy cert-manager, the official steps are documented here.\nAdd the helm repository:\nhelm repo add jetstack https://charts.jetstack.io helm repo update jetstack Deploy cert-manager:\nhelm install \\ cert-manager jetstack/cert-manager \\ --namespace cert-manager \\ --create-namespace \\ --version v1.12.3 \\ --set installCRDs=true If the deployment went well, we should have cert-manager running in our cluster:\nkubectl -n cert-manager get pods NAME READY STATUS RESTARTS AGE cert-manager-875c7579b-qx62m 1/1 Running 0 2m16s cert-manager-cainjector-7bb6786867-q4t4x 1/1 Running 0 2m16s cert-manager-webhook-89dc55877-flj7g 1/1 Running 0 2m16s Integrating cert-manager with multirootca As we mentioned earlier, we will be using the Wikimedia CFSSL issuer external provider.\nLet’s start by deploying the external provider into our cluster.\nAdd the helm repository:\nhelm repo add wikimedia-charts https://helm-charts.wikimedia.org/stable helm repo update wikimedia-charts Deploy the required CRDs:\nhelm install \\ cfssl-issuer-crds wikimedia-charts/cfssl-issuer-crds Deploy the external provider controller:\nhelm install \\ cfssl-issuer wikimedia-charts/cfssl-issuer \\ --namespace cert-manager A new pod should be running in the cert-manager namespace:\nkubectl -n cert-manager get pods -l app.kubernetes.io/name=cfssl-issuer NAME READY STATUS RESTARTS AGE cfssl-issuer-64f564f78f-gq4n9 1/1 Running 0 29s Configuring the CFSSL ClusterIssuer Now that we have the external provider running, we will go ahead and configure a ClusterIssuer that will be available to all namespaces to request certificates. You can read more on Issuers here.\nCreate a secret with the auth key required by the multirootca to sign the certificate requests.\nkubectl -n cert-manager create secret generic \\ cfssl-linuxera-internal-ca-key --from-literal=key=b50ed348c4643d34706470f36a646fd4 Since the certificate that exposes our multirootca server has been signed with an unknown CA to our Kubernetes cluster, request by cert-manager will fail due to untrusted CA. We have two options to get this sorted out: First option would be adding our intermediate ca to the Kubernetes cluster trusted CA bundle, the second option (and the one I’ll be using) is mounting the intermediate CA inside the external provider controller pod.\nNote\nThe intermediate-ca.pem is a file that contains the CA certificate for our intermediate CA that will sign the certificates.\nCreate a ConfigMap with the internal CA certificate.\nkubectl -n cert-manager create configmap \\ internal-ca-chain --from-file=ca-bundle.crt=/path/to/intermediate-ca.pem Patch the cfssl-issuer deployment to mount this ConfigMap\nkubectl -n cert-manager patch deployment \\ cfssl-issuer -p '{\"spec\":{\"template\":{\"spec\":{\"$setElementOrder/containers\":[{\"name\":\"cfssl-issuer\"}],\"containers\":[{\"name\":\"cfssl-issuer\",\"volumeMounts\":[{\"mountPath\":\"/etc/pki/tls/certs/\",\"name\":\"internal-ca-chain\"}]}],\"volumes\":[{\"configMap\":{\"name\":\"internal-ca-chain\"},\"name\":\"internal-ca-chain\"}]}}}}' Next, create the issuer. Here we define how to reach the multirootca server.\ncat \u003c","wordCount":"770","inLanguage":"en","datePublished":"2023-08-10T00:00:00Z","dateModified":"2023-08-10T00:00:00Z","author":{"@type":"Person","name":"Mario"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://linuxera.org/integrating-cert-manager-with-cfssl-multirootca/"},"publisher":{"@type":"Organization","name":"Linuxera","logo":{"@type":"ImageObject","url":"https://linuxera.org/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://linuxera.org/ accesskey=h title="Linuxera (Alt + H)">Linuxera</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://linuxera.org/ title="🏠 Home"><span>🏠 Home</span></a></li><li><a href=https://linuxera.org/archives/ title="🗄️ Archive"><span>🗄️ Archive</span></a></li><li><a href=https://linuxera.org/search/ title="🔎 Search"><span>🔎 Search</span></a></li><li><a href=https://linuxera.org/tags/ title="🏷️ Tags"><span>🏷️ Tags</span></a></li><li><a href=https://linuxera.org/presentations/ title="🎴 Presentations"><span>🎴 Presentations</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://linuxera.org/>Home</a>&nbsp;»&nbsp;<a href=https://linuxera.org/posts/>Posts</a></div><h1 class=post-title>Integrating cert-manager with CFSSL Multirootca</h1><div class=post-meta><span title='2023-08-10 00:00:00 +0000 UTC'>Published on August 10, 2023</span>&nbsp;·&nbsp;<span title='2023-08-10 00:00:00 +0000 UTC'>Last updated on August 10, 2023</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;Mario</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#integrating-cert-manager-with-cfssl-multirootca aria-label="Integrating cert-manager with CFSSL Multirootca">Integrating cert-manager with CFSSL Multirootca</a><ul><li><a href=#introduction-to-cert-manager aria-label="Introduction to cert-manager">Introduction to cert-manager</a></li><li><a href=#deploying-cert-manager aria-label="Deploying cert-manager">Deploying cert-manager</a></li><li><a href=#integrating-cert-manager-with-multirootca aria-label="Integrating cert-manager with multirootca">Integrating cert-manager with multirootca</a></li><li><a href=#configuring-the-cfssl-clusterissuer aria-label="Configuring the CFSSL ClusterIssuer">Configuring the CFSSL <code>ClusterIssuer</code></a></li><li><a href=#requesting-certificates-via-cert-manager aria-label="Requesting Certificates via cert-manager">Requesting Certificates via <code>cert-manager</code></a></li><li><a href=#useful-resources aria-label="Useful Resources">Useful Resources</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=integrating-cert-manager-with-cfssl-multirootca>Integrating cert-manager with CFSSL Multirootca<a hidden class=anchor aria-hidden=true href=#integrating-cert-manager-with-cfssl-multirootca>#</a></h1><p>In a <a href=https://linuxera.org/pki-with-cfssl/>previous post</a> we saw how we could run our own PKI using the <a href=https://github.com/cloudflare/cfssl>CFSSL</a> tooling. This post assumes you have read the previous one.</p><p>The starting point is an empty Kubernetes cluster, we want to deploy cert-manager on it and on top of that we want to get it configured to issue certificates with our own PKI infrastructure running Multirootca.</p><p>I’ll be using a Kubernetes v1.27 (latest at the time of this writing). The tool used to create the cluster is <a href=https://kcli.readthedocs.io/>kcli</a> and the command used was:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kcli create kube generic -P <span class=nv>ctlplanes</span><span class=o>=</span><span class=m>1</span> -P <span class=nv>workers</span><span class=o>=</span><span class=m>1</span> -P <span class=nv>ctlplane_memory</span><span class=o>=</span><span class=m>4096</span> -P <span class=nv>numcpus</span><span class=o>=</span><span class=m>8</span> -P <span class=nv>worker_memory</span><span class=o>=</span><span class=m>8192</span> -P <span class=nv>image</span><span class=o>=</span>fedora37 -P <span class=nv>sdn</span><span class=o>=</span>calico -P <span class=nv>version</span><span class=o>=</span>1.27 -P <span class=nv>domain</span><span class=o>=</span>linuxera.org cert-manager-cluster
</span></span></code></pre></div><h2 id=introduction-to-cert-manager>Introduction to cert-manager<a hidden class=anchor aria-hidden=true href=#introduction-to-cert-manager>#</a></h2><p>I recommend reading the <a href=https://cert-manager.io/docs/>official introduction</a> from the <code>cert-manager</code> project page.</p><p>We are going to configure <code>cert-manager</code> to talk to our <code>multirootca</code> server in order to request certificates. The external provider we will be using is the one created by Wikimedia <a href=https://gerrit.wikimedia.org/r/plugins/gitiles/operations/software/cfssl-issuer/>here</a>.</p><p>You can read more about external providers <a href=https://cert-manager.io/docs/configuration/external/>here</a>.</p><h2 id=deploying-cert-manager>Deploying cert-manager<a hidden class=anchor aria-hidden=true href=#deploying-cert-manager>#</a></h2><p>We will be using <code>helm</code> to deploy <code>cert-manager</code>, the official steps are documented <a href=https://cert-manager.io/docs/installation/helm/>here</a>.</p><ol><li><p>Add the helm repository:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>helm repo add jetstack https://charts.jetstack.io
</span></span><span class=line><span class=cl>helm repo update jetstack
</span></span></code></pre></div></li><li><p>Deploy <code>cert-manager</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>helm install <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  cert-manager jetstack/cert-manager <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --namespace cert-manager <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --create-namespace <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --version v1.12.3 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set <span class=nv>installCRDs</span><span class=o>=</span><span class=nb>true</span>
</span></span></code></pre></div></li><li><p>If the deployment went well, we should have <code>cert-manager</code> running in our cluster:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl -n cert-manager get pods
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>NAME                                       READY   STATUS    RESTARTS   AGE
</span></span></span><span class=line><span class=cl><span class=go>cert-manager-875c7579b-qx62m               1/1     Running   0          2m16s
</span></span></span><span class=line><span class=cl><span class=go>cert-manager-cainjector-7bb6786867-q4t4x   1/1     Running   0          2m16s
</span></span></span><span class=line><span class=cl><span class=go>cert-manager-webhook-89dc55877-flj7g       1/1     Running   0          2m16s
</span></span></span></code></pre></div></li></ol><h2 id=integrating-cert-manager-with-multirootca>Integrating cert-manager with multirootca<a hidden class=anchor aria-hidden=true href=#integrating-cert-manager-with-multirootca>#</a></h2><p>As we mentioned earlier, we will be using the <a href=https://gerrit.wikimedia.org/r/plugins/gitiles/operations/software/cfssl-issuer/>Wikimedia CFSSL issuer external provider</a>.</p><p>Let&rsquo;s start by deploying the external provider into our cluster.</p><ol><li><p>Add the helm repository:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>helm repo add wikimedia-charts https://helm-charts.wikimedia.org/stable
</span></span><span class=line><span class=cl>helm repo update wikimedia-charts
</span></span></code></pre></div></li><li><p>Deploy the required CRDs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>helm install <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  cfssl-issuer-crds wikimedia-charts/cfssl-issuer-crds
</span></span></code></pre></div></li><li><p>Deploy the external provider controller:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>helm install <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  cfssl-issuer wikimedia-charts/cfssl-issuer <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --namespace cert-manager
</span></span></code></pre></div></li><li><p>A new pod should be running in the <code>cert-manager</code> namespace:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl -n cert-manager get pods -l app.kubernetes.io/name<span class=o>=</span>cfssl-issuer
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>NAME                            READY   STATUS    RESTARTS   AGE
</span></span></span><span class=line><span class=cl><span class=go>cfssl-issuer-64f564f78f-gq4n9   1/1     Running   0          29s
</span></span></span></code></pre></div></li></ol><h2 id=configuring-the-cfssl-clusterissuer>Configuring the CFSSL <code>ClusterIssuer</code><a hidden class=anchor aria-hidden=true href=#configuring-the-cfssl-clusterissuer>#</a></h2><p>Now that we have the external provider running, we will go ahead and configure a <code>ClusterIssuer</code> that will be available to all namespaces to request certificates. You can read more on <code>Issuers</code> <a href=https://cert-manager.io/docs/concepts/issuer/>here</a>.</p><ol><li><p>Create a secret with the <code>auth key</code> required by the <code>multirootca</code> to sign the certificate requests.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl -n cert-manager create secret generic <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  cfssl-linuxera-internal-ca-key --from-literal<span class=o>=</span><span class=nv>key</span><span class=o>=</span>b50ed348c4643d34706470f36a646fd4
</span></span></code></pre></div></li><li><p>Since the certificate that exposes our multirootca server has been signed with an unknown CA to our Kubernetes cluster, request by cert-manager will fail due to untrusted CA. We have two options to get this sorted out: First option would be adding our intermediate ca to the Kubernetes cluster trusted CA bundle, the second option (and the one I&rsquo;ll be using) is mounting the intermediate CA inside the external provider controller pod.</p><div class="admonition tip"><p class=admonition-title>Note</p><p class=admonition>The <code>intermediate-ca.pem</code> is a file that contains the CA certificate for our intermediate CA that will sign the certificates.</p></div><ol><li><p>Create a ConfigMap with the internal CA certificate.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl -n cert-manager create configmap <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  internal-ca-chain --from-file<span class=o>=</span>ca-bundle.crt<span class=o>=</span>/path/to/intermediate-ca.pem
</span></span></code></pre></div></li><li><p>Patch the <code>cfssl-issuer</code> deployment to mount this ConfigMap</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl -n cert-manager patch deployment <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  cfssl-issuer -p <span class=s1>&#39;{&#34;spec&#34;:{&#34;template&#34;:{&#34;spec&#34;:{&#34;$setElementOrder/containers&#34;:[{&#34;name&#34;:&#34;cfssl-issuer&#34;}],&#34;containers&#34;:[{&#34;name&#34;:&#34;cfssl-issuer&#34;,&#34;volumeMounts&#34;:[{&#34;mountPath&#34;:&#34;/etc/pki/tls/certs/&#34;,&#34;name&#34;:&#34;internal-ca-chain&#34;}]}],&#34;volumes&#34;:[{&#34;configMap&#34;:{&#34;name&#34;:&#34;internal-ca-chain&#34;},&#34;name&#34;:&#34;internal-ca-chain&#34;}]}}}}&#39;</span>
</span></span></code></pre></div></li></ol></li><li><p>Next, create the issuer. Here we define how to reach the <code>multirootca</code> server.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: cfssl-issuer.wikimedia.org/v1alpha1
</span></span></span><span class=line><span class=cl><span class=s>kind: ClusterIssuer
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: cfssl-internal-linuxera-ca
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  authSecretName: &#34;cfssl-linuxera-internal-ca-key&#34;
</span></span></span><span class=line><span class=cl><span class=s>  bundle: false
</span></span></span><span class=line><span class=cl><span class=s>  label: &#34;linuxeraintermediate&#34;
</span></span></span><span class=line><span class=cl><span class=s>  profile: &#34;host&#34;
</span></span></span><span class=line><span class=cl><span class=s>  url: &#34;https://multirootca-server.linuxera.org:8000&#34;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div></li><li><p>We can check the Issuer status:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl get clusterissuer.cfssl-issuer cfssl-internal-linuxera-ca -o yaml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>status:
</span></span></span><span class=line><span class=cl><span class=go>  conditions:
</span></span></span><span class=line><span class=cl><span class=go>  - lastTransitionTime: &#34;2023-08-10T13:39:31Z&#34;
</span></span></span><span class=line><span class=cl><span class=go>    message: Success
</span></span></span><span class=line><span class=cl><span class=go>    reason: cfssl-issuer.IssuerController.Reconcile
</span></span></span><span class=line><span class=cl><span class=go>    status: &#34;True&#34;
</span></span></span><span class=line><span class=cl><span class=go>    type: Ready
</span></span></span></code></pre></div></li></ol><h2 id=requesting-certificates-via-cert-manager>Requesting Certificates via <code>cert-manager</code><a hidden class=anchor aria-hidden=true href=#requesting-certificates-via-cert-manager>#</a></h2><p>At this point the <code>ClusterIssuer</code> is ready and we can request certificates to be signed by our <code>multirootca</code> instance from Kubernetes via cert-manager. Let&rsquo;s see how.</p><ol><li><p>Create a <code>Certificate</code> request.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | kubectl -n default apply -f -
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: cert-manager.io/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Certificate
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: test-host-cert-linuxera
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  secretName: test-host-cert-linuxera
</span></span></span><span class=line><span class=cl><span class=s>  duration: 2160h # 90d
</span></span></span><span class=line><span class=cl><span class=s>  renewBefore: 360h # 15d
</span></span></span><span class=line><span class=cl><span class=s>  subject:
</span></span></span><span class=line><span class=cl><span class=s>    organizations:
</span></span></span><span class=line><span class=cl><span class=s>      - Linuxera Internal
</span></span></span><span class=line><span class=cl><span class=s>  commonName: testhost-certmanager.linuxera.org
</span></span></span><span class=line><span class=cl><span class=s>  isCA: false
</span></span></span><span class=line><span class=cl><span class=s>  privateKey:
</span></span></span><span class=line><span class=cl><span class=s>    algorithm: RSA
</span></span></span><span class=line><span class=cl><span class=s>    encoding: PKCS1
</span></span></span><span class=line><span class=cl><span class=s>    size: 2048
</span></span></span><span class=line><span class=cl><span class=s>  usages:
</span></span></span><span class=line><span class=cl><span class=s>    - server auth
</span></span></span><span class=line><span class=cl><span class=s>  dnsNames:
</span></span></span><span class=line><span class=cl><span class=s>    - testhost-certmanager.linuxera.org
</span></span></span><span class=line><span class=cl><span class=s>  uris:
</span></span></span><span class=line><span class=cl><span class=s>    - spiffe://cluster.local/ns/default/sa/default
</span></span></span><span class=line><span class=cl><span class=s>  ipAddresses:
</span></span></span><span class=line><span class=cl><span class=s>    - 192.168.122.50
</span></span></span><span class=line><span class=cl><span class=s>  issuerRef:
</span></span></span><span class=line><span class=cl><span class=s>    name: cfssl-internal-linuxera-ca
</span></span></span><span class=line><span class=cl><span class=s>    kind: ClusterIssuer
</span></span></span><span class=line><span class=cl><span class=s>    group: cfssl-issuer.wikimedia.org
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div></li><li><p>We will get our cert issued and stored in a secret.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl -n default get secret test-host-cert-linuxera -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.data.tls\.crt}&#39;</span> <span class=p>|</span> base64 -d <span class=p>|</span> openssl x509 -noout -subject -issuer -startdate -enddate
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>subject=O = Linuxera Internal, CN = testhost-certmanager.linuxera.org
</span></span></span><span class=line><span class=cl><span class=go>issuer=C = ES, ST = Valencia, L = Valencia, O = Linuxera Internal, OU = Linuxera Internal Intermediate CA, CN = Linuxera Intermediate CA
</span></span></span><span class=line><span class=cl><span class=go>notBefore=Aug 10 13:41:00 2023 GMT
</span></span></span><span class=line><span class=cl><span class=go>notAfter=Aug  9 13:41:00 2024 GMT
</span></span></span></code></pre></div></li></ol><h2 id=useful-resources>Useful Resources<a hidden class=anchor aria-hidden=true href=#useful-resources>#</a></h2><ul><li><a href=https://cert-manager.io/docs/configuration/>https://cert-manager.io/docs/configuration/</a></li><li><a href=https://cert-manager.io/docs/usage/certificate/>https://cert-manager.io/docs/usage/certificate/</a></li><li><a href=https://gerrit.wikimedia.org/r/plugins/gitiles/operations/software/cfssl-issuer/>https://gerrit.wikimedia.org/r/plugins/gitiles/operations/software/cfssl-issuer/</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://linuxera.org/tags/pki/>pki</a></li><li><a href=https://linuxera.org/tags/private-ca/>private ca</a></li><li><a href=https://linuxera.org/tags/tls/>TLS</a></li><li><a href=https://linuxera.org/tags/cfssl/>cfssl</a></li><li><a href=https://linuxera.org/tags/multirootca/>multirootca</a></li><li><a href=https://linuxera.org/tags/cert-manager/>cert-manager</a></li></ul><nav class=paginav><a class=prev href=https://linuxera.org/running-vault-on-podman/><span class=title>« Prev</span><br><span>Running Vault on Podman</span></a>
<a class=next href=https://linuxera.org/pki-with-cfssl/><span class=title>Next »</span><br><span>PKI with CFSSL</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Integrating cert-manager with CFSSL Multirootca on twitter" href="https://twitter.com/intent/tweet/?text=Integrating%20cert-manager%20with%20CFSSL%20Multirootca&url=https%3a%2f%2flinuxera.org%2fintegrating-cert-manager-with-cfssl-multirootca%2f&hashtags=pki%2cprivateca%2cTLS%2ccfssl%2cmultirootca%2ccert-manager"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Integrating cert-manager with CFSSL Multirootca on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2flinuxera.org%2fintegrating-cert-manager-with-cfssl-multirootca%2f&title=Integrating%20cert-manager%20with%20CFSSL%20Multirootca&summary=Integrating%20cert-manager%20with%20CFSSL%20Multirootca&source=https%3a%2f%2flinuxera.org%2fintegrating-cert-manager-with-cfssl-multirootca%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></div></footer><div class=share-buttons><p>If this post has been helpful to you, consider <u><a target=_blank href=https://ko-fi.com/mvazce>supporting the work.</a></u></p></div><script src=https://utteranc.es/client.js repo=mvazquezc/mvazquezc.github.io issue-term=pathname label=blog-comments theme=preferred-color-scheme crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://linuxera.org/>Linuxera</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>